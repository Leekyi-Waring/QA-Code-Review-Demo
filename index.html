<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft KQL Query Grader - Professional Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --ms-blue: #0078d4;
            --ms-blue-light: #106ebe;
            --ms-blue-dark: #004578;
            --ms-accent: #40e0d0;
            --ms-success: #107c10;
            --ms-warning: #ff8c00;
            --ms-error: #d13438;
            --ms-critical: #a4262c;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f3f2f1;
            --text-primary: #323130;
            --text-secondary: #605e5c;
            --border-light: #edebe9;
            --border-medium: #d2d0ce;
            --card-shadow: 0 1px 2px rgba(0,0,0,0.1);
            --card-shadow-hover: 0 2px 8px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--ms-blue) 0%, var(--ms-blue-light) 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 32px;
        }

        .main-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 32px;
            box-shadow: var(--card-shadow);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .query-editor {
            width: 100%;
            height: 400px;
            background: #f8f8f8;
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            color: var(--text-primary);
            resize: vertical;
            outline: none;
            transition: border-color 0.2s ease;
            line-height: 1.5;
        }

        .query-editor:focus {
            border-color: var(--ms-blue);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .controls {
            margin: 24px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .control-select {
            padding: 8px 12px;
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .control-select:focus {
            border-color: var(--ms-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .grade-button {
            width: 100%;
            padding: 12px 24px;
            background: var(--ms-blue);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 16px;
        }

        .grade-button:hover {
            background: var(--ms-blue-light);
        }

        .grade-button:active {
            background: var(--ms-blue-dark);
        }

        .results-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: sticky;
            top: 24px;
        }

        .results-panel::-webkit-scrollbar {
            width: 8px;
        }

        .results-panel::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .results-panel::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 4px;
        }

        .score-display {
            text-align: center;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid var(--border-light);
        }

        .score-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .score-grade {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 8px;
        }

        .grade-a { background: var(--ms-success); color: white; }
        .grade-b { background: #2aa0f0; color: white; }
        .grade-c { background: var(--ms-warning); color: white; }
        .grade-d { background: var(--ms-error); color: white; }
        .grade-f { background: var(--ms-critical); color: white; }

        .analysis-section {
            margin-bottom: 24px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            overflow: hidden;
        }

        .analysis-header {
            background: var(--bg-secondary);
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .analysis-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .analysis-score {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .score-excellent { background: var(--ms-success); color: white; }
        .score-good { background: var(--ms-blue); color: white; }
        .score-fair { background: var(--ms-warning); color: white; }
        .score-poor { background: var(--ms-error); color: white; }

        .analysis-content {
            padding: 16px;
        }

        .issue-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .issue-item {
            padding: 16px;
            border-radius: 6px;
            border-left: 4px solid;
            background: var(--bg-secondary);
        }

        .issue-critical { border-left-color: var(--ms-critical); }
        .issue-major { border-left-color: var(--ms-error); }
        .issue-minor { border-left-color: var(--ms-warning); }
        .issue-suggestion { border-left-color: var(--ms-blue); }
        .issue-good { border-left-color: var(--ms-success); }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .issue-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .issue-severity {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-critical { background: var(--ms-critical); color: white; }
        .severity-major { background: var(--ms-error); color: white; }
        .severity-minor { background: var(--ms-warning); color: white; }
        .severity-suggestion { background: var(--ms-blue); color: white; }
        .severity-good { background: var(--ms-success); color: white; }

        .issue-description {
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .issue-fix {
            background: rgba(0, 120, 212, 0.1);
            border: 1px solid rgba(0, 120, 212, 0.2);
            border-radius: 4px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .code-example {
            background: #f8f8f8;
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--text-primary);
            overflow-x: auto;
        }

        .ai-chat {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 350px;
            height: 400px;
            background: var(--bg-primary);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            box-shadow: var(--card-shadow-hover);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .ai-chat-header {
            background: var(--ms-blue);
            color: white;
            padding: 12px 16px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .ai-chat-input {
            display: flex;
            padding: 12px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }

        .ai-chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            margin-right: 8px;
            font-size: 0.9rem;
            outline: none;
        }

        .ai-chat-input input:focus {
            border-color: var(--ms-blue);
        }

        .ai-chat-button {
            padding: 8px 16px;
            background: var(--ms-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .ai-chat-button:hover {
            background: var(--ms-blue-light);
        }

        .chat-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: var(--ms-blue);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: var(--card-shadow-hover);
            transition: background-color 0.2s ease;
        }

        .chat-toggle:hover {
            background: var(--ms-blue-light);
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            line-height: 1.4;
        }

        .chat-user {
            background: var(--ms-blue);
            color: white;
            margin-left: 20px;
        }

        .chat-ai {
            background: var(--bg-secondary);
            color: var(--text-primary);
            margin-right: 20px;
        }

        .welcome-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }

        .welcome-state h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .metric-card {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border-light);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ms-blue);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .results-panel {
                position: static;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .ai-chat {
                width: 300px;
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Microsoft KQL Query Grader</h1>
        <p>Professional-grade KQL analysis meeting Microsoft engineering standards</p>
    </div>

    <div class="container">
        <div class="main-section">
            <div class="section-title">
                üìù KQL Query Analysis
            </div>
            
            <textarea 
                id="queryEditor" 
                class="query-editor" 
                placeholder="// Enter your KQL query for comprehensive Microsoft-standard analysis
// Example:
SecurityEvent
| where TimeGenerated > ago(7d)
| where EventID == 4624
| where LogonType == 2
| summarize LoginCount = count() by Account, Computer
| where LoginCount > 10
| order by LoginCount desc"
            ></textarea>

            <div class="controls">
                <div class="control-group">
                    <label class="control-label">Analysis Depth</label>
                    <select id="analysisDepth" class="control-select">
                        <option value="standard">Standard Review</option>
                        <option value="thorough">Thorough Analysis</option>
                        <option value="comprehensive" selected>Comprehensive Audit</option>
                        <option value="microsoft">Microsoft Standards</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Target Environment</label>
                    <select id="targetEnvironment" class="control-select">
                        <option value="sentinel" selected>Azure Sentinel</option>
                        <option value="analytics">Log Analytics</option>
                        <option value="defender">Microsoft 365 Defender</option>
                        <option value="adx">Azure Data Explorer</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Query Purpose</label>
                    <select id="queryPurpose" class="control-select">
                        <option value="hunting">Threat Hunting</option>
                        <option value="detection">Detection Rule</option>
                        <option value="analytics" selected>Security Analytics</option>
                        <option value="investigation">Incident Investigation</option>
                        <option value="reporting">Executive Reporting</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label class="control-label">Performance Focus</label>
                    <select id="performanceFocus" class="control-select">
                        <option value="balanced" selected>Balanced</option>
                        <option value="speed">Maximum Speed</option>
                        <option value="accuracy">Maximum Accuracy</option>
                        <option value="cost">Cost Optimization</option>
                    </select>
                </div>
            </div>

            <button id="gradeButton" class="grade-button">
                üéØ Grade Query
            </button>
        </div>

        <div class="results-panel">
            <div class="section-title">
                üìä Analysis Results
            </div>
            
            <div id="welcomeState" class="welcome-state">
                <h3>Ready for Analysis</h3>
                <p>Enter your KQL query and click "Grade Query" to receive comprehensive feedback based on Microsoft engineering standards.</p>
                <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 6px;">
                    <strong>Analysis includes:</strong><br>
                    ‚Ä¢ Syntax & structure validation<br>
                    ‚Ä¢ Performance optimization tips<br>
                    ‚Ä¢ Security best practices<br>
                    ‚Ä¢ Microsoft standard compliance<br>
                    ‚Ä¢ Actionable improvement suggestions
                </div>
            </div>
            
            <div id="resultsContent" style="display: none;"></div>
        </div>
    </div>

    <!-- AI Chat Interface -->
    <button id="chatToggle" class="chat-toggle">üí¨</button>
    
    <div id="aiChat" class="ai-chat">
        <div class="ai-chat-header">
            ü§ñ KQL Assistant
            <button onclick="toggleChat()" style="background:none;border:none;color:white;cursor:pointer;font-size:1.2rem;">√ó</button>
        </div>
        <div class="ai-chat-body" id="chatBody">
            <div class="chat-message chat-ai">
                Hello! I'm your KQL assistant. I can help you with:
                <br><br>
                ‚Ä¢ Query optimization techniques<br>
                ‚Ä¢ Microsoft best practices<br>
                ‚Ä¢ Syntax explanations<br>
                ‚Ä¢ Performance troubleshooting<br>
                ‚Ä¢ Security considerations
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="chatInput" placeholder="Ask about KQL..." onkeypress="handleChatEnter(event)">
            <button class="ai-chat-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        class MicrosoftKQLGrader {
            constructor() {
                this.initializeEventListeners();
                this.initializeKQLRules();
            }

            initializeEventListeners() {
                document.getElementById('gradeButton').addEventListener('click', () => this.gradeQuery());
                document.getElementById('chatToggle').addEventListener('click', () => this.toggleChat());
            }

            initializeKQLRules() {
                this.microsoftStandards = {
                    syntax: [
                        {
                            pattern: /\b(WHERE|SUMMARIZE|PROJECT|EXTEND|JOIN|UNION)\b/g,
                            severity: 'minor',
                            title: 'Operator Casing',
                            description: 'KQL operators should be lowercase for consistency with Microsoft standards.',
                            fix: 'Use lowercase operators: where, summarize, project, extend, join, union',
                            impact: 'Improves code consistency and readability',
                            scoreImpact: -5
                        },
                        {
                            pattern: /;(?=\s*$)/gm,
                            severity: 'minor',
                            title: 'Unnecessary Semicolons',
                            description: 'KQL does not require semicolons at the end of statements.',
                            fix: 'Remove trailing semicolons',
                            impact: 'Cleaner, more idiomatic KQL syntax',
                            scoreImpact: -2
                        },
                        {
                            pattern: /\|\s*\|/g,
                            severity: 'critical',
                            title: 'Syntax Error: Double Pipes',
                            description: 'Consecutive pipe operators will cause query failure.',
                            fix: 'Remove duplicate pipe operators',
                            impact: 'Query will fail to execute',
                            scoreImpact: -25
                        }
                    ],

                    performance: [
                        {
                            pattern: /^(?!.*TimeGenerated.*ago\()/m,
                            test: (query) => !query.match(/TimeGenerated\s*[><=]+\s*ago\([^)]+\)/gi),
                            severity: 'critical',
                            title: 'Missing Time Filter',
                            description: 'Queries without time boundaries scan entire table history, causing severe performance issues.',
                            fix: 'Add time filter: | where TimeGenerated > ago(7d)',
                            impact: 'Can cause 100x+ performance degradation and query timeouts',
                            scoreImpact: -40,
                            line: 1
                        },
                        {
                            pattern: /\|\s*project\s+\*/gi,
                            severity: 'major',
                            title: 'Wildcard Projection',
                            description: 'Selecting all columns increases data transfer and processing overhead.',
                            fix: 'Specify exact columns: | project TimeGenerated, Computer, Account',
                            impact: 'Reduces bandwidth usage and improves query performance',
                            scoreImpact: -15
                        },
                        {
                            pattern: /\|\s*extend.*\|\s*where/gi,
                            severity: 'major',
                            title: 'Compute Before Filter',
                            description: 'Computing extended columns before filtering wastes resources on data that will be discarded.',
                            fix: 'Move where clauses before extend operations',
                            impact: '3-5x performance improvement possible',
                            scoreImpact: -12
                        },
                        {
                            pattern: /\|\s*order\s+by.*\|\s*take/gi,
                            severity: 'minor',
                            title: 'Sort Before Limit',
                            description: 'ORDER BY followed by TAKE forces full dataset sorting.',
                            fix: 'Use | top N by Column [desc] for better performance',
                            impact: '2-10x faster execution with top operator',
                            scoreImpact: -8
                        },
                        {
                            pattern: /contains\s+".*\*.*"/gi,
                            severity: 'minor',
                            title: 'Inefficient Wildcard Search',
                            description: 'Wildcard searches with contains are less efficient than specific operators.',
                            fix: 'Use has, startswith, or endswith for better performance',
                            impact: 'More efficient string matching',
                            scoreImpact: -5
                        }
                    ],

                    logic: [
                        {
                            pattern: /\|\s*where.*TimeGenerated.*and.*TimeGenerated/gi,
                            severity: 'minor',
                            title: 'Redundant Time Filtering',
                            description: 'Multiple TimeGenerated filters can be simplified.',
                            fix: 'Combine into single time range: | where TimeGenerated between(datetime(start)..datetime(end))',
                            impact: 'Cleaner logic and potentially better performance',
                            scoreImpact: -6
                        },
                        {
                            pattern: /\|\s*where.*==\s*""\s*$|=\s*''\s*$/gm,
                            severity: 'major',
                            title: 'Empty String Comparison',
                            description: 'Comparing to empty strings may not behave as expected in KQL.',
                            fix: 'Use isempty() or isnotempty() functions',
                            impact: 'More predictable null/empty handling',
                            scoreImpact: -10
                        },
                        {
                            pattern: /\|\s*summarize.*count.*\|\s*where.*count.*==\s*0/gi,
                            severity: 'major',
                            title: 'Zero Count Logic Issue',
                            description: 'Filtering for zero counts after summarization typically returns no results.',
                            fix: 'Review logic - zero counts are usually excluded by default',
                            impact: 'Query may not return expected results',
                            scoreImpact: -15
                        }
                    ],

                    bestPractices: [
                        {
                            pattern: /^(?!.*\/\/).*$/m,
                            test: (query) => !query.includes('//') && query.length > 100,
                            severity: 'suggestion',
                            title: 'Missing Documentation',
                            description: 'Complex queries benefit from comments explaining purpose and methodology.',
                            fix: 'Add comments: // Purpose: Detect suspicious login patterns',
                            impact: 'Improves maintainability and team collaboration',
                            scoreImpact: -8
                        },
                        {
                            pattern: /\|\s*take\s+(?:[1-9]\d{3,})/gi,
                            severity: 'suggestion',
                            title: 'Large Result Set',
                            description: 'Taking more than 1000 records may indicate inefficient analysis approach.',
                            fix: 'Consider summarization or pagination for large datasets',
                            impact: 'Better performance and more focused analysis',
                            scoreImpact: -5
                        },
                        {
                            pattern: /SecurityEvent.*EventID.*(?:4624|4625|4688|4672)/gi,
                            severity: 'good',
                            title: 'Security Event Focus',
                            description: 'Query targets high-value security events for analysis.',
                            fix: 'Excellent focus on authentication and privilege events',
                            impact: 'Effective security monitoring approach',
                            scoreImpact: +8
                        },
                        {
                            pattern: /let\s+\w+\s*=/gi,
                            severity: 'good',
                            title: 'Variable Usage',
                            description: 'Proper use of variables improves query maintainability.',
                            fix: 'Excellent practice for reusable and readable queries',
                            impact: 'Better code organization and reusability',
                            scoreImpact: +10
                        }
                    ],

                    security: [
                        {
                            pattern: /\|\s*project.*(?:password|secret|key|token|credential|ssn|social)/gi,
                            severity: 'critical',
                            title: 'Sensitive Data Exposure',
                            description: 'Query may expose sensitive data fields.',
                            fix: 'Remove sensitive columns or use data masking functions',
                            impact: 'Prevents potential data privacy violations',
                            scoreImpact: -30
                        },
                        {
                            pattern: /union\s+(?:\w+\s*,\s*){4,}/gi,
                            severity: 'minor',
                            title: 'Multiple Table Union',
                            description: 'Unioning many tables may mix different data classification levels.',
                            fix: 'Ensure all tables have compatible data classifications',
                            impact: 'Maintains data governance compliance',
                            scoreImpact: -8
                        }
                    ]
                };

                this.tableKnowledge = {
                    'SecurityEvent': {
                        indexed: ['TimeGenerated', 'Computer', 'EventID', 'Account'],
                        performance: 'Always filter by TimeGenerated first, then EventID',
                        common: 'EventID 4624=logon success, 4625=logon failure, 4688=process creation'
                    },
                    'SigninLogs': {
                        indexed: ['TimeGenerated', 'UserPrincipalName', 'ResultType'],
                        performance: 'Filter by TimeGenerated and ResultType for optimal performance',
                        common: 'ResultType 0=success, 50126=invalid credentials'
                    },
                    'DeviceEvents': {
                        indexed: ['TimeGenerated', 'DeviceName', 'ActionType'],
                        performance: 'Use ActionType filter early for significant performance gains',
                        common: 'ActionTypes: ProcessCreated, NetworkConnectionInitiated, FileCreated'
                    }
                };
            }

            gradeQuery() {
                const query = document.getElementById('queryEditor').value.trim();
                
                if (!query) {
                    this.showAlert('Please enter a KQL query to analyze.');
                    return;
                }

                const analysis = this.performComprehensiveAnalysis(query);
                this.displayResults(analysis);
            }

            performComprehensiveAnalysis(query) {
                let overallScore = 100;
                const issues = [];
                const categories = {
                    syntax: { score: 100, issues: [] },
                    performance: { score: 100, issues: [] },
                    logic: { score: 100, issues: [] },
                    bestPractices: { score: 100, issues: [] },
                    security: { score: 100, issues: [] }
                };

                // Apply Microsoft standard rules
                Object.entries(this.microsoftStandards).forEach(([category, rules]) => {
                    rules.forEach(rule => {
                        this.evaluateRule(rule, query, issues, categories[category], category);
                    });
                });

                // Calculate weighted score
                const weights = { syntax: 0.2, performance: 0.4, logic: 0.2, bestPractices: 0.15, security: 0.25 };
                overallScore = Object.entries(categories).reduce((score, [category, data]) => {
                    return score + (data.score * weights[category]);
                }, 0);

                // Additional analysis
                const metrics = this.calculateQueryMetrics(query);
                const recommendations = this.generateRecommendations(query, issues);
                const compliance = this.checkMicrosoftCompliance(query, issues);

                return {
                    overallScore: Math.max(Math.round(overallScore), 0),
                    grade: this.calculateGrade(overallScore),
                    categories,
                    issues: issues.sort((a, b) => this.getSeverityWeight(b.severity) - this.getSeverityWeight(a.severity)),
                    metrics,
                    recommendations,
                    compliance
                };
            }

            evaluateRule(rule, query, allIssues, categoryData, category) {
                let matches = [];
                
                if (rule.test && typeof rule.test === 'function') {
                    if (rule.test(query)) {
                        matches = [true];
                    }
                } else if (rule.pattern) {
                    matches = query.match(rule.pattern) || [];
                }

                if (matches.length > 0) {
                    const issue = {
                        category: category,
                        severity: rule.severity,
                        title: rule.title,
                        description: rule.description,
                        fix: rule.fix,
                        impact: rule.impact,
                        scoreImpact: rule.scoreImpact || 0,
                        line: rule.line || this.findQueryLine(query, matches[0])
                    };

                    allIssues.push(issue);
                    categoryData.issues.push(issue);
                    categoryData.score = Math.max(categoryData.score + (rule.scoreImpact || 0), 0);
                }
            }

            findQueryLine(query, searchStr) {
                if (!searchStr || typeof searchStr !== 'string') return 1;
                
                const lines = query.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes(searchStr.substring(0, 20))) {
                        return i + 1;
                    }
                }
                return 1;
            }

            calculateQueryMetrics(query) {
                const lines = query.split('\n').length;
                const operators = (query.match(/\|/g) || []).length;
                const tables = this.extractTableNames(query);
                const functions = this.extractFunctions(query);
                
                return {
                    linesOfCode: lines,
                    operators: operators,
                    tables: tables.length,
                    functions: functions.length,
                    complexity: this.calculateComplexity(query),
                    estimatedCost: this.estimateQueryCost(query)
                };
            }

            extractTableNames(query) {
                const tablePattern = /^(\w+)(?:\s*\||\s*$)/gm;
                const matches = [...query.matchAll(tablePattern)];
                return [...new Set(matches.map(m => m[1]).filter(t => 
                    !['let', 'print', 'range'].includes(t.toLowerCase())
                ))];
            }

            extractFunctions(query) {
                const functionPattern = /(\w+)\s*\(/g;
                const matches = [...query.matchAll(functionPattern)];
                return [...new Set(matches.map(m => m[1]))];
            }

            calculateComplexity(query) {
                let complexity = 1;
                const complexPatterns = [
                    { pattern: /join/gi, weight: 3 },
                    { pattern: /union/gi, weight: 2 },
                    { pattern: /summarize/gi, weight: 2 },
                    { pattern: /mv-expand|mv-apply/gi, weight: 3 },
                    { pattern: /let\s+\w+\s*=/gi, weight: 1 }
                ];

                complexPatterns.forEach(({ pattern, weight }) => {
                    const matches = query.match(pattern) || [];
                    complexity += matches.length * weight;
                });

                return Math.min(complexity, 20);
            }

            estimateQueryCost(query) {
                let cost = 1;
                
                if (!query.match(/TimeGenerated.*ago/gi)) cost *= 25;
                if (query.match(/\|\s*project\s+\*/gi)) cost *= 2;
                if (query.match(/join/gi)) cost *= 5;
                if (query.match(/union/gi)) cost *= 3;
                
                return Math.min(cost, 100);
            }

            generateRecommendations(query, issues) {
                const recommendations = [];
                
                const criticalIssues = issues.filter(i => i.severity === 'critical').length;
                const majorIssues = issues.filter(i => i.severity === 'major').length;
                
                if (criticalIssues > 0) {
                    recommendations.push('üö® Address critical issues immediately - query may not execute properly');
                }
                
                if (majorIssues > 0) {
                    recommendations.push('‚ö†Ô∏è Resolve major performance issues for production readiness');
                }
                
                if (!query.match(/TimeGenerated.*ago/gi)) {
                    recommendations.push('‚è∞ Add time filtering as the first priority - this is essential for any production query');
                }
                
                if (!query.includes('//') && query.length > 100) {
                    recommendations.push('üìù Add documentation comments for maintainability');
                }

                if (recommendations.length === 0) {
                    recommendations.push('‚úÖ Query follows Microsoft best practices well');
                }

                return recommendations;
            }

            checkMicrosoftCompliance(query, issues) {
                const compliance = {
                    syntax: true,
                    performance: true,
                    security: true,
                    documentation: true
                };

                issues.forEach(issue => {
                    if (issue.severity === 'critical' || issue.severity === 'major') {
                        switch (issue.category) {
                            case 'syntax':
                                compliance.syntax = false;
                                break;
                            case 'performance':
                                compliance.performance = false;
                                break;
                            case 'security':
                                compliance.security = false;
                                break;
                        }
                    }
                });

                if (!query.includes('//') && query.length > 100) {
                    compliance.documentation = false;
                }

                return compliance;
            }

            calculateGrade(score) {
                if (score >= 90) return 'A';
                if (score >= 80) return 'B';
                if (score >= 70) return 'C';
                if (score >= 60) return 'D';
                return 'F';
            }

            getSeverityWeight(severity) {
                const weights = { 'critical': 10, 'major': 8, 'minor': 6, 'suggestion': 4, 'good': 2 };
                return weights[severity] || 0;
            }

            displayResults(analysis) {
                document.getElementById('welcomeState').style.display = 'none';
                document.getElementById('resultsContent').style.display = 'block';
                
                const resultsContent = document.getElementById('resultsContent');
                resultsContent.innerHTML = '';

                // Score display
                this.addScoreDisplay(resultsContent, analysis);

                // Metrics
                this.addMetricsDisplay(resultsContent, analysis.metrics);

                // Categories
                Object.entries(analysis.categories).forEach(([category, data]) => {
                    this.addCategorySection(resultsContent, category, data);
                });

                // Recommendations
                if (analysis.recommendations.length > 0) {
                    this.addRecommendationsSection(resultsContent, analysis.recommendations);
                }

                // Compliance
                this.addComplianceSection(resultsContent, analysis.compliance);
            }

            addScoreDisplay(container, analysis) {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'score-display';
                
                scoreDiv.innerHTML = `
                    <div class="score-number" style="color: ${this.getScoreColor(analysis.overallScore)}">${analysis.overallScore}</div>
                    <div style="color: var(--text-secondary);">Overall Score</div>
                    <div class="score-grade grade-${analysis.grade.toLowerCase()}">${analysis.grade} Grade</div>
                `;
                
                container.appendChild(scoreDiv);
            }

            addMetricsDisplay(container, metrics) {
                const metricsDiv = document.createElement('div');
                metricsDiv.innerHTML = `
                    <div class="analysis-section">
                        <div class="analysis-header">
                            <div class="analysis-title">üìä Query Metrics</div>
                        </div>
                        <div class="analysis-content">
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-value">${metrics.linesOfCode}</div>
                                    <div class="metric-label">Lines</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${metrics.operators}</div>
                                    <div class="metric-label">Operators</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${metrics.tables}</div>
                                    <div class="metric-label">Tables</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${metrics.complexity}</div>
                                    <div class="metric-label">Complexity</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${metrics.estimatedCost}x</div>
                                    <div class="metric-label">Cost Factor</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(metricsDiv);
            }

            addCategorySection(container, category, data) {
                const section = document.createElement('div');
                section.className = 'analysis-section';
                
                const categoryTitles = {
                    syntax: 'üìù Syntax & Structure',
                    performance: '‚ö° Performance',
                    logic: 'üß† Logic & Semantics',
                    bestPractices: '‚ú® Best Practices',
                    security: 'üõ°Ô∏è Security'
                };

                const scoreClass = this.getCategoryScoreClass(data.score);
                
                section.innerHTML = `
                    <div class="analysis-header">
                        <div class="analysis-title">${categoryTitles[category]}</div>
                        <div class="analysis-score ${scoreClass}">${Math.round(data.score)}/100</div>
                    </div>
                    <div class="analysis-content">
                        <div class="issue-list" id="${category}-issues"></div>
                    </div>
                `;

                const issuesList = section.querySelector('.issue-list');
                
                if (data.issues.length === 0) {
                    issuesList.innerHTML = '<div style="color: var(--ms-success); text-align: center; padding: 16px;">‚úÖ No issues found in this category</div>';
                } else {
                    data.issues.forEach(issue => {
                        const issueElement = this.createIssueElement(issue);
                        issuesList.appendChild(issueElement);
                    });
                }

                container.appendChild(section);
            }

            addRecommendationsSection(container, recommendations) {
                const section = document.createElement('div');
                section.className = 'analysis-section';
                
                section.innerHTML = `
                    <div class="analysis-header">
                        <div class="analysis-title">üí° Recommendations</div>
                    </div>
                    <div class="analysis-content">
                        <div class="issue-list">
                            ${recommendations.map(rec => `
                                <div class="issue-item issue-suggestion">
                                    <div class="issue-title">${rec}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addComplianceSection(container, compliance) {
                const section = document.createElement('div');
                section.className = 'analysis-section';
                
                const complianceItems = [
                    { key: 'syntax', label: 'Syntax Standards', icon: 'üìù' },
                    { key: 'performance', label: 'Performance Standards', icon: '‚ö°' },
                    { key: 'security', label: 'Security Standards', icon: 'üõ°Ô∏è' },
                    { key: 'documentation', label: 'Documentation Standards', icon: 'üìö' }
                ];
                
                section.innerHTML = `
                    <div class="analysis-header">
                        <div class="analysis-title">üèÜ Microsoft Standards Compliance</div>
                    </div>
                    <div class="analysis-content">
                        <div class="metrics-grid">
                            ${complianceItems.map(item => `
                                <div class="metric-card" style="background: ${compliance[item.key] ? 'var(--bg-secondary)' : 'rgba(212, 52, 56, 0.1)'}; border-color: ${compliance[item.key] ? 'var(--border-light)' : 'var(--ms-error)'};">
                                    <div class="metric-value" style="color: ${compliance[item.key] ? 'var(--ms-success)' : 'var(--ms-error)'}">${item.icon}</div>
                                    <div class="metric-label" style="color: ${compliance[item.key] ? 'var(--text-secondary)' : 'var(--ms-error)'};">${item.label}</div>
                                    <div style="font-size: 0.8rem; color: ${compliance[item.key] ? 'var(--ms-success)' : 'var(--ms-error)'}; font-weight: 600; margin-top: 4px;">
                                        ${compliance[item.key] ? 'COMPLIANT' : 'NEEDS WORK'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            createIssueElement(issue) {
                const div = document.createElement('div');
                div.className = `issue-item issue-${issue.severity}`;
                
                const severityEmojis = {
                    'critical': 'üö®',
                    'major': '‚ö†Ô∏è',
                    'minor': 'üí°',
                    'suggestion': 'üí≠',
                    'good': '‚úÖ'
                };

                div.innerHTML = `
                    <div class="issue-header">
                        <div class="issue-title">${severityEmojis[issue.severity]} ${issue.title}</div>
                        <div class="issue-severity severity-${issue.severity}">${issue.severity}</div>
                    </div>
                    <div class="issue-description">${issue.description}</div>
                    <div class="issue-fix">
                        <strong>Fix:</strong> ${issue.fix}
                        ${issue.line ? `<br><small>üìç Line ${issue.line}</small>` : ''}
                        ${issue.impact ? `<br><small>üí° Impact: ${issue.impact}</small>` : ''}
                    </div>
                `;

                return div;
            }

            getScoreColor(score) {
                if (score >= 90) return 'var(--ms-success)';
                if (score >= 80) return 'var(--ms-blue)';
                if (score >= 70) return 'var(--ms-warning)';
                return 'var(--ms-error)';
            }

            getCategoryScoreClass(score) {
                if (score >= 90) return 'score-excellent';
                if (score >= 75) return 'score-good';
                if (score >= 60) return 'score-fair';
                return 'score-poor';
            }

            toggleChat() {
                const chat = document.getElementById('aiChat');
                const toggle = document.getElementById('chatToggle');
                
                if (chat.style.display === 'flex') {
                    chat.style.display = 'none';
                    toggle.style.display = 'block';
                } else {
                    chat.style.display = 'flex';
                    toggle.style.display = 'none';
                }
            }

            sendChatMessage(message) {
                const chatBody = document.getElementById('chatBody');
                
                // Add user message
                const userMsg = document.createElement('div');
                userMsg.className = 'chat-message chat-user';
                userMsg.textContent = message;
                chatBody.appendChild(userMsg);

                // Generate AI response
                setTimeout(() => {
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'chat-message chat-ai';
                    aiMsg.textContent = this.generateAIResponse(message);
                    chatBody.appendChild(aiMsg);
                    chatBody.scrollTop = chatBody.scrollHeight;
                }, 500);

                chatBody.scrollTop = chatBody.scrollHeight;
            }

            generateAIResponse(message) {
                const responses = {
                    'time filter': 'Always add time filters like "| where TimeGenerated > ago(7d)" as your first operation. This is critical for performance in any production environment.',
                    'performance': 'Key performance tips: 1) Filter early with where clauses, 2) Use specific columns with project, 3) Avoid wildcards, 4) Use top instead of order by + take.',
                    'syntax': 'Common KQL syntax: Use lowercase operators (where, not WHERE), avoid trailing semicolons, and ensure proper pipe operator spacing.',
                    'security': 'Security best practices: Avoid projecting sensitive data, use proper authentication event IDs, and ensure queries respect data classification boundaries.',
                    'join': 'For joins: Specify join kind explicitly, use proper key matching, and filter both tables before joining for better performance.',
                    'summarize': 'Summarize tips: Group by low-cardinality fields first, use specific aggregation functions, and consider using bin() for time-based grouping.',
                    'optimize': 'Query optimization: 1) Time filters first, 2) Equality filters before contains, 3) Project only needed columns, 4) Use indexed columns when possible.'
                };

                for (const [key, response] of Object.entries(responses)) {
                    if (message.toLowerCase().includes(key)) {
                        return response;
                    }
                }

                return 'I can help with KQL syntax, performance optimization, Microsoft best practices, security considerations, and query troubleshooting. What specific area would you like guidance on?';
            }

            showAlert(message) {
                alert(message);
            }
        }

        // Global functions for chat
        function toggleChat() {
            grader.toggleChat();
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                grader.sendChatMessage(message);
                input.value = '';
            }
        }

        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Initialize the grader
        let grader;
        document.addEventListener('DOMContentLoaded', () => {
            grader = new MicrosoftKQLGrader();
        });
    </script>
</body>
</html>
