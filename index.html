<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KUSTO OVERLORD - Ultimate KQL Mastery Platform</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --kusto-blue: #0078d4;
            --kusto-light: #00bcf2;
            --kusto-dark: #004578;
            --kusto-accent: #40e0d0;
            --kusto-gold: #ffd700;
            --kusto-warning: #ff6b35;
            --kusto-success: #00ff87;
            --kusto-critical: #ff1744;
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --glass-bg: rgba(26, 26, 46, 0.9);
            --glass-border: rgba(0, 120, 212, 0.3);
        }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, #0f3460 75%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated background particles */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--kusto-accent);
            border-radius: 50%;
            opacity: 0.6;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) translateX(0px); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100px) translateX(100px); opacity: 0; }
        }

        .kusto-header {
            background: linear-gradient(135deg, var(--kusto-blue), #106ebe, var(--kusto-dark));
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--kusto-accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .kusto-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(64, 224, 208, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: drift 25s linear infinite;
        }

        @keyframes drift {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(30px, 30px) rotate(360deg); }
        }

        .kusto-title {
            font-size: 4.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--text-primary), var(--kusto-accent), var(--kusto-gold), var(--kusto-accent), var(--text-primary));
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(64, 224, 208, 0.5);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .kusto-subtitle {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 400;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .overlord-badge {
            display: inline-block;
            background: linear-gradient(45deg, var(--kusto-gold), #ff8c00);
            color: #000;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 900;
            font-size: 0.9rem;
            margin-top: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6); }
        }

        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 50px;
            display: grid;
            grid-template-columns: 1fr 600px;
            gap: 50px;
        }

        .query-section {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 40px;
            border: 2px solid var(--glass-border);
            backdrop-filter: blur(15px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .query-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--kusto-blue), var(--kusto-accent), var(--kusto-gold));
            background-size: 200% 100%;
            animation: borderFlow 3s linear infinite;
        }

        @keyframes borderFlow {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--kusto-accent);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(64, 224, 208, 0.3);
        }

        .kql-editor {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #0d1117 0%, #010409 100%);
            border: 2px solid #30363d;
            border-radius: 15px;
            padding: 25px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            color: #e6edf3;
            resize: none;
            outline: none;
            transition: all 0.4s ease;
            line-height: 1.8;
            box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .kql-editor:focus {
            border-color: var(--kusto-accent);
            box-shadow: 0 0 0 4px rgba(64, 224, 208, 0.2), inset 0 5px 15px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #0d1117 0%, #1c2128 100%);
        }

        .analysis-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .control-group:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--kusto-accent);
            transform: translateY(-2px);
        }

        .control-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(64, 224, 208, 0.1), transparent);
            transition: left 0.5s;
        }

        .control-group:hover::before {
            left: 100%;
        }

        .control-label {
            font-size: 1rem;
            color: var(--kusto-accent);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .control-select {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 16px;
            color: #e6edf3;
            font-size: 1rem;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
        }

        .control-select:focus {
            border-color: var(--kusto-accent);
            box-shadow: 0 0 0 2px rgba(64, 224, 208, 0.2);
        }

        .analyze-button {
            width: 100%;
            padding: 25px;
            background: linear-gradient(135deg, var(--kusto-blue), #106ebe, var(--kusto-accent));
            background-size: 200% 200%;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.4s ease;
            margin-top: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 120, 212, 0.3);
        }

        .analyze-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 120, 212, 0.5);
            background-position: 100% 100%;
        }

        .analyze-button:active {
            transform: translateY(-1px);
        }

        .analyze-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .analyze-button:hover::before {
            left: 100%;
        }

        .results-panel {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 40px;
            border: 2px solid var(--glass-border);
            backdrop-filter: blur(15px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: relative;
        }

        .results-panel::-webkit-scrollbar {
            width: 8px;
        }

        .results-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .results-panel::-webkit-scrollbar-thumb {
            background: var(--kusto-accent);
            border-radius: 4px;
        }

        .kusto-score {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(64, 224, 208, 0.15), rgba(0, 120, 212, 0.15));
            border-radius: 20px;
            border: 2px solid rgba(64, 224, 208, 0.4);
            position: relative;
            overflow: hidden;
        }

        .kusto-score::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(64, 224, 208, 0.1), transparent);
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .score-display {
            font-size: 5rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--kusto-success), var(--kusto-accent), var(--kusto-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
            text-shadow: 0 5px 15px rgba(64, 224, 208, 0.3);
        }

        .score-label {
            font-size: 1.3rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .grade-badge {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 900;
            margin-top: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .grade-overlord { 
            background: linear-gradient(45deg, var(--kusto-gold), #ff8c00, var(--kusto-gold)); 
            color: #000; 
            animation: overlordGlow 2s ease-in-out infinite;
        }
        .grade-production-ready { background: linear-gradient(45deg, var(--kusto-success), #60e0b0); color: #000; }
        .grade-good { background: linear-gradient(45deg, var(--kusto-accent), #0099cc); color: #000; }
        .grade-functional { background: linear-gradient(45deg, #ffa726, #ff9800); color: #000; }
        .grade-needs-work { background: linear-gradient(45deg, #ff5722, #e53935); color: #fff; }
        .grade-major-rework { background: linear-gradient(45deg, #9c27b0, #673ab7); color: #fff; }

        @keyframes overlordGlow {
            0%, 100% { box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 8px 25px rgba(255, 215, 0, 0.8); }
        }

        .analysis-categories {
            display: grid;
            gap: 25px;
        }

        .category-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .category-section:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--kusto-accent);
            transform: translateY(-2px);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--kusto-accent);
            text-shadow: 0 2px 8px rgba(64, 224, 208, 0.3);
        }

        .category-score {
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .score-overlord-level { background: linear-gradient(45deg, var(--kusto-gold), #ff8c00); color: #000; }
        .score-excellent { background: linear-gradient(45deg, var(--kusto-success), #00c851); color: #000; }
        .score-good { background: linear-gradient(45deg, var(--kusto-blue), #0099ff); color: #fff; }
        .score-fair { background: linear-gradient(45deg, #f57c00, #ff9800); color: #fff; }
        .score-poor { background: linear-gradient(45deg, var(--kusto-critical), #d32f2f); color: #fff; }

        .issue-list {
            display: grid;
            gap: 15px;
        }

        .issue-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .issue-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(6px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .issue-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s;
        }

        .issue-item:hover::before {
            left: 100%;
        }

        .issue-critical { border-left-color: var(--kusto-critical); }
        .issue-high { border-left-color: #ff5722; }
        .issue-medium { border-left-color: #ff9800; }
        .issue-low { border-left-color: #4caf50; }
        .issue-info { border-left-color: #2196f3; }
        .issue-optimization { border-left-color: #9c27b0; }
        .issue-masterclass { border-left-color: var(--kusto-gold); }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .issue-title {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .issue-severity {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .severity-critical { background: var(--kusto-critical); color: #fff; }
        .severity-high { background: #ff5722; color: #fff; }
        .severity-medium { background: #ff9800; color: #000; }
        .severity-low { background: #4caf50; color: #fff; }
        .severity-info { background: #2196f3; color: #fff; }
        .severity-optimization { background: #9c27b0; color: #fff; }
        .severity-masterclass { background: var(--kusto-gold); color: #000; }

        .issue-description {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .issue-suggestion {
            background: rgba(64, 224, 208, 0.1);
            border-radius: 10px;
            padding: 15px;
            font-size: 0.95rem;
            color: var(--kusto-accent);
            border: 1px solid rgba(64, 224, 208, 0.2);
        }

        .code-example {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            margin: 12px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: #e6edf3;
            overflow-x: auto;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-box {
            background: linear-gradient(135deg, rgba(64, 224, 208, 0.1), rgba(0, 120, 212, 0.1));
            border: 1px solid rgba(64, 224, 208, 0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(64, 224, 208, 0.2);
        }

        .metric-value {
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--kusto-accent);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 6px;
            font-weight: 600;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .loading-content {
            text-align: center;
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 50px;
            border: 2px solid var(--glass-border);
            backdrop-filter: blur(20px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
        }

        .kusto-spinner {
            width: 100px;
            height: 100px;
            border: 5px solid rgba(64, 224, 208, 0.3);
            border-top: 5px solid var(--kusto-accent);
            border-radius: 50%;
            animation: kustoSpin 1s linear infinite;
            margin: 0 auto 25px;
            position: relative;
        }

        .kusto-spinner::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 3px solid transparent;
            border-top: 3px solid var(--kusto-gold);
            border-radius: 50%;
            animation: kustoSpin 0.5s linear infinite reverse;
        }

        @keyframes kustoSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .analysis-progress {
            width: 400px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 25px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--kusto-blue), var(--kusto-accent), var(--kusto-gold));
            background-size: 200% 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            animation: progressFlow 2s linear infinite;
        }

        @keyframes progressFlow {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .expert-mode {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.15), rgba(103, 58, 183, 0.15));
            border: 1px solid rgba(156, 39, 176, 0.4);
        }

        .benchmark-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.1));
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .benchmark-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: benchmarkGlow 3s ease-in-out infinite;
        }

        @keyframes benchmarkGlow {
            0%, 100% { left: -100%; }
            50% { left: 100%; }
        }

        .benchmark-title {
            color: var(--kusto-gold);
            font-weight: 900;
            margin-bottom: 15px;
            font-size: 1.3rem;
            position: relative;
            z-index: 1;
        }

        .overlord-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2));
            border: 2px solid var(--kusto-gold);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            position: relative;
            overflow: hidden;
        }

        .overlord-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: overlordRotate 6s linear infinite;
        }

        @keyframes overlordRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ai-insights {
            background: linear-gradient(135deg, rgba(0, 255, 135, 0.1), rgba(64, 224, 208, 0.1));
            border: 1px solid var(--kusto-success);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .kusto-title {
                font-size: 3rem;
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-container {
                padding: 20px;
            }
            
            .kusto-title {
                font-size: 2.5rem;
            }
            
            .analysis-controls {
                grid-template-columns: 1fr;
            }
            
            .ai-chatbot {
                width: 100%;
                height: 300px;
                position: relative;
                bottom: 0;
                right: 0;
            }
        }

        /* AI Chatbot Styles */
        .ai-chatbot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 500px;
            background: var(--glass-bg);
            border-radius: 16px;
            border: 2px solid var(--glass-border);
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .ai-chatbot.minimized {
            height: 60px;
        }

        .chatbot-header {
            background: linear-gradient(135deg, var(--kusto-blue), var(--kusto-accent));
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .chatbot-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: #fff;
        }

        .chatbot-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chatbot-toggle {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            font-weight: 900;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .chatbot-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chatbot-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chatbot-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chatbot-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .chatbot-messages::-webkit-scrollbar-thumb {
            background: var(--kusto-accent);
            border-radius: 3px;
        }

        .ai-message, .user-message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--kusto-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .user-message .message-avatar {
            background: var(--kusto-blue);
        }

        .message-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 280px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .user-message .message-content {
            background: var(--kusto-blue);
            color: #fff;
        }

        .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .chatbot-input-area {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
        }

        .chatbot-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .suggestion-chip {
            background: rgba(64, 224, 208, 0.2);
            border: 1px solid var(--kusto-accent);
            color: var(--kusto-accent);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-chip:hover {
            background: var(--kusto-accent);
            color: #000;
        }

        .chatbot-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chatbot-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 10px 16px;
            color: #fff;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .chatbot-input:focus {
            border-color: var(--kusto-accent);
            background: rgba(255, 255, 255, 0.15);
        }

        .chatbot-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .chatbot-send {
            background: var(--kusto-accent);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: #000;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-send:hover {
            background: var(--kusto-blue);
            color: #fff;
            transform: scale(1.05);
        }

        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .ai-thinking {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--kusto-accent);
            font-style: italic;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--kusto-accent);
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="bg-particles" id="particles"></div>
    
    <div class="kusto-header">
        <h1 class="kusto-title">⚡ KUSTO OVERLORD ⚡</h1>
        <p class="kusto-subtitle">The Ultimate AI-Powered KQL Mastery Platform - Real-Time Intelligence</p>
        <div class="overlord-badge">🤖 AI-ENHANCED EDITION 🤖</div>
    </div>

    <div class="main-container">
        <div class="query-section">
            <div class="section-title">
                🚀 KQL Overlord Analysis Chamber
            </div>
            
            <textarea id="kqlEditor" class="kql-editor" placeholder="// Welcome to the Kusto Overlord - Enter your KQL query for ultimate AI-powered analysis
// Example: Professional security analysis with proper documentation
// Purpose: Analyze failed authentication attempts for potential brute force attacks
// Methodology: Statistical analysis with temporal binning for pattern detection

let timeRange = 7d;
let failureThreshold = 10;

SecurityEvent
| where TimeGenerated > ago(timeRange) // Always include time filters first
| where EventID == 4625 // Failed logon attempts
| where Account !has 'ANONYMOUS' and Account !has '

            <div class="analysis-controls">
                <div class="control-group">
                    <div class="control-label">🎯 Analysis Depth</div>
                    <select id="analysisDepth" class="control-select">
                        <option value="standard">Standard Analysis</option>
                        <option value="deep">Deep Analysis</option>
                        <option value="expert">Expert Mode</option>
                        <option value="kusto-level">Kusto Team Level</option>
                        <option value="overlord">🏆 OVERLORD MODE 🏆</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">🌐 Target Environment</div>
                    <select id="targetEnv" class="control-select">
                        <option value="sentinel">Azure Sentinel</option>
                        <option value="analytics">Log Analytics</option>
                        <option value="adx">Azure Data Explorer</option>
                        <option value="defender">Microsoft 365 Defender</option>
                        <option value="synapse">Azure Synapse Analytics</option>
                        <option value="fabric">Microsoft Fabric</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">🎪 Use Case Scenario</div>
                    <select id="useCase" class="control-select">
                        <option value="hunting">Advanced Threat Hunting</option>
                        <option value="detection">Detection Engineering</option>
                        <option value="analytics">Security Analytics</option>
                        <option value="investigation">Incident Investigation</option>
                        <option value="dashboard">Executive Dashboard</option>
                        <option value="automation">SOAR Automation</option>
                        <option value="research">Threat Research</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">🤖 AI Enhancement</div>
                    <select id="aiMode" class="control-select">
                        <option value="pattern-only">Pattern Analysis Only</option>
                        <option value="ai-enhanced">AI-Enhanced Analysis</option>
                        <option value="ai-realtime">Real-Time AI Feedback</option>
                    </select>
                </div>
                
                <div class="control-group" id="apiKeySection" style="display: none;">
                    <div class="control-label">🔑 Google AI Studio API Key</div>
                    <input type="password" id="apiKey" class="control-select" style="height: 40px;" placeholder="Enter your Google AI Studio API key">
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                        Get free API key: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--kusto-accent);">aistudio.google.com</a>
                    </div>
                </div>
            </div>

            <button id="analyzeButton" class="analyze-button">
                🔥 UNLEASH OVERLORD ANALYSIS 🔥
            </button>
        </div>

        <div class="results-panel">
            <div class="section-title">
                📊 Overlord Analysis Matrix
            </div>
            
            <div id="scoreSection" class="kusto-score" style="display: none;">
                <div class="score-display" id="overallScore">--</div>
                <div class="score-label">OVERLORD MASTERY SCORE</div>
                <div class="grade-badge" id="gradeBadge">ANALYZING</div>
            </div>

            <div id="resultsContent" class="analysis-categories">
                <div style="text-align: center; padding: 80px 20px; color: var(--text-secondary);">
                    <div style="font-size: 4rem; margin-bottom: 24px;">⚡</div>
                    <h3 style="color: var(--kusto-accent); margin-bottom: 16px;">AI-Enhanced Kusto Overlord Ready</h3>
                    <p style="margin-top: 12px;">Enter your KQL query and experience AI-powered analysis with comprehensive standards validation.</p>
                    <p style="margin-top: 8px; color: var(--kusto-gold);">🤖 Google AI Studio Integration Available 🤖</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI-Powered KQL Assistant Chatbot -->
    <div class="ai-chatbot" id="aiChatbot">
        <div class="chatbot-header" id="chatbotHeader">
            <div class="chatbot-title">
                <span>🤖</span>
                <span>KQL AI Assistant</span>
                <span class="chatbot-status" id="chatbotStatus">Ready</span>
            </div>
            <button class="chatbot-toggle" id="chatbotToggle">−</button>
        </div>
        <div class="chatbot-body" id="chatbotBody">
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="ai-message">
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        <p>Hello! I'm your AI-powered KQL assistant. I can help you with:</p>
                        <ul>
                            <li>🔍 KQL query optimization and best practices</li>
                            <li>🛡️ Security analysis and threat hunting techniques</li>
                            <li>⚡ Performance troubleshooting and improvements</li>
                            <li>📊 Data analysis strategies and methodology</li>
                            <li>🤔 Explaining your analysis results in detail</li>
                        </ul>
                        <p><strong>Ask me anything about KQL!</strong></p>
                    </div>
                </div>
            </div>
            <div class="chatbot-input-area">
                <div class="chatbot-suggestions" id="chatbotSuggestions">
                    <button class="suggestion-chip">How do I optimize this query?</button>
                    <button class="suggestion-chip">Explain the analysis results</button>
                    <button class="suggestion-chip">KQL best practices</button>
                    <button class="suggestion-chip">Security hunting tips</button>
                </div>
                <div class="chatbot-input-container">
                    <input type="text" id="chatbotInput" class="chatbot-input" placeholder="Ask me about KQL, analysis results, or optimization tips...">
                    <button id="chatbotSend" class="chatbot-send">
                        <span>▶</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="kusto-spinner"></div>
            <h3 style="color: var(--kusto-accent); margin-bottom: 12px;">Overlord Analysis In Progress...</h3>
            <p style="color: var(--text-secondary);" id="analysisStatus">Initializing ultimate KQL mastery assessment...</p>
            <div class="analysis-progress">
                <div class="progress-bar" id="analysisProgress" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <script>
        class KustoOverlord {
            constructor() {
                this.currentSettings = {
                    depth: 'overlord',
                    environment: 'sentinel',
                    useCase: 'hunting',
                    aiMode: 'pattern-only'
                };
                
                this.googleAIApiKey = '';
                this.lastAnalysis = null;
                this.chatbotMinimized = false;
                
                this.initializeParticles();
                this.initializeOverlordRules();
                this.initializeEventListeners();
                this.initializeAdvancedFeatures();
                this.initializeAIChatbot();
            }

            initializeParticles() {
                const particles = document.getElementById('particles');
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 20 + 's';
                    particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
                    particles.appendChild(particle);
                }
            }

            initializeOverlordRules() {
                this.overlordRules = {
                    // MICROSOFT SYNTAX & STRUCTURE STANDARDS
                    syntaxStructure: [
                        {
                            pattern: /\|\s*WHERE\s+|\|\s*SUMMARIZE\s+|\|\s*PROJECT\s+|\|\s*EXTEND\s+|\|\s*JOIN\s+/gi,
                            severity: 'medium',
                            title: '📝 CODING STANDARD: Operator Case Sensitivity',
                            description: 'KQL operators should use lowercase following industry coding standards (where, summarize, project).',
                            suggestion: 'STANDARD PRACTICE: Use lowercase operators: where, summarize, project, extend, join',
                            scoreImpact: -8,
                            category: 'Coding Standards',
                            overlordRating: 'CASE CONVENTION VIOLATION',
                            logicalAnalysis: 'Consistent lowercase operators follow KQL style guidelines and improve readability.',
                            microsoftStandard: 'Required for professional code reviews'
                        },
                        {
                            pattern: /;(?!\s*\/\/|\s*$)/g,
                            severity: 'low',
                            title: '🔧 SYNTAX CLEANUP: Unnecessary Semicolons',
                            description: 'KQL does not require semicolons except in let statements. Unnecessary semicolons can cause parsing issues.',
                            suggestion: 'CLEANUP: Remove unnecessary semicolons - KQL uses pipe operators for statement separation',
                            scoreImpact: -5,
                            category: 'Syntax Standards',
                            overlordRating: 'SYNTAX OPTIMIZATION',
                            logicalAnalysis: 'KQL uses declarative syntax with pipes, making semicolons unnecessary in most contexts.'
                        },
                        {
                            pattern: /\/\*[\s\S]*?\*\//g,
                            severity: 'info',
                            title: '💬 DOCUMENTATION EXCELLENCE: Multi-line Comments',
                            description: 'Query uses multi-line comments for comprehensive documentation.',
                            suggestion: 'EXCELLENT: Proper use of /* */ for multi-line documentation following Microsoft standards',
                            scoreImpact: +5,
                            category: 'Documentation',
                            overlordRating: 'DOCUMENTATION MASTERY',
                            logicalAnalysis: 'Multi-line comments enable comprehensive analytical methodology documentation.'
                        },
                        {
                            pattern: /\/\/.*$/gm,
                            severity: 'info',
                            title: '📋 DOCUMENTATION STANDARD: Single-line Comments',
                            description: 'Query uses proper single-line comment syntax for inline documentation.',
                            suggestion: 'MICROSOFT STANDARD: Excellent use of // for inline comments and explanations',
                            scoreImpact: +3,
                            category: 'Documentation',
                            overlordRating: 'COMMENT STANDARD COMPLIANCE',
                            logicalAnalysis: 'Inline comments provide contextual explanations for complex analytical logic.'
                        }
                    ],

                    // MICROSOFT PERFORMANCE & EFFICIENCY CRITERIA
                    performanceEfficiency: [
                        {
                            pattern: /^(?!.*TimeGenerated.*ago\(.*\))/m,
                            test: (query) => !query.match(/TimeGenerated\s*[><=]+\s*ago\([^)]+\)/gi),
                            severity: 'critical',
                            title: '🚨 PERFORMANCE CRITICAL: Missing Time Range Filter',
                            description: 'Query lacks time boundary filtering. This will scan entire table history causing catastrophic performance impact.',
                            suggestion: 'MANDATORY: Add TimeGenerated > ago(Nd) as first filter. This is the #1 performance requirement for production KQL.',
                            scoreImpact: -35,
                            performanceImpact: 'Query may timeout or consume excessive resources',
                            overlordRating: 'PERFORMANCE KILLER - IMMEDIATE ACTION REQUIRED',
                            benchmarkViolation: 'Critical Performance Standard',
                            logicalAnalysis: 'Time filtering is essential for any time-series data analysis in production systems.',
                            microsoftStandard: 'Required - will not pass production review without time filters'
                        },
                        {
                            pattern: /\|\s*where.*\|\s*project/gi,
                            test: (query) => !query.match(/\|\s*project.*\|\s*where/gi),
                            severity: 'info',
                            title: '✅ MICROSOFT BEST PRACTICE: Filter Before Project',
                            description: 'Query correctly filters data before projection, following Microsoft performance guidelines.',
                            suggestion: 'EXCELLENT: Perfect implementation of filter-first principle for optimal performance',
                            scoreImpact: +8,
                            category: 'Performance Excellence',
                            overlordRating: 'MICROSOFT PERFORMANCE STANDARD',
                            logicalAnalysis: 'Filtering before projection reduces data volume and improves query execution efficiency.',
                            microsoftStandard: 'Recommended pattern in Microsoft KQL performance guidelines'
                        },
                        {
                            pattern: /\|\s*project\s+\*/gi,
                            severity: 'high',
                            title: '⚠️ PERFORMANCE WARNING: Wildcard Projection Anti-Pattern',
                            description: 'Using project * defeats the purpose of column selection and impacts performance significantly.',
                            suggestion: 'BEST PRACTICE: Explicitly specify required columns: | project Column1, Column2, Column3',
                            scoreImpact: -18,
                            performanceImpact: 'Unnecessary data transfer and processing overhead',
                            overlordRating: 'PROJECTION ANTI-PATTERN',
                            logicalAnalysis: 'Explicit column selection reduces bandwidth usage and improves query clarity.',
                            microsoftStandard: 'Wildcard projections flagged in professional code reviews'
                        },
                        {
                            pattern: /\|\s*where.*contains.*\*|\.+\*|\*\w+/gi,
                            severity: 'medium',
                            title: '🔍 PERFORMANCE CONCERN: Wildcard Search Pattern',
                            description: 'Wildcard searches can be expensive. Consider if exact matches or indexed column filters would work.',
                            suggestion: 'OPTIMIZATION: Use equality filters on indexed columns when possible for better performance',
                            scoreImpact: -12,
                            performanceImpact: 'Wildcard searches require full table scans',
                            overlordRating: 'INDEX OPTIMIZATION OPPORTUNITY',
                            logicalAnalysis: 'Exact matches can leverage indexing while wildcards require full column scans.',
                            microsoftStandard: 'Prefer indexed column filters over wildcard searches'
                        }
                    ],

                    // LOGIC & SEMANTICS VALIDATION
                    logicSemantics: [
                        {
                            pattern: /\|\s*summarize.*count.*by.*\|\s*where.*count.*==\s*0/gi,
                            severity: 'high',
                            title: '❌ LOGIC ERROR: Impossible Zero Count Filter',
                            description: 'Filtering for count == 0 after summarization will always return empty results. This is a logical impossibility.',
                            suggestion: 'LOGIC FIX: Remove zero count filter or use different aggregation logic to find missing data',
                            scoreImpact: -20,
                            category: 'Logic Validation',
                            overlordRating: 'LOGICAL IMPOSSIBILITY DETECTED',
                            logicalAnalysis: 'Summarized counts cannot be zero since non-existent groups are not included in results.',
                            microsoftStandard: 'Logic validation required for production deployment'
                        },
                        {
                            pattern: /\|\s*join.*on\s+(?!\$left\.|left\.|right\.|\$right\.)/gi,
                            severity: 'medium',
                            title: '🔗 JOIN CLARITY: Missing Table Prefix',
                            description: 'Join conditions should explicitly specify left/right table prefixes for clarity and avoid ambiguity.',
                            suggestion: 'CLARITY: Use $left.Column == $right.Column or left.Column == right.Column in join conditions',
                            scoreImpact: -10,
                            category: 'Query Clarity',
                            overlordRating: 'JOIN SPECIFICATION NEEDED',
                            logicalAnalysis: 'Explicit table prefixes prevent column ambiguity and improve query maintainability.',
                            microsoftStandard: 'Required for complex joins in Microsoft KQL guidelines'
                        },
                        {
                            pattern: /\|\s*extend.*=.*\|\s*project.*(?!\1)/gi,
                            severity: 'low',
                            title: '🎯 EFFICIENCY CHECK: Unused Extended Columns',
                            description: 'Creating extended columns that are not used in subsequent projection may waste compute resources.',
                            suggestion: 'EFFICIENCY: Verify all extended columns are used, or move extend after project if possible',
                            scoreImpact: -5,
                            category: 'Computational Efficiency',
                            overlordRating: 'COMPUTATIONAL WASTE CHECK',
                            logicalAnalysis: 'Computing unused columns wastes CPU cycles and should be optimized for large datasets.',
                            microsoftStandard: 'Efficiency optimization recommended in Microsoft performance guides'
                        },
                        {
                            pattern: /\|\s*where.*(?:isnull|isempty)\s*\(\s*\w+\s*\).*and.*\w+\s*(?:==|!=)/gi,
                            severity: 'info',
                            title: '✅ DATA VALIDATION: Proper Null Handling',
                            description: 'Query correctly handles null values using isnull() or isempty() functions.',
                            suggestion: 'EXCELLENT: Proper null value validation following Microsoft data handling best practices',
                            scoreImpact: +8,
                            category: 'Data Validation',
                            overlordRating: 'NULL HANDLING MASTERY',
                            logicalAnalysis: 'Explicit null checking prevents unexpected results and improves data quality.',
                            microsoftStandard: 'Recommended pattern for production data analysis'
                        }
                    ],

                    // MICROSOFT BEST PRACTICES COMPLIANCE
                    microsoftBestPractices: [
                        {
                            pattern: /\|\s*extend\s+(\w+)\s*=.*\|\s*project.*\1/gi,
                            severity: 'info',
                            title: '🏷️ NAMING EXCELLENCE: Descriptive Column Names',
                            description: 'Query creates well-named custom columns that improve readability and maintainability.',
                            suggestion: 'MICROSOFT STANDARD: Excellent use of descriptive column naming conventions',
                            scoreImpact: +6,
                            category: 'Code Quality',
                            overlordRating: 'NAMING CONVENTION MASTERY',
                            logicalAnalysis: 'Descriptive column names improve query self-documentation and team collaboration.',
                            microsoftStandard: 'Required naming convention in Microsoft development standards'
                        },
                        {
                            pattern: /(?:parse_json|todynamic|tostring|todatetime|toint|toreal)\s*\(/gi,
                            severity: 'info',
                            title: '🔧 FUNCTION MASTERY: Built-in Function Usage',
                            description: 'Query uses built-in KQL functions instead of complex custom logic for data type conversions.',
                            suggestion: 'MICROSOFT EXCELLENCE: Perfect use of built-in functions for optimal performance and reliability',
                            scoreImpact: +10,
                            category: 'Function Usage',
                            overlordRating: 'BUILT-IN FUNCTION EXPERTISE',
                            logicalAnalysis: 'Built-in functions are optimized and tested, providing better performance than custom implementations.',
                            microsoftStandard: 'Preferred approach in Microsoft KQL development guidelines'
                        },
                        {
                            pattern: /\|\s*take\s+(?:[1-9]\d{4,}|\d{6,})/gi,
                            severity: 'medium',
                            title: '📊 RESOURCE EFFICIENCY: Large Result Set Warning',
                            description: 'Taking very large result sets (>10K rows) may impact system resources and user experience.',
                            suggestion: 'MICROSOFT PRACTICE: Consider pagination or summarization for large datasets to improve efficiency',
                            scoreImpact: -12,
                            category: 'Resource Management',
                            overlordRating: 'RESOURCE USAGE OPTIMIZATION',
                            logicalAnalysis: 'Large result sets consume memory and bandwidth, affecting system performance for other users.',
                            microsoftStandard: 'Resource management guideline in Microsoft Sentinel best practices'
                        },
                        {
                            pattern: /let\s+(\w+)\s*=\s*.*;.*\1/gi,
                            severity: 'info',
                            title: '🔄 REUSABILITY EXCELLENCE: Parameter Usage',
                            description: 'Query uses let statements for parameterization, improving reusability and maintainability.',
                            suggestion: 'MICROSOFT MASTERY: Excellent parameterization for reusable and maintainable analytical logic',
                            scoreImpact: +12,
                            category: 'Code Architecture',
                            overlordRating: 'PARAMETERIZATION MASTERY',
                            logicalAnalysis: 'Parameterization enables query reuse and reduces maintenance overhead in analytical workflows.',
                            microsoftStandard: 'Recommended pattern for enterprise KQL development'
                        }
                    ],

                    // RED FLAG SCENARIOS (CRITICAL ISSUES)
                    redFlagScenarios: [
                        {
                            pattern: /cross-cluster|cluster\(/gi,
                            test: (query) => query.includes('cluster(') && !query.match(/TimeGenerated.*ago/gi),
                            severity: 'critical',
                            title: '🚨 RED FLAG: Cross-cluster Query Without Time Filter',
                            description: 'Cross-cluster queries without time boundaries will scan massive datasets and likely timeout.',
                            suggestion: 'IMMEDIATE FIX: Add strict time filters before attempting cross-cluster operations',
                            scoreImpact: -40,
                            category: 'Critical Performance',
                            overlordRating: 'CROSS-CLUSTER PERFORMANCE KILLER',
                            logicalAnalysis: 'Cross-cluster operations amplify performance issues exponentially without proper filtering.',
                            microsoftStandard: 'Critical violation - requires immediate remediation'
                        },
                        {
                            pattern: /\|\s*where.*matches\s+regex|extract.*regex/gi,
                            test: (query) => {
                                const regexMatches = query.match(/matches\s+regex|extract.*regex/gi);
                                const highCardinalityFields = query.match(/Computer|Account|User|Device|IP|URL/gi);
                                return regexMatches && highCardinalityFields;
                            },
                            severity: 'critical',
                            title: '🚨 RED FLAG: Regex on High-Cardinality Fields',
                            description: 'Regular expressions on high-cardinality fields (Computer, Account, IP) cause severe performance degradation.',
                            suggestion: 'IMMEDIATE FIX: Use has, contains, or exact matches instead of regex on indexed fields',
                            scoreImpact: -35,
                            category: 'Critical Performance',
                            overlordRating: 'REGEX PERFORMANCE KILLER',
                            logicalAnalysis: 'Regex operations prevent index usage and require full column scans on large datasets.',
                            microsoftStandard: 'Performance anti-pattern flagged in Microsoft reviews'
                        },
                        {
                            pattern: /SecurityEvent.*\|\s*where.*EventID.*and.*Computer.*and.*Account/gi,
                            test: (query) => !query.match(/TimeGenerated|EventData|Activity/gi),
                            severity: 'medium',
                            title: '🔍 CONTEXT WARNING: Missing Security Context',
                            description: 'Security event queries should include essential context fields for proper analysis.',
                            suggestion: 'SECURITY BEST PRACTICE: Include TimeGenerated, EventData, or Activity for complete security context',
                            scoreImpact: -15,
                            category: 'Security Analysis',
                            overlordRating: 'SECURITY CONTEXT INCOMPLETE',
                            logicalAnalysis: 'Security analysis requires temporal and contextual data for proper threat assessment.',
                            microsoftStandard: 'Security analysis requirement in Microsoft Sentinel guidelines'
                        }
                    ],

                    // DATA GOVERNANCE & PROTECTION (Enhanced with Microsoft standards)
                    dataGovernance: [
                        {
                            pattern: /\|\s*project.*(?:password|secret|key|token|credential|auth|ssn|social|phone|email|ip|address).*|.*(?:password|secret|key|token|credential|auth|ssn|social|phone|email|ip|address).*\|\s*project/gi,
                            severity: 'high',
                            title: '🔒 MICROSOFT DATA GOVERNANCE: Sensitive Data Projection',
                            description: 'Query projects potentially sensitive data fields. This may violate Microsoft data classification policies.',
                            suggestion: 'GOVERNANCE: Review data classification requirements. Consider data masking or hashing for sensitive analytics.',
                            scoreImpact: -20,
                            category: 'Data Protection',
                            overlordRating: 'DATA CLASSIFICATION REVIEW NEEDED',
                            logicalAnalysis: 'Sensitive data projection must align with organizational data governance policies.',
                            microsoftStandard: 'Data classification compliance required in Microsoft environments'
                        },
                        {
                            pattern: /union.*(?:\w+.*,.*){4,}/gi,
                            severity: 'medium',
                            title: '🔄 DATA BOUNDARY: Multi-Table Union Analysis',
                            description: 'Unioning multiple tables may cross data classification boundaries or security contexts.',
                            suggestion: 'VERIFICATION: Ensure all tables have compatible data classifications and access requirements',
                            scoreImpact: -10,
                            category: 'Data Architecture',
                            overlordRating: 'DATA BOUNDARY VERIFICATION',
                            logicalAnalysis: 'Table unions should respect data classification and access control boundaries.',
                            microsoftStandard: 'Data boundary compliance required in enterprise environments'
                        }
                    ],

                    // MICROSOFT QUALITY SCORING INTEGRATION
                    qualityScoring: [
                        {
                            pattern: /let\s+.*=.*\/\/.*purpose|objective|hypothesis/gi,
                            severity: 'info',
                            title: '🏆 PRODUCTION READY: Documented Analytical Purpose',
                            description: 'Query includes clear analytical purpose documentation with parameterization.',
                            suggestion: 'MICROSOFT EXCELLENCE: Production-ready query with clear purpose and proper architecture',
                            scoreImpact: +15,
                            category: 'Production Quality',
                            overlordRating: 'PRODUCTION EXCELLENCE',
                            logicalAnalysis: 'Clear purpose documentation enables analytical validation and knowledge transfer.',
                            microsoftStandard: 'Production readiness standard in Microsoft analytical frameworks'
                        },
                        {
                            pattern: /\|\s*summarize.*(?:percentile|stdev|variance).*by.*bin\s*\(\s*TimeGenerated/gi,
                            severity: 'info',
                            title: '📊 ADVANCED ANALYTICS: Statistical Time Series',
                            description: 'Query demonstrates advanced statistical analysis with proper temporal binning.',
                            suggestion: 'STATISTICAL MASTERY: Excellent implementation of time-series statistical analysis',
                            scoreImpact: +18,
                            category: 'Advanced Analytics',
                            overlordRating: 'STATISTICAL ANALYTICS MASTERY',
                            logicalAnalysis: 'Statistical time-series analysis enables advanced pattern detection and anomaly identification.',
                            microsoftStandard: 'Advanced analytics pattern in Microsoft data science guidelines'
                        }
                    ]
                };

                // Enhanced table knowledge with Microsoft standards
                this.tableKnowledge = {

                    // PERFORMANCE EXCELLENCE ENGINE
                    performanceOptimization: [
                        {
                            pattern: /^(?!.*TimeGenerated.*ago\(.*\))/m,
                            test: (query) => !query.match(/TimeGenerated\s*[><=]+\s*ago\([^)]+\)/gi),
                            severity: 'critical',
                            title: '⚡ PERFORMANCE CRITICAL: Missing Time Boundary',
                            description: 'No time filter detected. KQL will scan the entire table history, causing exponential performance degradation and high costs.',
                            suggestion: 'MANDATORY FIX: Add TimeGenerated > ago(Nd) as your first filter. This is the #1 performance rule in KQL.',
                            scoreImpact: -30,
                            performanceImpact: 'Could be 1000x slower without time filtering',
                            overlordRating: 'PERFORMANCE KILLER - IMMEDIATE ACTION REQUIRED',
                            benchmarkViolation: 'Microsoft Critical Performance Standard',
                            logicalAnalysis: 'Time filtering is essential for any time-series data analysis in production systems.'
                        },
                        {
                            pattern: /\|\s*extend.*\|\s*where/gi,
                            severity: 'high',
                            title: '🚀 PERFORMANCE OPTIMIZATION: Compute-Before-Filter Pattern',
                            description: 'Computing extended columns before filtering processes unnecessary data. This wastes compute resources on rows that will be discarded.',
                            suggestion: 'OPTIMIZATION: Move WHERE clauses before EXTEND operations. Filter first, compute second for maximum efficiency.',
                            scoreImpact: -18,
                            performanceImpact: '3-8x performance improvement possible',
                            overlordRating: 'COMPUTE EFFICIENCY OPPORTUNITY',
                            logicalAnalysis: 'Filtering reduces data volume before expensive computations, following optimal query execution principles.'
                        },
                        {
                            pattern: /\|\s*order\s+by.*(?!\|\s*top)\|\s*take/gi,
                            severity: 'medium',
                            title: '📈 PERFORMANCE PATTERN: Sort-Then-Limit Anti-Pattern',
                            description: 'ORDER BY followed by TAKE forces full dataset sorting before limiting results. This is computationally expensive.',
                            suggestion: 'ELITE TECHNIQUE: Use | top N by Column [asc|desc] for dramatically better performance on large datasets.',
                            scoreImpact: -15,
                            performanceImpact: '2-10x faster execution with top operator',
                            overlordRating: 'SORTING OPTIMIZATION AVAILABLE',
                            logicalAnalysis: 'Top-N operations are mathematically more efficient than sort-then-limit for partial result sets.'
                        },
                        {
                            pattern: /\|\s*summarize.*\|\s*where.*count|dcount/gi,
                            severity: 'medium',
                            title: '🎯 PERFORMANCE LOGIC: Post-Aggregation Filtering',
                            description: 'Filtering after summarization processes more data than necessary and may not represent optimal analytical logic.',
                            suggestion: 'ADVANCED OPTIMIZATION: Use conditional aggregation with countif() or filter before grouping for better performance.',
                            scoreImpact: -12,
                            performanceImpact: '2-5x improvement with conditional aggregation',
                            overlordRating: 'AGGREGATION PATTERN OPTIMIZATION',
                            logicalAnalysis: 'Pre-aggregation filtering reduces computational load and often represents clearer analytical intent.'
                        },
                        {
                            pattern: /\|\s*project\s+\*/gi,
                            severity: 'medium',
                            title: '📋 RESOURCE EFFICIENCY: Wildcard Projection Impact',
                            description: 'Projecting all columns increases data transfer costs and processing overhead, especially with large tables.',
                            suggestion: 'PRECISION: Explicitly specify only required columns for optimal performance and clearer query intent.',
                            scoreImpact: -10,
                            performanceImpact: 'Reduced bandwidth and faster processing',
                            overlordRating: 'PROJECTION SPECIFICITY NEEDED',
                            logicalAnalysis: 'Explicit column selection improves query readability and reduces resource consumption.'
                        }
                    ],

                    // QUERY LOGIC & REASONING EXCELLENCE
                    queryLogic: [
                        {
                            pattern: /\|\s*where.*=\s*""\s*$|=\s*''\s*$/gm,
                            severity: 'medium',
                            title: '🧠 LOGIC PRECISION: Empty String Logic',
                            description: 'Comparing to empty strings in KQL may not behave as expected. Empty vs null handling requires specific functions.',
                            suggestion: 'LOGICAL PRECISION: Use isempty() or isnotempty() functions for explicit null/empty checking with predictable behavior.',
                            scoreImpact: -8,
                            overlordRating: 'LOGICAL CLARITY IMPROVEMENT',
                            logicalAnalysis: 'Explicit empty/null checking functions provide clearer intent and more predictable results than string comparisons.'
                        },
                        {
                            pattern: /\|\s*where.*contains\s+"/gi,
                            severity: 'low',
                            title: '🔤 LOGIC CONSIDERATION: Case-Sensitive Matching',
                            description: 'contains() operator is case-sensitive. Verify this matches your analytical intent for string comparisons.',
                            suggestion: 'INTENT VERIFICATION: Consider has, has_any, or contains_cs vs contains based on your specific matching requirements.',
                            scoreImpact: -3,
                            overlordRating: 'STRING MATCHING PRECISION',
                            logicalAnalysis: 'Case sensitivity choice should align with the analytical goal - security analysis often needs exact matches.'
                        },
                        {
                            pattern: /\|\s*join.*on\s+\$left\.\w+\s*==\s*\$right\.\w+.*\|\s*project.*\$left.*\$right/gi,
                            severity: 'info',
                            title: '🔗 LOGIC EXCELLENCE: Proper Join Implementation',
                            description: 'Well-structured join with explicit left/right projections. This demonstrates good relational logic understanding.',
                            suggestion: 'EXCELLENT PRACTICE: Clear join logic with proper column prefixing shows advanced KQL engineering.',
                            scoreImpact: +8,
                            overlordRating: 'RELATIONAL LOGIC MASTERY',
                            logicalAnalysis: 'Explicit join column specification and projection clarity indicates sophisticated data relationship understanding.'
                        },
                        {
                            pattern: /let\s+\w+\s*=.*;\s*let\s+\w+\s*=.*;\s*\w+.*\|\s*join.*\w+/gi,
                            severity: 'info',
                            title: '🏗️ ARCHITECTURAL EXCELLENCE: Modular Query Design',
                            description: 'Query uses variables and modular design patterns. This demonstrates excellent analytical architecture.',
                            suggestion: 'OVERLORD LEVEL: Outstanding modular design for maintainable, reusable analytical logic.',
                            scoreImpact: +12,
                            overlordRating: 'ARCHITECTURAL MASTERY',
                            logicalAnalysis: 'Modular design with variables shows advanced planning and creates reusable, maintainable analytical components.'
                        }
                    ],

                    // ANALYTICAL INTELLIGENCE & BEST PRACTICES
                    analyticalIntelligence: [
                        {
                            pattern: /^(?!.*\/\/).*$/m,
                            test: (query) => !query.includes('//') && query.length > 150,
                            severity: 'medium',
                            title: '📚 MAINTAINABILITY: Documentation Gap',
                            description: 'Complex queries without documentation create knowledge gaps and maintenance challenges for teams.',
                            suggestion: 'BEST PRACTICE: Add comments explaining analytical purpose, methodology, and expected outcomes for team collaboration.',
                            scoreImpact: -10,
                            overlordRating: 'KNOWLEDGE TRANSFER IMPROVEMENT',
                            logicalAnalysis: 'Documentation serves as analytical methodology record and enables team knowledge sharing.'
                        },
                        {
                            pattern: /let\s+\w+\s*=/gi,
                            test: (query) => query.match(/let\s+\w+\s*=/gi),
                            severity: 'info',
                            title: '✨ EXCELLENCE: Variable Usage Mastery',
                            description: 'Proper use of let statements demonstrates advanced KQL engineering and analytical planning.',
                            suggestion: 'OUTSTANDING: Excellent variable usage creates maintainable, readable, and reusable analytical logic.',
                            scoreImpact: +10,
                            overlordRating: 'ENGINEERING EXCELLENCE',
                            logicalAnalysis: 'Variables enable complex analytical workflows and demonstrate sophisticated query architecture planning.'
                        },
                        {
                            pattern: /\/\/.*(?:hypothesis|detection|purpose|objective|methodology)/gi,
                            severity: 'info',
                            title: '🎯 ANALYTICAL MASTERY: Strategic Documentation',
                            description: 'Query includes strategic analytical context and methodology documentation.',
                            suggestion: 'OVERLORD LEVEL: Perfect analytical documentation showing clear methodology and strategic intent.',
                            scoreImpact: +15,
                            overlordRating: 'ANALYTICAL METHODOLOGY MASTERY',
                            logicalAnalysis: 'Strategic documentation indicates hypothesis-driven analysis and scientific approach to security research.'
                        },
                        {
                            pattern: /bin\s*\(\s*TimeGenerated\s*,\s*\d+[smhd]\s*\)/gi,
                            severity: 'info',
                            title: '📊 TEMPORAL INTELLIGENCE: Time Binning Excellence',
                            description: 'Intelligent time binning for temporal analysis. This shows advanced time-series analytical understanding.',
                            suggestion: 'ADVANCED TECHNIQUE: Excellent use of temporal binning for trend analysis and pattern detection.',
                            scoreImpact: +8,
                            overlordRating: 'TEMPORAL ANALYSIS MASTERY',
                            logicalAnalysis: 'Time binning enables trend analysis and pattern recognition in time-series security data.'
                        }
                    ],

                    // ADVANCED TECHNIQUE MASTERY
                    advancedTechniques: [
                        {
                            pattern: /materialize\s*\(/gi,
                            severity: 'info',
                            title: '🚀 ADVANCED MASTERY: Query Materialization',
                            description: 'Advanced optimization using materialize() for complex query performance enhancement.',
                            suggestion: 'ELITE TECHNIQUE: Excellent use of materialization for subquery optimization and performance tuning.',
                            scoreImpact: +15,
                            overlordRating: 'ADVANCED OPTIMIZATION MASTERY',
                            logicalAnalysis: 'Materialization demonstrates understanding of query execution optimization for complex analytical workflows.'
                        },
                        {
                            pattern: /mv-expand|mv-apply/gi,
                            severity: 'info',
                            title: '🎭 ADVANCED MASTERY: Multi-Value Processing',
                            description: 'Sophisticated handling of complex data structures with multi-value operators.',
                            suggestion: 'EXPERT LEVEL: Outstanding data structure manipulation showing deep KQL understanding.',
                            scoreImpact: +18,
                            overlordRating: 'DATA ENGINEERING EXCELLENCE',
                            logicalAnalysis: 'Multi-value operations indicate advanced understanding of nested data structures and array processing.'
                        },
                        {
                            pattern: /join\s+kind=(?:leftouter|rightouter|fullouter|leftanti|rightanti|leftantisemi|rightantisemi)/gi,
                            severity: 'info',
                            title: '🔗 ADVANCED MASTERY: Sophisticated Join Strategies',
                            description: 'Advanced join operations demonstrating deep relational data understanding.',
                            suggestion: 'OVERLORD EXPERTISE: Advanced join techniques for comprehensive data relationship analysis.',
                            scoreImpact: +20,
                            overlordRating: 'RELATIONAL MASTERY',
                            logicalAnalysis: 'Complex joins show sophisticated understanding of data relationships and set theory operations.'
                        },
                        {
                            pattern: /parse|extract_all|split|substring|trim|replace/gi,
                            severity: 'info',
                            title: '📝 ADVANCED MASTERY: Text Processing Excellence',
                            description: 'Advanced string manipulation and text processing techniques for data extraction.',
                            suggestion: 'EXPERT SKILL: Sophisticated text processing for data normalization and extraction.',
                            scoreImpact: +12,
                            overlordRating: 'TEXT PROCESSING EXCELLENCE',
                            logicalAnalysis: 'Text processing operations indicate advanced data cleansing and extraction methodology.'
                        },
                        {
                            pattern: /pack_array|pack|bag_pack|dynamic|todynamic|tostring|parse_json/gi,
                            severity: 'info',
                            title: '🏗️ ADVANCED MASTERY: Dynamic Data Architecture',
                            description: 'Advanced dynamic data structuring and JSON manipulation for complex analytics.',
                            suggestion: 'ARCHITECTURAL EXCELLENCE: Expert-level dynamic data structure design and manipulation.',
                            scoreImpact: +16,
                            overlordRating: 'ARCHITECTURAL MASTERY',
                            logicalAnalysis: 'Dynamic data operations show advanced understanding of schema-less data processing and JSON analytics.'
                        },
                        {
                            pattern: /arg_max|arg_min|percentile|percentiles|stdev|variance/gi,
                            severity: 'info',
                            title: '📊 STATISTICAL MASTERY: Advanced Analytics Functions',
                            description: 'Use of sophisticated statistical functions for advanced analytical insights.',
                            suggestion: 'STATISTICAL EXCELLENCE: Advanced statistical analysis demonstrating analytical sophistication.',
                            scoreImpact: +14,
                            overlordRating: 'STATISTICAL ANALYTICS MASTERY',
                            logicalAnalysis: 'Statistical functions indicate advanced analytical methodology and mathematical understanding.'
                        }
                    ],

                    // SECURITY & THREAT INTELLIGENCE
                    securityIntelligence: [
                        {
                            pattern: /SecurityEvent.*EventID.*(?:4624|4625|4688|4672|4648|4656|4657|4658|4663|4670|4719|4720|4722|4724|4725|4728|4732|4735|4738|4740|4767|4768|4769|4771|4776)/gi,
                            severity: 'info',
                            title: '🛡️ SECURITY MASTERY: Critical Event Analysis',
                            description: 'Query targets high-value security events for threat detection and incident analysis.',
                            suggestion: 'SECURITY EXPERTISE: Excellent focus on authentication, privilege escalation, and access events.',
                            scoreImpact: +12,
                            overlordRating: 'SECURITY ANALYTICS MASTERY',
                            logicalAnalysis: 'Specific security event targeting shows understanding of Windows security logging and threat patterns.'
                        },
                        {
                            pattern: /SigninLogs.*(?:ResultType|ConditionalAccessStatus|RiskLevelDuringSignIn|RiskLevelAggregated|RiskState)/gi,
                            severity: 'info',
                            title: '🔐 IDENTITY MASTERY: Advanced Identity Analytics',
                            description: 'Sophisticated identity and access management analytics with risk assessment.',
                            suggestion: 'IDENTITY EXPERTISE: Advanced sign-in behavior analysis with risk correlation.',
                            scoreImpact: +15,
                            overlordRating: 'IDENTITY SECURITY MASTERY',
                            logicalAnalysis: 'Risk-based identity analysis demonstrates understanding of modern authentication security patterns.'
                        },
                        {
                            pattern: /DeviceEvents.*ActionType.*(?:ProcessCreated|NetworkConnectionInitiated|FileCreated|RegistryValueSet|PowerShellCommand|ScriptContent)/gi,
                            severity: 'info',
                            title: '🖥️ ENDPOINT MASTERY: Advanced Endpoint Analytics',
                            description: 'Comprehensive endpoint security monitoring and behavioral analysis.',
                            suggestion: 'ENDPOINT EXPERTISE: Advanced endpoint detection and response analytical techniques.',
                            scoreImpact: +18,
                            overlordRating: 'ENDPOINT SECURITY MASTERY',
                            logicalAnalysis: 'Endpoint behavior analysis shows understanding of attack vectors and system monitoring strategies.'
                        }
                    ],

                    // QUERY ARCHITECTURE & DESIGN PATTERNS
                    architecturePatterns: [
                        {
                            pattern: /(?:let\s+\w+\s*=.*;\s*){2,}.*\w+.*\|\s*(?:join|union)/gi,
                            severity: 'info',
                            title: '🏛️ ARCHITECTURAL EXCELLENCE: Modular Design Pattern',
                            description: 'Query uses modular architecture with variables and complex operations.',
                            suggestion: 'OVERLORD ARCHITECTURE: Outstanding modular design for scalable analytical workflows.',
                            scoreImpact: +20,
                            overlordRating: 'ARCHITECTURAL DESIGN MASTERY',
                            logicalAnalysis: 'Modular architecture demonstrates advanced planning and creates maintainable analytical systems.'
                        },
                        {
                            pattern: /\/\/.*(?:step\s*\d+|phase\s*\d+|part\s*\d+)/gi,
                            severity: 'info',
                            title: '📋 METHODOLOGY EXCELLENCE: Structured Analytical Process',
                            description: 'Query documentation shows structured, step-by-step analytical methodology.',
                            suggestion: 'METHODOLOGICAL MASTERY: Perfect analytical process documentation and structured thinking.',
                            scoreImpact: +12,
                            overlordRating: 'ANALYTICAL METHODOLOGY EXCELLENCE',
                            logicalAnalysis: 'Structured process documentation indicates systematic analytical approach and knowledge transfer capability.'
                        },
                        {
                            pattern: /(?:summarize|count|dcount|avg|sum|max|min|percentile).*by.*TimeGenerated.*bin/gi,
                            severity: 'info',
                            title: '📈 TEMPORAL MASTERY: Time-Series Analytics Excellence',
                            description: 'Advanced time-series aggregation with temporal binning for trend analysis.',
                            suggestion: 'TEMPORAL EXPERTISE: Excellent time-series analytical design for pattern detection.',
                            scoreImpact: +14,
                            overlordRating: 'TEMPORAL ANALYTICS MASTERY',
                            logicalAnalysis: 'Time-based aggregation shows understanding of temporal patterns and trend analysis methodologies.'
                        }
                    ]
                };

                // Enhanced table knowledge with logical context
                this.tableKnowledge = {
                    'SecurityEvent': {
                        commonColumns: ['TimeGenerated', 'Computer', 'Account', 'EventID', 'Activity', 'LogonType'],
                        indexedColumns: ['TimeGenerated', 'Computer', 'EventID', 'Account'],
                        performanceTips: 'CRITICAL: Always filter by TimeGenerated first, then EventID for optimal performance',
                        securityConsiderations: 'Contains PII in Account fields - ensure proper data handling',
                        overlordAdvice: 'EventID 4624=successful logon, 4625=failed logon, 4688=process creation, 4672=special privileges'
                    },
                    'SigninLogs': {
                        commonColumns: ['TimeGenerated', 'UserPrincipalName', 'ResultType', 'IPAddress', 'Location', 'ConditionalAccessStatus'],
                        indexedColumns: ['TimeGenerated', 'UserPrincipalName', 'ResultType', 'IPAddress'],
                        performanceTips: 'CRITICAL: Filter by TimeGenerated and ResultType (0=success, 50126=error) for speed',
                        securityConsiderations: 'Contains PII in UserPrincipalName and location data',
                        overlordAdvice: 'ResultType patterns: 0=success, 50126=invalid username/password, 50053=account locked'
                    },
                    'DeviceEvents': {
                        commonColumns: ['TimeGenerated', 'DeviceName', 'ActionType', 'InitiatingProcessFileName', 'ProcessCommandLine'],
                        indexedColumns: ['TimeGenerated', 'DeviceName', 'ActionType', 'InitiatingProcessFileName'],
                        performanceTips: 'CRITICAL: Use ActionType filter early for dramatic performance gains',
                        securityConsiderations: 'ProcessCommandLine may contain sensitive data',
                        overlordAdvice: 'Key ActionTypes: ProcessCreated, NetworkConnectionInitiated, FileCreated, RegistryValueSet'
                    }
                };
            }

            initializeEventListeners() {
                document.getElementById('analyzeButton').addEventListener('click', () => this.unleashOverlordAnalysis());
                
                // Enhanced settings handlers
                ['analysisDepth', 'targetEnv', 'useCase', 'aiMode'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        this.currentSettings[id.replace(/([A-Z])/g, '_$1').toLowerCase()] = e.target.value;
                        this.updateAnalysisPreview();
                        
                        // Show/hide API key section based on AI mode
                        if (id === 'aiMode') {
                            const apiKeySection = document.getElementById('apiKeySection');
                            const showApiKey = e.target.value !== 'pattern-only';
                            apiKeySection.style.display = showApiKey ? 'block' : 'none';
                        }
                    });
                });

                // API key handler
                document.getElementById('apiKey').addEventListener('change', (e) => {
                    this.googleAIApiKey = e.target.value;
                    this.updateChatbotStatus();
                });

                // Real-time analysis hints
                document.getElementById('kqlEditor').addEventListener('input', 
                    this.debounce(() => this.provideOverlordHints(), 800)
                );
            }

            initializeAIChatbot() {
                // Chatbot toggle
                document.getElementById('chatbotToggle').addEventListener('click', () => {
                    this.toggleChatbot();
                });

                document.getElementById('chatbotHeader').addEventListener('click', () => {
                    this.toggleChatbot();
                });

                // Send message
                document.getElementById('chatbotSend').addEventListener('click', () => {
                    this.sendChatMessage();
                });

                document.getElementById('chatbotInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendChatMessage();
                    }
                });

                // Suggestion chips
                document.querySelectorAll('.suggestion-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        document.getElementById('chatbotInput').value = e.target.textContent;
                        this.sendChatMessage();
                    });
                });

                this.updateChatbotStatus();
            }

            toggleChatbot() {
                const chatbot = document.getElementById('aiChatbot');
                const toggle = document.getElementById('chatbotToggle');
                
                this.chatbotMinimized = !this.chatbotMinimized;
                
                if (this.chatbotMinimized) {
                    chatbot.classList.add('minimized');
                    toggle.textContent = '+';
                } else {
                    chatbot.classList.remove('minimized');
                    toggle.textContent = '−';
                }
            }

            updateChatbotStatus() {
                const status = document.getElementById('chatbotStatus');
                if (!status) return;
                
                const hasApiKey = this.googleAIApiKey && this.googleAIApiKey.length > 0;
                const aiMode = this.currentSettings.aiMode;
                
                if (aiMode === 'pattern-only') {
                    status.textContent = 'Pattern Analysis';
                    status.style.background = 'rgba(100, 149, 237, 0.3)';
                } else if (hasApiKey) {
                    status.textContent = 'AI Ready';
                    status.style.background = 'rgba(0, 255, 135, 0.3)';
                } else {
                    status.textContent = 'API Key Needed';
                    status.style.background = 'rgba(255, 165, 0, 0.3)';
                }
            }

            async sendChatMessage() {
                const input = document.getElementById('chatbotInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                input.value = '';
                this.addChatMessage(message, 'user');
                
                // Show typing indicator
                this.showTypingIndicator();
                
                try {
                    let response;
                    if (this.googleAIApiKey && this.currentSettings.aiMode !== 'pattern-only') {
                        response = await this.getAIResponse(message);
                    } else {
                        response = this.getPatternBasedResponse(message);
                    }
                    
                    this.hideTypingIndicator();
                    this.addChatMessage(response, 'ai');
                } catch (error) {
                    this.hideTypingIndicator();
                    const errorMessage = 'Sorry, I encountered an error. Please check your API key and try again.';
                    this.addChatMessage(errorMessage, 'ai');
                    console.error('AI Response error:', error);
                }
            }

            addChatMessage(message, sender) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'user' ? 'user-message' : 'ai-message';
                
                const avatar = sender === 'user' ? '👤' : '🤖';
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        ${this.formatMessageContent(message)}
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            formatMessageContent(content) {
                // Convert markdown-like formatting to HTML
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px;">$1</code>')
                    .replace(/\n/g, '<br>');
            }

            showTypingIndicator() {
                const messagesContainer = document.getElementById('chatbotMessages');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'ai-message';
                typingDiv.id = 'typing-indicator';
                
                typingDiv.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="message-content ai-thinking">
                        <span>Thinking</span>
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            async getAIResponse(message) {
                const context = this.buildAIContext(message);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.googleAIApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: context
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024,
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            buildAIContext(userMessage) {
                let context = `You are an expert KQL (Kusto Query Language) assistant helping users with Azure Sentinel, Log Analytics, and security data analysis. 

Your expertise includes:
- KQL syntax, operators, and functions
- Performance optimization and best practices  
- Security analysis and threat hunting
- Data visualization and reporting
- Troubleshooting and debugging queries

User's question: ${userMessage}

`;

                // Add current query context if available
                const currentQuery = document.getElementById('kqlEditor').value.trim();
                if (currentQuery) {
                    context += `\nCurrent KQL query being analyzed:\n\`\`\`kql\n${currentQuery}\n\`\`\`\n`;
                }

                // Add analysis results context if available
                if (this.lastAnalysis) {
                    context += `\nLatest analysis results:
- Overall Score: ${this.lastAnalysis.overallScore}/100
- Grade: ${this.lastAnalysis.grade}
- Total Issues: ${this.lastAnalysis.issues.length}
- Security Risk: ${this.lastAnalysis.securityRisk?.level || 'Unknown'}
- Performance Score: ${this.lastAnalysis.performancePrediction?.score || 'Unknown'}

Key issues found: ${this.lastAnalysis.issues.slice(0, 3).map(i => i.title).join(', ')}
`;
                }

                context += `\nProvide helpful, accurate, and actionable advice. Include specific KQL examples when relevant. Keep responses concise but informative.`;

                return context;
            }

            getPatternBasedResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // Pattern-based responses for common queries
                if (lowerMessage.includes('optimize') || lowerMessage.includes('performance')) {
                    return `**KQL Performance Tips:**

1. **Always use time filters**: \`TimeGenerated > ago(1d)\`
2. **Filter early**: Put WHERE clauses as early as possible
3. **Limit columns**: Use \`project\` to select only needed columns
4. **Use indexed columns**: Filter on Computer, EventID, etc.
5. **Avoid wildcards**: Use \`has\` instead of \`contains\` when possible

**Example:**
\`\`\`kql
SecurityEvent
| where TimeGenerated > ago(1d)  // Filter first
| where EventID == 4624          // Use indexed column
| project TimeGenerated, Computer, Account  // Limit columns
\`\`\``;
                }
                
                if (lowerMessage.includes('security') || lowerMessage.includes('threat') || lowerMessage.includes('hunting')) {
                    return `**Security Analysis Best Practices:**

🔍 **Threat Hunting Approach:**
- Start with hypothesis-driven analysis
- Use statistical baselines for anomaly detection
- Correlate multiple data sources
- Document your methodology

🛡️ **Common Security Queries:**
- Failed logins: \`SecurityEvent | where EventID == 4625\`
- Process creation: \`SecurityEvent | where EventID == 4688\`
- Network connections: \`DeviceNetworkEvents\`

⚡ **Advanced Techniques:**
- Use \`summarize\` for aggregation and counting
- Apply \`bin()\` for time-based analysis
- Leverage \`join\` for correlation analysis`;
                }
                
                if (lowerMessage.includes('explain') || lowerMessage.includes('results')) {
                    if (this.lastAnalysis) {
                        return `**Your Analysis Results Explained:**

📊 **Overall Score:** ${this.lastAnalysis.overallScore}/100 (${this.lastAnalysis.grade})

🔍 **Key Findings:**
${this.lastAnalysis.issues.slice(0, 3).map(issue => 
                            `• **${issue.title}**: ${issue.description.substring(0, 100)}...`
                        ).join('\n')}

🎯 **Top Recommendations:**
${this.lastAnalysis.recommendations?.slice(0, 2).join('\n• ') || 'No specific recommendations'}

Would you like me to explain any specific issue in more detail?`;
                    } else {
                        return "Please run an analysis first, then I can explain the results in detail!";
                    }
                }
                
                if (lowerMessage.includes('best practices') || lowerMessage.includes('standards')) {
                    return `**KQL Best Practices & Standards:**

📝 **Syntax Standards:**
- Use lowercase operators: \`where\`, \`summarize\`, \`project\`
- Add comments with \`//\` for documentation
- Use descriptive column names

⚡ **Performance Standards:**
- Always include time filters
- Filter before extending or projecting
- Use \`top\` instead of \`order by | take\`

🔒 **Security Standards:**
- Don't project sensitive data unnecessarily
- Validate data types and handle nulls
- Use parameterized queries for reusability

🏗️ **Architecture Standards:**
- Use \`let\` statements for complex queries
- Break complex logic into steps
- Document analytical methodology`;
                }
                
                // Default response
                return `I'm here to help with KQL queries and analysis! I can assist with:

🔧 **Query Optimization** - Making your queries faster and more efficient
🛡️ **Security Analysis** - Threat hunting and detection techniques  
📊 **Data Analysis** - Statistical analysis and visualization
🐛 **Troubleshooting** - Fixing syntax errors and logic issues
📚 **Best Practices** - Following industry standards and conventions

Try asking about specific topics like "optimize my query", "security best practices", or "explain the analysis results"!`;
            }

            initializeAdvancedFeatures() {
                // Initialize comprehensive analysis components
                this.overlordBenchmarks = this.initializeBenchmarks();
                this.performancePredictor = this.initializePerformancePredictor();
            }

            initializeBenchmarks() {
                return {
                    microsoftStandard: true,
                    industryStandard: true,
                    overlordStandard: true
                };
            }

            initializePerformancePredictor() {
                return {
                    enabled: true,
                    models: ['performance', 'cost', 'runtime']
                };
            }

            async unleashOverlordAnalysis() {
                const query = document.getElementById('kqlEditor').value.trim();
                
                if (!query) {
                    this.showOverlordAlert('⚡ OVERLORD REQUIRES INPUT ⚡', 'Please provide a KQL query for ultimate analysis.');
                    return;
                }

                this.showLoading();

                try {
                    await this.performOverlordAnalysis(query);
                } catch (error) {
                    console.error('Overlord analysis failed:', error);
                    this.showOverlordAlert('🚨 OVERLORD ERROR 🚨', 'Analysis failed. The Overlord demands better input.');
                } finally {
                    this.hideLoading();
                }
            }

            async performOverlordAnalysis(query) {
                const overlordSteps = [
                    { name: 'Overlord Query Parsing & Validation', duration: 700 },
                    { name: 'Security Vulnerability Deep Scan', duration: 900 },
                    { name: 'Performance Pattern Analysis Matrix', duration: 1000 },
                    { name: 'Best Practices Mastery Assessment', duration: 800 },
                    { name: 'Table Schema Intelligence Analysis', duration: 600 },
                    { name: 'Advanced Technique Recognition', duration: 700 },
                    { name: 'Environment-Specific Optimization', duration: 500 },
                    { name: 'Use Case Strategic Evaluation', duration: 600 },
                    { name: 'AI-Powered Insight Generation', duration: 800 },
                    { name: 'Overlord Mastery Scoring', duration: 900 }
                ];

                let progress = 0;
                const progressBar = document.getElementById('analysisProgress');
                const statusElement = document.getElementById('analysisStatus');

                for (const step of overlordSteps) {
                    statusElement.textContent = step.name + '...';
                    await this.delay(step.duration);
                    progress += 100 / overlordSteps.length;
                    progressBar.style.width = progress + '%';
                }

                // Perform pattern-based analysis
                const analysis = this.performOverlordComprehensiveAnalysis(query);
                
                // Add AI insights if available
                if (this.googleAIApiKey && this.currentSettings.aiMode !== 'pattern-only') {
                    statusElement.textContent = 'Generating AI-Enhanced Insights...';
                    try {
                        analysis.aiInsights = await this.generateAIInsights(query, analysis);
                        analysis.aiEnhanced = true;
                    } catch (error) {
                        console.error('AI insights failed:', error);
                        analysis.aiInsights = ['AI insights unavailable - check API key'];
                        analysis.aiEnhanced = false;
                    }
                } else {
                    analysis.aiInsights = ['Enable AI mode and add API key for enhanced insights'];
                    analysis.aiEnhanced = false;
                }
                
                // Store for chatbot context
                this.lastAnalysis = analysis;
                
                this.displayOverlordResults(analysis);
            }

            async generateAIInsights(query, analysis) {
                const aiContext = `You are an expert KQL analyst. Analyze this query and provide 3-5 specific, actionable insights.

Query:
\`\`\`kql
${query}
\`\`\`

Analysis Results:
- Score: ${analysis.overallScore}/100
- Issues found: ${analysis.issues.length}
- Security risk: ${analysis.securityRisk?.level}
- Performance score: ${analysis.performancePrediction?.score}

Top issues:
${analysis.issues.slice(0, 3).map(i => `- ${i.title}: ${i.description}`).join('\n')}

Provide specific insights about:
1. Code quality and architecture
2. Performance optimization opportunities  
3. Security considerations
4. Best practice improvements
5. Advanced techniques that could be applied

Format as JSON array of insight objects with "title" and "description" fields. Keep descriptions concise and actionable.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.googleAIApiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: aiContext
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.3,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 1024,
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`AI API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    
                    // Try to parse as JSON, fallback to text parsing
                    try {
                        return JSON.parse(aiResponse);
                    } catch {
                        // Fallback: parse text response into insights
                        return this.parseAITextResponse(aiResponse);
                    }
                } catch (error) {
                    console.error('AI insights generation failed:', error);
                    return ['AI analysis unavailable - please check your API key and internet connection'];
                }
            }

            parseAITextResponse(text) {
                const insights = [];
                const lines = text.split('\n').filter(line => line.trim());
                
                let currentInsight = null;
                for (const line of lines) {
                    if (line.match(/^\d+\.|^-|\*/) && line.length > 10) {
                        if (currentInsight) insights.push(currentInsight);
                        currentInsight = {
                            title: line.replace(/^\d+\.\s*|\*\s*|-\s*/, '').split(':')[0],
                            description: line.replace(/^\d+\.\s*|\*\s*|-\s*/, '')
                        };
                    } else if (currentInsight && line.trim()) {
                        currentInsight.description += ' ' + line.trim();
                    }
                }
                if (currentInsight) insights.push(currentInsight);
                
                return insights.slice(0, 5); // Limit to 5 insights
            }

            performOverlordComprehensiveAnalysis(query) {
                let score = 100;
                const issues = [];
                const categories = {
                    security: { score: 100, issues: [], weight: 0.25 },
                    performance: { score: 100, issues: [], weight: 0.30 },
                    syntax: { score: 100, issues: [], weight: 0.15 },
                    bestPractices: { score: 100, issues: [], weight: 0.15 },
                    advanced: { score: 100, issues: [], weight: 0.10 },
                    environment: { score: 100, issues: [], weight: 0.05 }
                };

                // Apply overlord-level rules
                this.applyOverlordRules(query, issues, categories);

                // Environment-specific overlord analysis
                this.applyEnvironmentOverlordRules(query, issues, categories);

                // Use case overlord analysis
                this.applyUseCaseOverlordRules(query, issues, categories);

                // Calculate weighted score
                score = this.calculateWeightedOverlordScore(categories);

                // Advanced query complexity analysis
                const complexity = this.calculateAdvancedComplexity(query);
                
                // Security risk assessment
                const securityRisk = this.assessSecurityRisk(query, issues);
                
                // Performance prediction
                const performancePrediction = this.predictQueryPerformance(query);

                return {
                    overallScore: Math.round(score),
                    grade: this.calculateOverlordGrade(score),
                    categories: categories,
                    issues: issues.sort((a, b) => this.getSeverityWeight(b.severity) - this.getSeverityWeight(a.severity)),
                    queryMetrics: this.calculateAdvancedQueryMetrics(query),
                    recommendations: this.generateOverlordRecommendations(query, score, issues),
                    expertInsights: this.generateOverlordInsights(query, issues, score),
                    securityRisk: securityRisk,
                    performancePrediction: performancePrediction,
                    complexity: complexity,
                    benchmarkResults: this.runOverlordBenchmarks(query, score),
                    aiInsights: [], // Will be populated if AI is enabled
                    aiEnhanced: false // Will be set to true if AI analysis completes
                };
            }

            applyOverlordRules(query, issues, categories) {
                // Microsoft Syntax & Structure Standards
                this.overlordRules.syntaxStructure.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'syntax');
                });

                // Microsoft Performance & Efficiency Criteria
                this.overlordRules.performanceEfficiency.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'performance');
                });

                // Logic & Semantics Validation
                this.overlordRules.logicSemantics.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'syntax');
                });

                // Microsoft Best Practices Compliance
                this.overlordRules.microsoftBestPractices.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'bestPractices');
                });

                // Red Flag Scenarios (Critical Issues)
                this.overlordRules.redFlagScenarios.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'security');
                });

                // Data Governance (Enhanced)
                this.overlordRules.dataGovernance.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'security');
                });

                // Quality Scoring Integration
                this.overlordRules.qualityScoring.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'advanced');
                });

                // Performance Optimization Analysis
                this.overlordRules.performanceOptimization?.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'performance');
                });

                // Analytical Intelligence
                this.overlordRules.analyticalIntelligence?.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'bestPractices');
                });

                // Advanced Techniques
                this.overlordRules.advancedTechniques?.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'advanced');
                });
            }

            evaluateRule(rule, query, issues, categories, category) {
                let matches = [];
                
                if (rule.test && typeof rule.test === 'function') {
                    if (rule.test(query)) {
                        matches = [true];
                    }
                } else if (rule.pattern) {
                    matches = query.match(rule.pattern) || [];
                }

                if (matches.length > 0) {
                    const issue = {
                        category: category,
                        severity: rule.severity,
                        title: rule.title,
                        description: rule.description,
                        suggestion: rule.suggestion,
                        scoreImpact: rule.scoreImpact || 0,
                        occurrences: matches.length,
                        cwe: rule.cwe,
                        overlordRating: rule.overlordRating,
                        performanceImpact: rule.performanceImpact,
                        benchmarkViolation: rule.benchmarkViolation,
                        compliance: rule.compliance,
                        remediation: rule.remediation,
                        logicalAnalysis: rule.logicalAnalysis,
                        category: rule.category,
                        microsoftStandard: rule.microsoftStandard,
                        line: this.findQueryLine(query, matches[0])
                    };

                    issues.push(issue);
                    
                    if (categories[category]) {
                        categories[category].issues.push(issue);
                        categories[category].score += rule.scoreImpact || 0;
                        categories[category].score = Math.max(categories[category].score, 0);
                    }
                }
            }

            applyEnvironmentOverlordRules(query, issues, categories) {
                const env = this.currentSettings.environment || this.currentSettings.target_env;
                
                // Apply security intelligence rules based on environment
                if (env === 'sentinel') {
                    // Sentinel-specific analysis
                    if (query.match(/SecurityEvent|SigninLogs|DeviceEvents|ThreatIntelligenceIndicator/gi)) {
                        issues.push({
                            category: 'environment',
                            severity: 'info',
                            title: '🛡️ SENTINEL OPTIMIZATION: Security Table Usage',
                            description: 'Query effectively uses Sentinel security tables for comprehensive threat analysis.',
                            suggestion: 'EXCELLENT: Proper use of Sentinel tables for security analytics and threat hunting.',
                            scoreImpact: +8,
                            overlordRating: 'SENTINEL TABLE MASTERY',
                            logicalAnalysis: 'Sentinel security tables provide comprehensive security telemetry for advanced threat detection.'
                        });
                    }
                }
                
                if (env === 'defender' && query.match(/DeviceEvents|DeviceProcessEvents|DeviceNetworkEvents/gi)) {
                    issues.push({
                        category: 'environment',
                        severity: 'info',
                        title: '🖥️ DEFENDER EXCELLENCE: Endpoint Table Optimization',
                        description: 'Query leverages Defender endpoint tables for comprehensive device security analysis.',
                        suggestion: 'DEFENDER MASTERY: Expert use of endpoint security tables for behavioral analysis.',
                        scoreImpact: +10,
                        overlordRating: 'ENDPOINT ANALYTICS EXCELLENCE',
                        logicalAnalysis: 'Defender endpoint tables enable deep behavioral analysis and threat hunting on managed devices.'
                    });
                }
            }

            applyUseCaseOverlordRules(query, issues, categories) {
                const useCase = this.currentSettings.useCase || this.currentSettings.use_case;
                
                if (useCase === 'hunting') {
                    if (query.match(/\/\/.*(?:hypothesis|ttp|mitre|technique)/gi)) {
                        issues.push({
                            category: 'useCase',
                            severity: 'info',
                            title: '🎯 HUNTING MASTERY: Hypothesis-Driven Methodology',
                            description: 'Threat hunting query demonstrates structured analytical methodology with clear hypothesis.',
                            suggestion: 'HUNTING EXCELLENCE: Perfect implementation of hypothesis-driven threat hunting approach.',
                            scoreImpact: +15,
                            overlordRating: 'THREAT HUNTING METHODOLOGY MASTERY',
                            logicalAnalysis: 'Hypothesis-driven hunting follows scientific method and improves detection accuracy.'
                        });
                    }
                    
                    if (!query.includes('//') && query.length > 100) {
                        issues.push({
                            category: 'useCase',
                            severity: 'medium',
                            title: '📚 HUNTING IMPROVEMENT: Documentation for Methodology',
                            description: 'Threat hunting queries benefit from documented hypotheses and analytical reasoning.',
                            suggestion: 'HUNTING BEST PRACTICE: Add comments explaining threat hypothesis and detection methodology.',
                            scoreImpact: -8,
                            overlordRating: 'HUNTING DOCUMENTATION NEEDED',
                            logicalAnalysis: 'Documented hunting hypotheses enable knowledge transfer and methodology validation.'
                        });
                    }
                }

                if (useCase === 'detection') {
                    if (query.match(/summarize.*(?:count|dcount|avg|percentile).*by.*\|\s*where.*>/gi)) {
                        issues.push({
                            category: 'useCase',
                            severity: 'info',
                            title: '🚨 DETECTION EXCELLENCE: Statistical Anomaly Logic',
                            description: 'Detection rule uses statistical analysis for threshold-based anomaly identification.',
                            suggestion: 'DETECTION MASTERY: Excellent statistical approach to behavioral anomaly detection.',
                            scoreImpact: +12,
                            overlordRating: 'STATISTICAL DETECTION ENGINEERING',
                            logicalAnalysis: 'Statistical thresholds enable reliable anomaly detection with reduced false positives.'
                        });
                    } else if (!query.match(/summarize|count|dcount/gi)) {
                        issues.push({
                            category: 'useCase',
                            severity: 'low',
                            title: '🔍 DETECTION CONSIDERATION: Aggregation Pattern',
                            description: 'Detection rules typically benefit from aggregation for alert condition logic.',
                            suggestion: 'DETECTION PATTERN: Consider adding summarize with count() or dcount() for detection thresholds.',
                            scoreImpact: -5,
                            overlordRating: 'DETECTION PATTERN OPTIMIZATION',
                            logicalAnalysis: 'Aggregation patterns help establish baselines and threshold-based detection logic.'
                        });
                    }
                }

                if (useCase === 'analytics') {
                    if (query.match(/bin\s*\(\s*TimeGenerated\s*,/gi)) {
                        issues.push({
                            category: 'useCase',
                            severity: 'info',
                            title: '📊 ANALYTICS EXCELLENCE: Temporal Analysis',
                            description: 'Analytics query uses time binning for trend analysis and pattern recognition.',
                            suggestion: 'ANALYTICS MASTERY: Excellent temporal analysis for trend identification and reporting.',
                            scoreImpact: +10,
                            overlordRating: 'TEMPORAL ANALYTICS EXCELLENCE',
                            logicalAnalysis: 'Time binning enables trend analysis and pattern recognition in security data over time.'
                        });
                    }
                }
            }

            calculateWeightedOverlordScore(categories) {
                let weightedScore = 0;
                let totalWeight = 0;

                Object.entries(categories).forEach(([category, data]) => {
                    const weight = data.weight || 0.1;
                    weightedScore += data.score * weight;
                    totalWeight += weight;
                });

                return Math.max(Math.min(weightedScore / totalWeight, 100), 0);
            }

            calculateAdvancedComplexity(query) {
                let complexity = 1;
                
                // Advanced complexity factors
                const complexPatterns = [
                    { pattern: /join/gi, weight: 3 },
                    { pattern: /union/gi, weight: 2 },
                    { pattern: /materialize/gi, weight: 4 },
                    { pattern: /mv-expand|mv-apply/gi, weight: 3 },
                    { pattern: /parse|extract/gi, weight: 2 },
                    { pattern: /summarize/gi, weight: 2 },
                    { pattern: /let\s+\w+\s*=/gi, weight: 1 }
                ];

                complexPatterns.forEach(({ pattern, weight }) => {
                    const matches = query.match(pattern) || [];
                    complexity += matches.length * weight;
                });

                return Math.min(complexity, 100);
            }

            assessSecurityRisk(query, issues) {
                const criticalIssues = issues.filter(i => i.severity === 'critical').length;
                const highIssues = issues.filter(i => i.severity === 'high').length;
                const dataGovernanceIssues = issues.filter(i => i.category === 'Data Protection').length;
                
                let riskLevel = 'LOW';
                let riskScore = 0;

                if (criticalIssues > 0) {
                    riskLevel = 'HIGH';
                    riskScore = 75 + (criticalIssues * 5);
                } else if (highIssues > 1 || dataGovernanceIssues > 2) {
                    riskLevel = 'MEDIUM';
                    riskScore = 45 + (highIssues * 8) + (dataGovernanceIssues * 5);
                } else if (highIssues > 0 || dataGovernanceIssues > 0) {
                    riskLevel = 'LOW-MEDIUM';
                    riskScore = 25 + (highIssues * 10) + (dataGovernanceIssues * 8);
                } else {
                    riskLevel = 'LOW';
                    riskScore = 15;
                }

                return {
                    level: riskLevel,
                    score: Math.min(riskScore, 100),
                    criticalIssues,
                    highIssues,
                    dataGovernanceIssues,
                    recommendation: this.getSecurityRecommendation(riskLevel)
                };
            }

            getSecurityRecommendation(riskLevel) {
                const recommendations = {
                    'HIGH': '🔍 REVIEW REQUIRED: Data governance issues detected. Review data projection and access patterns.',
                    'MEDIUM': '📋 CONSIDERATION: Some data handling patterns could be optimized for better governance.',
                    'LOW-MEDIUM': '💡 MINOR ITEMS: Minor data governance considerations for optimization.',
                    'LOW': '✅ EXCELLENT: Query follows good data governance and security practices.'
                };
                return recommendations[riskLevel];
            }

            predictQueryPerformance(query) {
                let performanceScore = 100;
                let estimatedRuntime = 1;
                let costFactor = 1;

                // Performance impact factors
                if (!query.match(/TimeGenerated.*ago/gi)) {
                    performanceScore -= 60;
                    estimatedRuntime *= 50;
                    costFactor *= 100;
                }

                if (query.match(/\|\s*project\s+\*/gi)) {
                    performanceScore -= 20;
                    costFactor *= 2;
                }

                if (query.match(/join/gi)) {
                    performanceScore -= 15;
                    estimatedRuntime *= 3;
                    costFactor *= 5;
                }

                if (query.match(/order.*by.*\|\s*take/gi)) {
                    performanceScore -= 10;
                    estimatedRuntime *= 2;
                }

                return {
                    score: Math.max(performanceScore, 0),
                    estimatedRuntime: `${Math.min(estimatedRuntime, 300)}s`,
                    costFactor: Math.min(costFactor, 1000),
                    recommendation: this.getPerformanceRecommendation(performanceScore)
                };
            }

            getPerformanceRecommendation(score) {
                if (score >= 90) return '🚀 OPTIMAL: Query performance is excellent';
                if (score >= 75) return '⚡ GOOD: Minor optimizations possible';
                if (score >= 60) return '🔧 MODERATE: Performance improvements recommended';
                return '🚨 CRITICAL: Major performance issues require immediate attention';
            }

            calculateAdvancedQueryMetrics(query) {
                const lines = query.split('\n').length;
                const operators = (query.match(/\|/g) || []).length;
                const tables = this.extractTableNames(query);
                const functions = this.extractFunctions(query);
                
                return {
                    linesOfCode: lines,
                    operators: operators,
                    tables: tables.length,
                    functions: functions.length,
                    tableNames: tables,
                    functionNames: functions,
                    estimatedCost: this.calculateQueryCost(query),
                    maintainabilityIndex: this.calculateMaintainabilityIndex(query)
                };
            }

            extractTableNames(query) {
                const tablePattern = /^(\w+)(?:\s*\||\s*$)/gm;
                const matches = [...query.matchAll(tablePattern)];
                return [...new Set(matches.map(m => m[1]).filter(t => 
                    !['let', 'print', 'range'].includes(t.toLowerCase())
                ))];
            }

            extractFunctions(query) {
                const functionPattern = /(\w+)\s*\(/g;
                const matches = [...query.matchAll(functionPattern)];
                return [...new Set(matches.map(m => m[1]))];
            }

            calculateQueryCost(query) {
                let cost = 1;
                
                // Cost factors
                if (!query.match(/TimeGenerated.*ago/gi)) cost *= 50;
                if (query.match(/\|\s*project\s+\*/gi)) cost *= 3;
                if (query.match(/join/gi)) cost *= 10;
                if (query.match(/union/gi)) cost *= 5;
                
                const takeMatch = query.match(/\|\s*take\s+(\d+)/gi);
                if (takeMatch) {
                    const takeValue = parseInt(takeMatch[0].match(/\d+/)[0]);
                    if (takeValue > 10000) cost *= 2;
                }

                return Math.min(cost, 1000);
            }

            calculateMaintainabilityIndex(query) {
                let index = 100;
                
                // Documentation factor
                if (!query.includes('//')) index -= 20;
                
                // Complexity factor
                const complexity = this.calculateAdvancedComplexity(query);
                index -= Math.min(complexity * 0.5, 30);
                
                // Variable usage bonus
                if (query.match(/let\s+\w+\s*=/gi)) index += 10;
                
                return Math.max(Math.min(index, 100), 0);
            }

            generateOverlordRecommendations(query, score, issues) {
                const recommendations = [];
                
                if (score < 50) {
                    recommendations.push('🚨 OVERLORD VERDICT: Query requires major reconstruction before production deployment');
                    recommendations.push('⚡ PRIORITY 1: Address all critical security and performance issues immediately');
                }
                
                if (!query.match(/TimeGenerated.*ago/gi)) {
                    recommendations.push('🎯 MANDATORY: Add time filtering - this is non-negotiable for any production query');
                }
                
                if (query.match(/\|\s*project\s+\*/gi)) {
                    recommendations.push('📋 OPTIMIZATION: Replace wildcard projections with specific column selection');
                }
                
                if (!query.includes('//') && query.length > 100) {
                    recommendations.push('📚 MAINTAINABILITY: Add comprehensive documentation for complex logic');
                }

                const securityIssues = issues.filter(i => i.severity === 'critical' || i.severity === 'high').length;
                if (securityIssues > 0) {
                    recommendations.push('🛡️ SECURITY: Immediate security remediation required before any deployment');
                }

                return recommendations;
            }

            generateOverlordInsights(query, issues, score) {
                const insights = [];
                
                // Overlord-level insights
                if (score >= 95) {
                    insights.push('🏆 OVERLORD STATUS: Query achieves elite mastery level - exceeds Microsoft engineering standards');
                }
                
                if (score >= 90) {
                    insights.push('⚡ KUSTO MASTERY: Query demonstrates expert-level KQL engineering practices');
                }

                const advancedTechniques = issues.filter(i => i.overlordRating && i.overlordRating.includes('MASTERY')).length;
                if (advancedTechniques > 0) {
                    insights.push(`🚀 ADVANCED MASTERY: ${advancedTechniques} expert-level techniques detected`);
                }

                const securityIssues = issues.filter(i => i.category === 'security').length;
                if (securityIssues === 0) {
                    insights.push('🛡️ SECURITY OVERLORD: Perfect security posture - no vulnerabilities detected');
                }

                const performanceIssues = issues.filter(i => i.category === 'performance').length;
                if (performanceIssues === 0) {
                    insights.push('⚡ PERFORMANCE OVERLORD: Optimal performance patterns throughout query');
                }

                if (query.match(/\/\/.*(?:hypothesis|mitre|ttp)/gi)) {
                    insights.push('🎯 ANALYTICAL MASTERY: Strategic threat hunting with documented methodology');
                }

                return insights;
            }

            runOverlordBenchmarks(query, score) {
                const benchmarks = {
                    microsoftStandard: this.benchmarkAgainstMicrosoft(query, score),
                    industryStandard: this.benchmarkAgainstIndustry(query, score),
                    overlordStandard: this.benchmarkAgainstOverlord(query, score)
                };

                return benchmarks;
            }

            benchmarkAgainstMicrosoft(query, score) {
                // Microsoft engineering standards benchmark
                let microsoftScore = 0;
                
                if (query.match(/TimeGenerated.*ago/gi)) microsoftScore += 30;
                if (!query.match(/\|\s*project\s+\*/gi)) microsoftScore += 20;
                if (query.includes('//')) microsoftScore += 15;
                if (query.match(/let\s+\w+\s*=/gi)) microsoftScore += 20;
                if (!query.match(/\|\s*where.*==.*['"]/gi)) microsoftScore += 15;

                const status = microsoftScore >= 80 ? 'EXCEEDS' : microsoftScore >= 60 ? 'MEETS' : 'BELOW';
                
                return {
                    score: microsoftScore,
                    status: status,
                    description: `${status} Microsoft Engineering Standards`
                };
            }

            benchmarkAgainstIndustry(query, score) {
                // Industry standard benchmark
                const industryScore = Math.min(score * 0.9, 100);
                const status = industryScore >= 85 ? 'INDUSTRY LEADING' : industryScore >= 70 ? 'ABOVE AVERAGE' : 'BELOW AVERAGE';
                
                return {
                    score: Math.round(industryScore),
                    status: status,
                    description: `${status} compared to industry practices`
                };
            }

            benchmarkAgainstOverlord(query, score) {
                // Overlord standard benchmark (highest possible)
                let overlordScore = 0;
                
                // Overlord criteria
                if (query.match(/TimeGenerated.*ago/gi)) overlordScore += 20;
                if (query.match(/let\s+\w+\s*=/gi)) overlordScore += 15;
                if (query.includes('//') && query.match(/\/\/.*(?:hypothesis|purpose|objective)/gi)) overlordScore += 20;
                if (query.match(/materialize|mv-expand|mv-apply/gi)) overlordScore += 15;
                if (!query.match(/\|\s*project\s+\*/gi)) overlordScore += 10;
                if (query.match(/join\s+kind=(?:leftouter|rightouter)/gi)) overlordScore += 10;
                if (!query.match(/\|\s*where.*==.*['"]/gi)) overlordScore += 10;

                const status = overlordScore >= 90 ? 'OVERLORD MASTERY' : overlordScore >= 75 ? 'EXPERT LEVEL' : overlordScore >= 60 ? 'ADVANCED' : 'DEVELOPING';
                
                return {
                    score: overlordScore,
                    status: status,
                    description: `${status} - Ultimate KQL Engineering Standards`
                };
            }

            calculateOverlordGrade(score) {
                // Microsoft Quality Scoring Rubric Integration
                if (score >= 98) return 'OVERLORD';
                if (score >= 90) return 'PRODUCTION-READY'; // 90-100%: Production-ready, follows all best practices
                if (score >= 80) return 'GOOD'; // 80-89%: Good with minor optimizations needed
                if (score >= 70) return 'FUNCTIONAL'; // 70-79%: Functional but requires performance improvements
                if (score >= 60) return 'NEEDS-WORK'; // 60-69%: Logic issues that need addressing
                return 'MAJOR-REWORK'; // Below 60%: Major rework required
            }

            getSeverityWeight(severity) {
                const weights = {
                    'critical': 10,
                    'high': 8,
                    'medium': 6,
                    'low': 4,
                    'info': 2,
                    'optimization': 3,
                    'masterclass': 1
                };
                return weights[severity] || 0;
            }

            findQueryLine(query, searchStr) {
                if (!searchStr || typeof searchStr !== 'string') return 1;
                
                const lines = query.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes(searchStr.substring(0, 30))) {
                        return i + 1;
                    }
                }
                return 1;
            }

            displayOverlordResults(analysis) {
                document.getElementById('scoreSection').style.display = 'block';
                document.getElementById('overallScore').textContent = analysis.overallScore;
                
                const gradeBadge = document.getElementById('gradeBadge');
                if (analysis.grade === 'OVERLORD') {
                    gradeBadge.textContent = '🏆 OVERLORD 🏆';
                } else if (analysis.grade === 'PRODUCTION-READY') {
                    gradeBadge.textContent = '✅ PRODUCTION READY';
                } else if (analysis.grade === 'GOOD') {
                    gradeBadge.textContent = '👍 GOOD - MINOR OPTIMIZATIONS';
                } else if (analysis.grade === 'FUNCTIONAL') {
                    gradeBadge.textContent = '⚙️ FUNCTIONAL - NEEDS PERFORMANCE WORK';
                } else if (analysis.grade === 'NEEDS-WORK') {
                    gradeBadge.textContent = '🔧 NEEDS WORK - LOGIC ISSUES';
                } else if (analysis.grade === 'MAJOR-REWORK') {
                    gradeBadge.textContent = '🚨 MAJOR REWORK REQUIRED';
                } else {
                    gradeBadge.textContent = `Grade: ${analysis.grade}`;
                }
                
                // Fix class name for CSS compatibility
                const cssClassName = analysis.grade.toLowerCase().replace(/-/g, '-');
                gradeBadge.className = `grade-badge grade-${cssClassName}`;

                const resultsContent = document.getElementById('resultsContent');
                resultsContent.innerHTML = '';

                // AI-Enhanced Insights
                if (analysis.aiInsights && analysis.aiInsights.length > 0) {
                    this.addAIInsightsSection(resultsContent, analysis.aiInsights, analysis.aiEnhanced);
                }

                // Microsoft Compliance Status (renamed to Standards Compliance)
                this.addStandardsComplianceSection(resultsContent, analysis);

                // Overlord Status Section
                if (analysis.grade === 'OVERLORD') {
                    this.addOverlordStatusSection(resultsContent, analysis);
                }

                // Performance Metrics
                this.addAdvancedMetricsSection(resultsContent, analysis.queryMetrics);

                // Security Risk Assessment
                this.addSecurityRiskSection(resultsContent, analysis.securityRisk);

                // Performance Prediction
                this.addPerformancePredictionSection(resultsContent, analysis.performancePrediction);

                // Categories Analysis
                Object.entries(analysis.categories).forEach(([category, data]) => {
                    if (data.issues.length > 0 || ['security', 'performance'].includes(category)) {
                        this.addOverlordCategorySection(resultsContent, category, data);
                    }
                });

                // Overlord Recommendations
                if (analysis.recommendations.length > 0) {
                    this.addOverlordRecommendationsSection(resultsContent, analysis.recommendations);
                }

                // Expert Insights
                if (analysis.expertInsights.length > 0) {
                    this.addOverlordInsightsSection(resultsContent, analysis.expertInsights);
                }

                // Benchmark Results
                this.addBenchmarkResultsSection(resultsContent, analysis.benchmarkResults);

                // AI Insights
                this.addAIInsightsSection(resultsContent, analysis);
            }

            addMicrosoftComplianceSection(container, analysis) {
                const microsoftIssues = analysis.issues.filter(i => i.microsoftStandard);
                const criticalViolations = microsoftIssues.filter(i => i.severity === 'critical').length;
                const standardViolations = microsoftIssues.filter(i => i.severity === 'high' || i.severity === 'medium').length;
                
                let complianceStatus = 'COMPLIANT';
                let complianceColor = 'var(--kusto-success)';
                let complianceMessage = 'Query meets Microsoft engineering standards';
                
                if (criticalViolations > 0) {
                    complianceStatus = 'NON-COMPLIANT';
                    complianceColor = 'var(--kusto-critical)';
                    complianceMessage = `${criticalViolations} critical Microsoft standard violations detected`;
                } else if (standardViolations > 2) {
                    complianceStatus = 'NEEDS REVIEW';
                    complianceColor = '#ff9800';
                    complianceMessage = `${standardViolations} Microsoft standard issues require attention`;
                } else if (standardViolations > 0) {
                    complianceStatus = 'MINOR ISSUES';
                    complianceColor = 'var(--kusto-blue)';
                    complianceMessage = `${standardViolations} minor Microsoft standard optimizations available`;
                }

                const section = document.createElement('div');
                section.className = 'category-section';
                section.style.border = `2px solid ${complianceColor}`;
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">🏢 Microsoft Standards Compliance</div>
                        <div class="category-score" style="background: ${complianceColor}; color: #fff;">
                            ${complianceStatus}
                        </div>
                    </div>
                    <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; color: var(--kusto-critical); font-weight: 900;">${criticalViolations}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">CRITICAL VIOLATIONS</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; color: #ff9800; font-weight: 900;">${standardViolations}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">STANDARD ISSUES</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; color: ${complianceColor}; font-weight: 900;">${microsoftIssues.length}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">TOTAL MS ITEMS</div>
                            </div>
                        </div>
                        <div style="text-align: center; color: ${complianceColor}; font-weight: 600; font-size: 1.1rem;">
                            ${complianceMessage}
                        </div>
                        <div style="text-align: center; margin-top: 12px; color: var(--text-secondary); font-size: 0.9rem;">
                            Based on Microsoft KQL development guidelines, security standards, and performance requirements
                        </div>
                    </div>
                `;
                
            addOverlordStatusSection(container, analysis) {
                const section = document.createElement('div');
                section.className = 'overlord-section';
                
                section.innerHTML = `
                    <div style="position: relative; z-index: 1;">
                        <h3 style="color: var(--kusto-gold); font-size: 1.8rem; margin-bottom: 16px; text-align: center;">
                            🏆 OVERLORD STATUS ACHIEVED 🏆
                        </h3>
                        <p style="color: #fff; text-align: center; font-size: 1.2rem; margin-bottom: 20px;">
                            This query has achieved the highest possible mastery level in KQL engineering.
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">SECURITY</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">PERFORMANCE</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">MICROSOFT STANDARDS</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }
                const section = document.createElement('div');
                section.className = 'overlord-section';
                
                section.innerHTML = `
                    <div style="position: relative; z-index: 1;">
                        <h3 style="color: var(--kusto-gold); font-size: 1.8rem; margin-bottom: 16px; text-align: center;">
                            🏆 OVERLORD STATUS ACHIEVED 🏆
                        </h3>
                        <p style="color: #fff; text-align: center; font-size: 1.2rem; margin-bottom: 20px;">
                            This query has achieved the highest possible mastery level in KQL engineering.
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">SECURITY</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">PERFORMANCE</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">ENGINEERING</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addAdvancedMetricsSection(container, metrics) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">📊 Advanced Query Metrics</div>
                    </div>
                    <div class="performance-metrics">
                        <div class="metric-box">
                            <div class="metric-value">${metrics.linesOfCode}</div>
                            <div class="metric-label">Lines of Code</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${metrics.operators}</div>
                            <div class="metric-label">KQL Operators</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${metrics.tables}</div>
                            <div class="metric-label">Tables Used</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${metrics.functions}</div>
                            <div class="metric-label">Functions</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${metrics.estimatedCost}</div>
                            <div class="metric-label">Cost Factor</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${Math.round(metrics.maintainabilityIndex)}</div>
                            <div class="metric-label">Maintainability</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; font-size: 0.9rem; color: var(--text-secondary);">
                        <strong>Tables:</strong> ${metrics.tableNames.join(', ') || 'None detected'}<br>
                        <strong>Key Functions:</strong> ${metrics.functionNames.slice(0, 10).join(', ') || 'None detected'}
                    </div>
                `;
                
                container.appendChild(section);
            }

            addSecurityRiskSection(container, securityRisk) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const riskColor = {
                    'CRITICAL': 'var(--kusto-critical)',
                    'HIGH': '#ff5722',
                    'MEDIUM': '#ff9800',
                    'LOW': 'var(--kusto-success)'
                }[securityRisk.level];
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">🛡️ Security Risk Assessment</div>
                        <div class="category-score" style="background: ${riskColor}; color: #fff;">
                            ${securityRisk.level} RISK
                        </div>
                    </div>
                    <div style="padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--kusto-critical); font-weight: 900;">${securityRisk.criticalIssues}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">CRITICAL ISSUES</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: #ff5722; font-weight: 900;">${securityRisk.highIssues}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">HIGH ISSUES</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: ${riskColor}; font-weight: 900;">${securityRisk.score}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">RISK SCORE</div>
                            </div>
                        </div>
                        <div style="color: var(--kusto-accent); font-weight: 600;">
                            ${securityRisk.recommendation}
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addPerformancePredictionSection(container, performance) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const perfColor = performance.score >= 90 ? 'var(--kusto-success)' : 
                                 performance.score >= 75 ? 'var(--kusto-blue)' : 
                                 performance.score >= 60 ? '#ff9800' : 'var(--kusto-critical)';
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">⚡ Performance Prediction</div>
                        <div class="category-score" style="background: ${perfColor}; color: #fff;">
                            ${Math.round(performance.score)}/100
                        </div>
                    </div>
                    <div style="padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--kusto-accent); font-weight: 900;">${performance.estimatedRuntime}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">EST. RUNTIME</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--kusto-accent); font-weight: 900;">${performance.costFactor}x</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">COST FACTOR</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: ${perfColor}; font-weight: 900;">${Math.round(performance.score)}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">PERF SCORE</div>
                            </div>
                        </div>
                        <div style="color: var(--kusto-accent); font-weight: 600;">
                            ${performance.recommendation}
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addOverlordCategorySection(container, category, data) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const categoryIcons = {
                    security: '🛡️',
                    performance: '⚡',
                    syntax: '📝',
                    bestPractices: '✨',
                    advanced: '🚀',
                    environment: '🌐'
                };

                const scoreClass = this.getOverlordScoreClass(data.score);
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">${categoryIcons[category]} ${category.charAt(0).toUpperCase() + category.slice(1)} Analysis</div>
                        <div class="category-score ${scoreClass}">${Math.round(data.score)}/100</div>
                    </div>
                    <div class="issue-list" id="${category}-issues"></div>
                `;

                const issuesList = section.querySelector('.issue-list');
                
                if (data.issues.length === 0) {
                    issuesList.innerHTML = '<div style="color: var(--kusto-success); text-align: center; padding: 20px;">🏆 OVERLORD LEVEL: Perfect execution in this category</div>';
                } else {
                    data.issues.forEach(issue => {
                        const issueElement = this.createOverlordIssueElement(issue);
                        issuesList.appendChild(issueElement);
                    });
                }

                container.appendChild(section);
            }

            addOverlordRecommendationsSection(container, recommendations) {
                const section = document.createElement('div');
                section.className = 'category-section expert-mode';
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">🎯 Overlord Recommendations</div>
                    </div>
                    <div class="issue-list">
                        ${recommendations.map(rec => `
                            <div class="issue-item issue-info">
                                <div class="issue-title">${rec}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(section);
            }

            addOverlordInsightsSection(container, insights) {
                const section = document.createElement('div');
                section.className = 'category-section ai-insights';
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">🧠 Overlord Intelligence Insights</div>
                    </div>
                    <div class="issue-list">
                        ${insights.map(insight => `
                            <div class="issue-item issue-masterclass">
                                <div class="issue-title">${insight}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(section);
            }

            addBenchmarkResultsSection(container, benchmarks) {
                const section = document.createElement('div');
                section.className = 'benchmark-section';
                
                section.innerHTML = `
                    <div class="benchmark-title">🏆 Overlord Benchmark Results</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px; position: relative; z-index: 1;">
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 16px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: var(--kusto-blue); margin-bottom: 8px;">Microsoft Standards</h4>
                            <div style="font-size: 1.5rem; color: var(--kusto-accent); font-weight: 900;">${benchmarks.microsoftStandard.score}/100</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">${benchmarks.microsoftStandard.description}</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 16px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: var(--kusto-blue); margin-bottom: 8px;">Industry Standards</h4>
                            <div style="font-size: 1.5rem; color: var(--kusto-accent); font-weight: 900;">${benchmarks.industryStandard.score}/100</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">${benchmarks.industryStandard.description}</div>
                        </div>
                        <div style="background: rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 16px; border: 1px solid var(--kusto-gold);">
                            <h4 style="color: var(--kusto-gold); margin-bottom: 8px;">Overlord Standards</h4>
                            <div style="font-size: 1.5rem; color: var(--kusto-gold); font-weight: 900;">${benchmarks.overlordStandard.score}/100</div>
                            <div style="color: var(--kusto-gold); font-size: 0.9rem;">${benchmarks.overlordStandard.description}</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addAIInsightsSection(container, analysis) {
                const section = document.createElement('div');
                section.className = 'overlord-section';
                
                const aiInsights = this.generateAIInsights(analysis);
                
                section.innerHTML = `
                    <div style="position: relative; z-index: 1;">
                        <h3 style="color: var(--kusto-gold); font-size: 1.5rem; margin-bottom: 16px;">
                            🤖 AI-Powered Overlord Analysis
                        </h3>
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px;">
                            ${aiInsights.map(insight => `
                                <div style="margin-bottom: 12px; padding: 12px; background: rgba(64, 224, 208, 0.1); border-radius: 8px; border-left: 3px solid var(--kusto-accent);">
                                    <strong style="color: var(--kusto-accent);">${insight.title}:</strong>
                                    <span style="color: #fff; margin-left: 8px;">${insight.description}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            generateAIInsights(analysis) {
                const insights = [];
                
                // Query complexity analysis
                if (analysis.complexity > 20) {
                    insights.push({
                        title: 'Complexity Analysis',
                        description: `High complexity query (${analysis.complexity}/100) suggests sophisticated analytical requirements. Consider modularization for maintainability.`
                    });
                }

                // Performance insights
                if (analysis.performancePrediction.score < 70) {
                    insights.push({
                        title: 'Performance Optimization',
                        description: `Performance score ${analysis.performancePrediction.score}/100 indicates significant optimization opportunities. Focus on time filtering and projection optimization.`
                    });
                }

                // Security insights
                if (analysis.securityRisk.level === 'LOW') {
                    insights.push({
                        title: 'Security Excellence',
                        description: 'Query demonstrates excellent security practices with no significant vulnerabilities detected.'
                    });
                }

                // Advanced technique recognition
                const advancedIssues = analysis.issues.filter(i => i.overlordRating && i.overlordRating.includes('MASTERY'));
                if (advancedIssues.length > 0) {
                    insights.push({
                        title: 'Advanced Technique Mastery',
                        description: `Detected ${advancedIssues.length} advanced KQL techniques demonstrating expert-level proficiency.`
                    });
                }

                return insights;
            }

            createOverlordIssueElement(issue) {
                const div = document.createElement('div');
                div.className = `issue-item issue-${issue.severity}`;
                
                const severityEmojis = {
                    'critical': '🚨',
                    'high': '⚠️',
                    'medium': '⚡',
                    'low': '💡',
                    'info': 'ℹ️',
                    'optimization': '🚀',
                    'masterclass': '🏆'
                };

                const scoreDisplay = issue.scoreImpact > 0 ? 
                    `<span style="color: var(--kusto-success);">+${issue.scoreImpact}</span>` : 
                    `<span style="color: var(--kusto-critical);">${issue.scoreImpact}</span>`;

                div.innerHTML = `
                    <div class="issue-header">
                        <div class="issue-title">${severityEmojis[issue.severity]} ${issue.title}</div>
                        <div class="issue-severity severity-${issue.severity}">${issue.severity}</div>
                    </div>
                    <div class="issue-description">${issue.description}</div>
                    <div class="issue-suggestion">
                        <strong>💡 Overlord Guidance:</strong> ${issue.suggestion}
                        ${issue.line ? `<br><small>📍 Line: ${issue.line}</small>` : ''}
                        ${issue.cwe ? `<br><small>🔗 Security Reference: ${issue.cwe}</small>` : ''}
                        ${issue.overlordRating ? `<br><small>⚡ Overlord Rating: ${issue.overlordRating}</small>` : ''}
                        ${issue.performanceImpact ? `<br><small>🚀 Performance Impact: ${issue.performanceImpact}</small>` : ''}
                        ${issue.benchmarkViolation ? `<br><small>📊 Benchmark: ${issue.benchmarkViolation}</small>` : ''}
                        ${issue.compliance ? `<br><small>⚖️ Compliance: ${issue.compliance}</small>` : ''}
                        ${issue.remediation ? `<br><small>🔧 Remediation: ${issue.remediation}</small>` : ''}
                        ${issue.logicalAnalysis ? `<br><small>🧠 Logic Analysis: ${issue.logicalAnalysis}</small>` : ''}
                        ${issue.category ? `<br><small>📂 Category: ${issue.category}</small>` : ''}
                        ${issue.microsoftStandard ? `<br><small>📏 Industry Standard: ${issue.microsoftStandard}</small>` : ''}
                        ${issue.scoreImpact !== undefined ? `<br><small>📈 Score Impact: ${scoreDisplay}</small>` : ''}
                    </div>
                `;

                return div;
            }

            getOverlordScoreClass(score) {
                if (score >= 98) return 'score-overlord-level';
                if (score >= 90) return 'score-excellent';
                if (score >= 75) return 'score-good';
                if (score >= 60) return 'score-fair';
                return 'score-poor';
            }

            async provideOverlordHints() {
                const query = document.getElementById('kqlEditor').value;
                const aiMode = this.currentSettings.aiMode;
                
                if (aiMode === 'ai-realtime' && this.googleAIApiKey && query.length > 50) {
                    try {
                        await this.provideRealTimeAIFeedback(query);
                    } catch (error) {
                        console.error('Real-time AI feedback failed:', error);
                    }
                }
                
                // Real-time pattern-based analysis hints
                console.log('Overlord providing real-time analysis hints');
            }

            async provideRealTimeAIFeedback(query) {
                const context = `Provide quick real-time feedback for this KQL query. Focus on immediate issues and suggestions. Keep response under 200 words.

Query:
\`\`\`kql
${query}
\`\`\`

Provide concise feedback about:
1. Immediate syntax issues
2. Performance concerns  
3. Quick optimization tips
4. Best practice suggestions

Format as brief, actionable points.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.googleAIApiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: context
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.3,
                                topK: 20,
                                topP: 0.8,
                                maxOutputTokens: 200,
                            }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const feedback = data.candidates[0].content.parts[0].text;
                        this.showRealTimeFeedback(feedback);
                    }
                } catch (error) {
                    console.error('Real-time feedback error:', error);
                }
            }

            showRealTimeFeedback(feedback) {
                // Create or update real-time feedback overlay
                let feedbackOverlay = document.getElementById('realtime-feedback');
                
                if (!feedbackOverlay) {
                    feedbackOverlay = document.createElement('div');
                    feedbackOverlay.id = 'realtime-feedback';
                    feedbackOverlay.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        max-width: 300px;
                        background: rgba(0, 120, 212, 0.95);
                        color: white;
                        padding: 12px;
                        border-radius: 8px;
                        font-size: 0.8rem;
                        z-index: 100;
                        backdrop-filter: blur(10px);
                        animation: slideIn 0.3s ease-out;
                    `;
                    
                    document.querySelector('.query-section').style.position = 'relative';
                    document.querySelector('.query-section').appendChild(feedbackOverlay);
                }
                
                feedbackOverlay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span>🤖</span>
                        <strong>AI Real-time Feedback</strong>
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer;">×</button>
                    </div>
                    <div>${this.formatMessageContent(feedback)}</div>
                `;
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    if (feedbackOverlay && feedbackOverlay.parentNode) {
                        feedbackOverlay.remove();
                    }
                }, 10000);
            }

            updateAnalysisPreview() {
                // Update analysis preview based on current settings
                const aiMode = this.currentSettings.aiMode || this.currentSettings.ai_mode;
                const status = document.getElementById('chatbotStatus');
                
                if (status) {
                    this.updateChatbotStatus();
                }
                
                console.log('Analysis preview updated for mode:', aiMode);
            }

            showOverlordAlert(title, message) {
                alert(`${title}\n\n${message}`);
            }

            showLoading() {
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('analysisProgress').style.width = '0%';
            }

            hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            debounce(func, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize the Kusto Overlord
        document.addEventListener('DOMContentLoaded', () => {
            new KustoOverlord();
        });
    </script>
</body>
</html> // Filter out system accounts
| extend 
    CleanAccount = tolower(trim(@'\s', Account)),
    CleanComputer = tolower(Computer)
| summarize 
    FailureCount = count(),
    UniqueComputers = dcount(CleanComputer),
    FirstFailure = min(TimeGenerated),
    LastFailure = max(TimeGenerated),
    FailureRate = count() / datetime_diff('hour', max(TimeGenerated), min(TimeGenerated))
    by CleanAccount
| where FailureCount >= failureThreshold
| extend ThreatScore = FailureCount * UniqueComputers * FailureRate
| project CleanAccount, FailureCount, UniqueComputers, ThreatScore, FirstFailure, LastFailure
| order by ThreatScore desc
| take 20"></textarea>

            <div class="analysis-controls">
                <div class="control-group">
                    <div class="control-label">🎯 Analysis Depth</div>
                    <select id="analysisDepth" class="control-select">
                        <option value="standard">Standard Analysis</option>
                        <option value="deep">Deep Analysis</option>
                        <option value="expert">Expert Mode</option>
                        <option value="kusto-level">Kusto Team Level</option>
                        <option value="overlord">🏆 OVERLORD MODE 🏆</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">🌐 Target Environment</div>
                    <select id="targetEnv" class="control-select">
                        <option value="sentinel">Azure Sentinel</option>
                        <option value="analytics">Log Analytics</option>
                        <option value="adx">Azure Data Explorer</option>
                        <option value="defender">Microsoft 365 Defender</option>
                        <option value="synapse">Azure Synapse Analytics</option>
                        <option value="fabric">Microsoft Fabric</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">🎪 Use Case Scenario</div>
                    <select id="useCase" class="control-select">
                        <option value="hunting">Advanced Threat Hunting</option>
                        <option value="detection">Detection Engineering</option>
                        <option value="analytics">Security Analytics</option>
                        <option value="investigation">Incident Investigation</option>
                        <option value="dashboard">Executive Dashboard</option>
                        <option value="automation">SOAR Automation</option>
                        <option value="research">Threat Research</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <div class="control-label">🤖 AI Enhancement</div>
                    <select id="aiMode" class="control-select">
                        <option value="pattern-only">Pattern Analysis Only</option>
                        <option value="ai-enhanced">AI-Enhanced Analysis</option>
                        <option value="ai-realtime">Real-Time AI Feedback</option>
                    </select>
                </div>
                
                <div class="control-group" id="apiKeySection" style="display: none;">
                    <div class="control-label">🔑 Google AI Studio API Key</div>
                    <input type="password" id="apiKey" class="control-select" style="height: 40px;" placeholder="Enter your Google AI Studio API key">
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                        Get free API key: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--kusto-accent);">aistudio.google.com</a>
                    </div>
                </div>
            </div>

            <button id="analyzeButton" class="analyze-button">
                🔥 UNLEASH OVERLORD ANALYSIS 🔥
            </button>
        </div>

        <div class="results-panel">
            <div class="section-title">
                📊 Overlord Analysis Matrix
            </div>
            
            <div id="scoreSection" class="kusto-score" style="display: none;">
                <div class="score-display" id="overallScore">--</div>
                <div class="score-label">OVERLORD MASTERY SCORE</div>
                <div class="grade-badge" id="gradeBadge">ANALYZING</div>
            </div>

            <div id="resultsContent" class="analysis-categories">
                <div style="text-align: center; padding: 80px 20px; color: var(--text-secondary);">
                    <div style="font-size: 4rem; margin-bottom: 24px;">⚡</div>
                    <h3 style="color: var(--kusto-accent); margin-bottom: 16px;">AI-Enhanced Kusto Overlord Ready</h3>
                    <p style="margin-top: 12px;">Enter your KQL query and experience AI-powered analysis with comprehensive standards validation.</p>
                    <p style="margin-top: 8px; color: var(--kusto-gold);">🤖 Google AI Studio Integration Available 🤖</p>
                </div>
            </div>
        </div>
    </div>

    <!-- AI-Powered KQL Assistant Chatbot -->
    <div class="ai-chatbot" id="aiChatbot">
        <div class="chatbot-header" id="chatbotHeader">
            <div class="chatbot-title">
                <span>🤖</span>
                <span>KQL AI Assistant</span>
                <span class="chatbot-status" id="chatbotStatus">Ready</span>
            </div>
            <button class="chatbot-toggle" id="chatbotToggle">−</button>
        </div>
        <div class="chatbot-body" id="chatbotBody">
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="ai-message">
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        <p>Hello! I'm your AI-powered KQL assistant. I can help you with:</p>
                        <ul>
                            <li>🔍 KQL query optimization and best practices</li>
                            <li>🛡️ Security analysis and threat hunting techniques</li>
                            <li>⚡ Performance troubleshooting and improvements</li>
                            <li>📊 Data analysis strategies and methodology</li>
                            <li>🤔 Explaining your analysis results in detail</li>
                        </ul>
                        <p><strong>Ask me anything about KQL!</strong></p>
                    </div>
                </div>
            </div>
            <div class="chatbot-input-area">
                <div class="chatbot-suggestions" id="chatbotSuggestions">
                    <button class="suggestion-chip">How do I optimize this query?</button>
                    <button class="suggestion-chip">Explain the analysis results</button>
                    <button class="suggestion-chip">KQL best practices</button>
                    <button class="suggestion-chip">Security hunting tips</button>
                </div>
                <div class="chatbot-input-container">
                    <input type="text" id="chatbotInput" class="chatbot-input" placeholder="Ask me about KQL, analysis results, or optimization tips...">
                    <button id="chatbotSend" class="chatbot-send">
                        <span>▶</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="kusto-spinner"></div>
            <h3 style="color: var(--kusto-accent); margin-bottom: 12px;">Overlord Analysis In Progress...</h3>
            <p style="color: var(--text-secondary);" id="analysisStatus">Initializing ultimate KQL mastery assessment...</p>
            <div class="analysis-progress">
                <div class="progress-bar" id="analysisProgress" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <script>
        class KustoOverlord {
            constructor() {
                this.currentSettings = {
                    depth: 'overlord',
                    environment: 'sentinel',
                    useCase: 'hunting',
                    aiMode: 'pattern-only'
                };
                
                this.googleAIApiKey = '';
                this.lastAnalysis = null;
                this.chatbotMinimized = false;
                
                this.initializeParticles();
                this.initializeOverlordRules();
                this.initializeEventListeners();
                this.initializeAdvancedFeatures();
                this.initializeAIChatbot();
            }

            initializeParticles() {
                const particles = document.getElementById('particles');
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 20 + 's';
                    particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
                    particles.appendChild(particle);
                }
            }

            initializeOverlordRules() {
                this.overlordRules = {
                    // MICROSOFT SYNTAX & STRUCTURE STANDARDS
                    syntaxStructure: [
                        {
                            pattern: /\|\s*WHERE\s+|\|\s*SUMMARIZE\s+|\|\s*PROJECT\s+|\|\s*EXTEND\s+|\|\s*JOIN\s+/gi,
                            severity: 'medium',
                            title: '📝 CODING STANDARD: Operator Case Sensitivity',
                            description: 'KQL operators should use lowercase following industry coding standards (where, summarize, project).',
                            suggestion: 'STANDARD PRACTICE: Use lowercase operators: where, summarize, project, extend, join',
                            scoreImpact: -8,
                            category: 'Coding Standards',
                            overlordRating: 'CASE CONVENTION VIOLATION',
                            logicalAnalysis: 'Consistent lowercase operators follow KQL style guidelines and improve readability.',
                            microsoftStandard: 'Required for professional code reviews'
                        },
                        {
                            pattern: /;(?!\s*\/\/|\s*$)/g,
                            severity: 'low',
                            title: '🔧 SYNTAX CLEANUP: Unnecessary Semicolons',
                            description: 'KQL does not require semicolons except in let statements. Unnecessary semicolons can cause parsing issues.',
                            suggestion: 'CLEANUP: Remove unnecessary semicolons - KQL uses pipe operators for statement separation',
                            scoreImpact: -5,
                            category: 'Syntax Standards',
                            overlordRating: 'SYNTAX OPTIMIZATION',
                            logicalAnalysis: 'KQL uses declarative syntax with pipes, making semicolons unnecessary in most contexts.'
                        },
                        {
                            pattern: /\/\*[\s\S]*?\*\//g,
                            severity: 'info',
                            title: '💬 DOCUMENTATION EXCELLENCE: Multi-line Comments',
                            description: 'Query uses multi-line comments for comprehensive documentation.',
                            suggestion: 'EXCELLENT: Proper use of /* */ for multi-line documentation following Microsoft standards',
                            scoreImpact: +5,
                            category: 'Documentation',
                            overlordRating: 'DOCUMENTATION MASTERY',
                            logicalAnalysis: 'Multi-line comments enable comprehensive analytical methodology documentation.'
                        },
                        {
                            pattern: /\/\/.*$/gm,
                            severity: 'info',
                            title: '📋 DOCUMENTATION STANDARD: Single-line Comments',
                            description: 'Query uses proper single-line comment syntax for inline documentation.',
                            suggestion: 'MICROSOFT STANDARD: Excellent use of // for inline comments and explanations',
                            scoreImpact: +3,
                            category: 'Documentation',
                            overlordRating: 'COMMENT STANDARD COMPLIANCE',
                            logicalAnalysis: 'Inline comments provide contextual explanations for complex analytical logic.'
                        }
                    ],

                    // MICROSOFT PERFORMANCE & EFFICIENCY CRITERIA
                    performanceEfficiency: [
                        {
                            pattern: /^(?!.*TimeGenerated.*ago\(.*\))/m,
                            test: (query) => !query.match(/TimeGenerated\s*[><=]+\s*ago\([^)]+\)/gi),
                            severity: 'critical',
                            title: '🚨 PERFORMANCE CRITICAL: Missing Time Range Filter',
                            description: 'Query lacks time boundary filtering. This will scan entire table history causing catastrophic performance impact.',
                            suggestion: 'MANDATORY: Add TimeGenerated > ago(Nd) as first filter. This is the #1 performance requirement for production KQL.',
                            scoreImpact: -35,
                            performanceImpact: 'Query may timeout or consume excessive resources',
                            overlordRating: 'PERFORMANCE KILLER - IMMEDIATE ACTION REQUIRED',
                            benchmarkViolation: 'Critical Performance Standard',
                            logicalAnalysis: 'Time filtering is essential for any time-series data analysis in production systems.',
                            microsoftStandard: 'Required - will not pass production review without time filters'
                        },
                        {
                            pattern: /\|\s*where.*\|\s*project/gi,
                            test: (query) => !query.match(/\|\s*project.*\|\s*where/gi),
                            severity: 'info',
                            title: '✅ MICROSOFT BEST PRACTICE: Filter Before Project',
                            description: 'Query correctly filters data before projection, following Microsoft performance guidelines.',
                            suggestion: 'EXCELLENT: Perfect implementation of filter-first principle for optimal performance',
                            scoreImpact: +8,
                            category: 'Performance Excellence',
                            overlordRating: 'MICROSOFT PERFORMANCE STANDARD',
                            logicalAnalysis: 'Filtering before projection reduces data volume and improves query execution efficiency.',
                            microsoftStandard: 'Recommended pattern in Microsoft KQL performance guidelines'
                        },
                        {
                            pattern: /\|\s*project\s+\*/gi,
                            severity: 'high',
                            title: '⚠️ PERFORMANCE WARNING: Wildcard Projection Anti-Pattern',
                            description: 'Using project * defeats the purpose of column selection and impacts performance significantly.',
                            suggestion: 'BEST PRACTICE: Explicitly specify required columns: | project Column1, Column2, Column3',
                            scoreImpact: -18,
                            performanceImpact: 'Unnecessary data transfer and processing overhead',
                            overlordRating: 'PROJECTION ANTI-PATTERN',
                            logicalAnalysis: 'Explicit column selection reduces bandwidth usage and improves query clarity.',
                            microsoftStandard: 'Wildcard projections flagged in professional code reviews'
                        },
                        {
                            pattern: /\|\s*where.*contains.*\*|\.+\*|\*\w+/gi,
                            severity: 'medium',
                            title: '🔍 PERFORMANCE CONCERN: Wildcard Search Pattern',
                            description: 'Wildcard searches can be expensive. Consider if exact matches or indexed column filters would work.',
                            suggestion: 'OPTIMIZATION: Use equality filters on indexed columns when possible for better performance',
                            scoreImpact: -12,
                            performanceImpact: 'Wildcard searches require full table scans',
                            overlordRating: 'INDEX OPTIMIZATION OPPORTUNITY',
                            logicalAnalysis: 'Exact matches can leverage indexing while wildcards require full column scans.',
                            microsoftStandard: 'Prefer indexed column filters over wildcard searches'
                        }
                    ],

                    // LOGIC & SEMANTICS VALIDATION
                    logicSemantics: [
                        {
                            pattern: /\|\s*summarize.*count.*by.*\|\s*where.*count.*==\s*0/gi,
                            severity: 'high',
                            title: '❌ LOGIC ERROR: Impossible Zero Count Filter',
                            description: 'Filtering for count == 0 after summarization will always return empty results. This is a logical impossibility.',
                            suggestion: 'LOGIC FIX: Remove zero count filter or use different aggregation logic to find missing data',
                            scoreImpact: -20,
                            category: 'Logic Validation',
                            overlordRating: 'LOGICAL IMPOSSIBILITY DETECTED',
                            logicalAnalysis: 'Summarized counts cannot be zero since non-existent groups are not included in results.',
                            microsoftStandard: 'Logic validation required for production deployment'
                        },
                        {
                            pattern: /\|\s*join.*on\s+(?!\$left\.|left\.|right\.|\$right\.)/gi,
                            severity: 'medium',
                            title: '🔗 JOIN CLARITY: Missing Table Prefix',
                            description: 'Join conditions should explicitly specify left/right table prefixes for clarity and avoid ambiguity.',
                            suggestion: 'CLARITY: Use $left.Column == $right.Column or left.Column == right.Column in join conditions',
                            scoreImpact: -10,
                            category: 'Query Clarity',
                            overlordRating: 'JOIN SPECIFICATION NEEDED',
                            logicalAnalysis: 'Explicit table prefixes prevent column ambiguity and improve query maintainability.',
                            microsoftStandard: 'Required for complex joins in Microsoft KQL guidelines'
                        },
                        {
                            pattern: /\|\s*extend.*=.*\|\s*project.*(?!\1)/gi,
                            severity: 'low',
                            title: '🎯 EFFICIENCY CHECK: Unused Extended Columns',
                            description: 'Creating extended columns that are not used in subsequent projection may waste compute resources.',
                            suggestion: 'EFFICIENCY: Verify all extended columns are used, or move extend after project if possible',
                            scoreImpact: -5,
                            category: 'Computational Efficiency',
                            overlordRating: 'COMPUTATIONAL WASTE CHECK',
                            logicalAnalysis: 'Computing unused columns wastes CPU cycles and should be optimized for large datasets.',
                            microsoftStandard: 'Efficiency optimization recommended in Microsoft performance guides'
                        },
                        {
                            pattern: /\|\s*where.*(?:isnull|isempty)\s*\(\s*\w+\s*\).*and.*\w+\s*(?:==|!=)/gi,
                            severity: 'info',
                            title: '✅ DATA VALIDATION: Proper Null Handling',
                            description: 'Query correctly handles null values using isnull() or isempty() functions.',
                            suggestion: 'EXCELLENT: Proper null value validation following Microsoft data handling best practices',
                            scoreImpact: +8,
                            category: 'Data Validation',
                            overlordRating: 'NULL HANDLING MASTERY',
                            logicalAnalysis: 'Explicit null checking prevents unexpected results and improves data quality.',
                            microsoftStandard: 'Recommended pattern for production data analysis'
                        }
                    ],

                    // MICROSOFT BEST PRACTICES COMPLIANCE
                    microsoftBestPractices: [
                        {
                            pattern: /\|\s*extend\s+(\w+)\s*=.*\|\s*project.*\1/gi,
                            severity: 'info',
                            title: '🏷️ NAMING EXCELLENCE: Descriptive Column Names',
                            description: 'Query creates well-named custom columns that improve readability and maintainability.',
                            suggestion: 'MICROSOFT STANDARD: Excellent use of descriptive column naming conventions',
                            scoreImpact: +6,
                            category: 'Code Quality',
                            overlordRating: 'NAMING CONVENTION MASTERY',
                            logicalAnalysis: 'Descriptive column names improve query self-documentation and team collaboration.',
                            microsoftStandard: 'Required naming convention in Microsoft development standards'
                        },
                        {
                            pattern: /(?:parse_json|todynamic|tostring|todatetime|toint|toreal)\s*\(/gi,
                            severity: 'info',
                            title: '🔧 FUNCTION MASTERY: Built-in Function Usage',
                            description: 'Query uses built-in KQL functions instead of complex custom logic for data type conversions.',
                            suggestion: 'MICROSOFT EXCELLENCE: Perfect use of built-in functions for optimal performance and reliability',
                            scoreImpact: +10,
                            category: 'Function Usage',
                            overlordRating: 'BUILT-IN FUNCTION EXPERTISE',
                            logicalAnalysis: 'Built-in functions are optimized and tested, providing better performance than custom implementations.',
                            microsoftStandard: 'Preferred approach in Microsoft KQL development guidelines'
                        },
                        {
                            pattern: /\|\s*take\s+(?:[1-9]\d{4,}|\d{6,})/gi,
                            severity: 'medium',
                            title: '📊 RESOURCE EFFICIENCY: Large Result Set Warning',
                            description: 'Taking very large result sets (>10K rows) may impact system resources and user experience.',
                            suggestion: 'MICROSOFT PRACTICE: Consider pagination or summarization for large datasets to improve efficiency',
                            scoreImpact: -12,
                            category: 'Resource Management',
                            overlordRating: 'RESOURCE USAGE OPTIMIZATION',
                            logicalAnalysis: 'Large result sets consume memory and bandwidth, affecting system performance for other users.',
                            microsoftStandard: 'Resource management guideline in Microsoft Sentinel best practices'
                        },
                        {
                            pattern: /let\s+(\w+)\s*=\s*.*;.*\1/gi,
                            severity: 'info',
                            title: '🔄 REUSABILITY EXCELLENCE: Parameter Usage',
                            description: 'Query uses let statements for parameterization, improving reusability and maintainability.',
                            suggestion: 'MICROSOFT MASTERY: Excellent parameterization for reusable and maintainable analytical logic',
                            scoreImpact: +12,
                            category: 'Code Architecture',
                            overlordRating: 'PARAMETERIZATION MASTERY',
                            logicalAnalysis: 'Parameterization enables query reuse and reduces maintenance overhead in analytical workflows.',
                            microsoftStandard: 'Recommended pattern for enterprise KQL development'
                        }
                    ],

                    // RED FLAG SCENARIOS (CRITICAL ISSUES)
                    redFlagScenarios: [
                        {
                            pattern: /cross-cluster|cluster\(/gi,
                            test: (query) => query.includes('cluster(') && !query.match(/TimeGenerated.*ago/gi),
                            severity: 'critical',
                            title: '🚨 RED FLAG: Cross-cluster Query Without Time Filter',
                            description: 'Cross-cluster queries without time boundaries will scan massive datasets and likely timeout.',
                            suggestion: 'IMMEDIATE FIX: Add strict time filters before attempting cross-cluster operations',
                            scoreImpact: -40,
                            category: 'Critical Performance',
                            overlordRating: 'CROSS-CLUSTER PERFORMANCE KILLER',
                            logicalAnalysis: 'Cross-cluster operations amplify performance issues exponentially without proper filtering.',
                            microsoftStandard: 'Critical violation - requires immediate remediation'
                        },
                        {
                            pattern: /\|\s*where.*matches\s+regex|extract.*regex/gi,
                            test: (query) => {
                                const regexMatches = query.match(/matches\s+regex|extract.*regex/gi);
                                const highCardinalityFields = query.match(/Computer|Account|User|Device|IP|URL/gi);
                                return regexMatches && highCardinalityFields;
                            },
                            severity: 'critical',
                            title: '🚨 RED FLAG: Regex on High-Cardinality Fields',
                            description: 'Regular expressions on high-cardinality fields (Computer, Account, IP) cause severe performance degradation.',
                            suggestion: 'IMMEDIATE FIX: Use has, contains, or exact matches instead of regex on indexed fields',
                            scoreImpact: -35,
                            category: 'Critical Performance',
                            overlordRating: 'REGEX PERFORMANCE KILLER',
                            logicalAnalysis: 'Regex operations prevent index usage and require full column scans on large datasets.',
                            microsoftStandard: 'Performance anti-pattern flagged in Microsoft reviews'
                        },
                        {
                            pattern: /SecurityEvent.*\|\s*where.*EventID.*and.*Computer.*and.*Account/gi,
                            test: (query) => !query.match(/TimeGenerated|EventData|Activity/gi),
                            severity: 'medium',
                            title: '🔍 CONTEXT WARNING: Missing Security Context',
                            description: 'Security event queries should include essential context fields for proper analysis.',
                            suggestion: 'SECURITY BEST PRACTICE: Include TimeGenerated, EventData, or Activity for complete security context',
                            scoreImpact: -15,
                            category: 'Security Analysis',
                            overlordRating: 'SECURITY CONTEXT INCOMPLETE',
                            logicalAnalysis: 'Security analysis requires temporal and contextual data for proper threat assessment.',
                            microsoftStandard: 'Security analysis requirement in Microsoft Sentinel guidelines'
                        }
                    ],

                    // DATA GOVERNANCE & PROTECTION (Enhanced with Microsoft standards)
                    dataGovernance: [
                        {
                            pattern: /\|\s*project.*(?:password|secret|key|token|credential|auth|ssn|social|phone|email|ip|address).*|.*(?:password|secret|key|token|credential|auth|ssn|social|phone|email|ip|address).*\|\s*project/gi,
                            severity: 'high',
                            title: '🔒 MICROSOFT DATA GOVERNANCE: Sensitive Data Projection',
                            description: 'Query projects potentially sensitive data fields. This may violate Microsoft data classification policies.',
                            suggestion: 'GOVERNANCE: Review data classification requirements. Consider data masking or hashing for sensitive analytics.',
                            scoreImpact: -20,
                            category: 'Data Protection',
                            overlordRating: 'DATA CLASSIFICATION REVIEW NEEDED',
                            logicalAnalysis: 'Sensitive data projection must align with organizational data governance policies.',
                            microsoftStandard: 'Data classification compliance required in Microsoft environments'
                        },
                        {
                            pattern: /union.*(?:\w+.*,.*){4,}/gi,
                            severity: 'medium',
                            title: '🔄 DATA BOUNDARY: Multi-Table Union Analysis',
                            description: 'Unioning multiple tables may cross data classification boundaries or security contexts.',
                            suggestion: 'VERIFICATION: Ensure all tables have compatible data classifications and access requirements',
                            scoreImpact: -10,
                            category: 'Data Architecture',
                            overlordRating: 'DATA BOUNDARY VERIFICATION',
                            logicalAnalysis: 'Table unions should respect data classification and access control boundaries.',
                            microsoftStandard: 'Data boundary compliance required in enterprise environments'
                        }
                    ],

                    // MICROSOFT QUALITY SCORING INTEGRATION
                    qualityScoring: [
                        {
                            pattern: /let\s+.*=.*\/\/.*purpose|objective|hypothesis/gi,
                            severity: 'info',
                            title: '🏆 PRODUCTION READY: Documented Analytical Purpose',
                            description: 'Query includes clear analytical purpose documentation with parameterization.',
                            suggestion: 'MICROSOFT EXCELLENCE: Production-ready query with clear purpose and proper architecture',
                            scoreImpact: +15,
                            category: 'Production Quality',
                            overlordRating: 'PRODUCTION EXCELLENCE',
                            logicalAnalysis: 'Clear purpose documentation enables analytical validation and knowledge transfer.',
                            microsoftStandard: 'Production readiness standard in Microsoft analytical frameworks'
                        },
                        {
                            pattern: /\|\s*summarize.*(?:percentile|stdev|variance).*by.*bin\s*\(\s*TimeGenerated/gi,
                            severity: 'info',
                            title: '📊 ADVANCED ANALYTICS: Statistical Time Series',
                            description: 'Query demonstrates advanced statistical analysis with proper temporal binning.',
                            suggestion: 'STATISTICAL MASTERY: Excellent implementation of time-series statistical analysis',
                            scoreImpact: +18,
                            category: 'Advanced Analytics',
                            overlordRating: 'STATISTICAL ANALYTICS MASTERY',
                            logicalAnalysis: 'Statistical time-series analysis enables advanced pattern detection and anomaly identification.',
                            microsoftStandard: 'Advanced analytics pattern in Microsoft data science guidelines'
                        }
                    ]
                };

                // Enhanced table knowledge with Microsoft standards
                this.tableKnowledge = {

                    // PERFORMANCE EXCELLENCE ENGINE
                    performanceOptimization: [
                        {
                            pattern: /^(?!.*TimeGenerated.*ago\(.*\))/m,
                            test: (query) => !query.match(/TimeGenerated\s*[><=]+\s*ago\([^)]+\)/gi),
                            severity: 'critical',
                            title: '⚡ PERFORMANCE CRITICAL: Missing Time Boundary',
                            description: 'No time filter detected. KQL will scan the entire table history, causing exponential performance degradation and high costs.',
                            suggestion: 'MANDATORY FIX: Add TimeGenerated > ago(Nd) as your first filter. This is the #1 performance rule in KQL.',
                            scoreImpact: -30,
                            performanceImpact: 'Could be 1000x slower without time filtering',
                            overlordRating: 'PERFORMANCE KILLER - IMMEDIATE ACTION REQUIRED',
                            benchmarkViolation: 'Microsoft Critical Performance Standard',
                            logicalAnalysis: 'Time filtering is essential for any time-series data analysis in production systems.'
                        },
                        {
                            pattern: /\|\s*extend.*\|\s*where/gi,
                            severity: 'high',
                            title: '🚀 PERFORMANCE OPTIMIZATION: Compute-Before-Filter Pattern',
                            description: 'Computing extended columns before filtering processes unnecessary data. This wastes compute resources on rows that will be discarded.',
                            suggestion: 'OPTIMIZATION: Move WHERE clauses before EXTEND operations. Filter first, compute second for maximum efficiency.',
                            scoreImpact: -18,
                            performanceImpact: '3-8x performance improvement possible',
                            overlordRating: 'COMPUTE EFFICIENCY OPPORTUNITY',
                            logicalAnalysis: 'Filtering reduces data volume before expensive computations, following optimal query execution principles.'
                        },
                        {
                            pattern: /\|\s*order\s+by.*(?!\|\s*top)\|\s*take/gi,
                            severity: 'medium',
                            title: '📈 PERFORMANCE PATTERN: Sort-Then-Limit Anti-Pattern',
                            description: 'ORDER BY followed by TAKE forces full dataset sorting before limiting results. This is computationally expensive.',
                            suggestion: 'ELITE TECHNIQUE: Use | top N by Column [asc|desc] for dramatically better performance on large datasets.',
                            scoreImpact: -15,
                            performanceImpact: '2-10x faster execution with top operator',
                            overlordRating: 'SORTING OPTIMIZATION AVAILABLE',
                            logicalAnalysis: 'Top-N operations are mathematically more efficient than sort-then-limit for partial result sets.'
                        },
                        {
                            pattern: /\|\s*summarize.*\|\s*where.*count|dcount/gi,
                            severity: 'medium',
                            title: '🎯 PERFORMANCE LOGIC: Post-Aggregation Filtering',
                            description: 'Filtering after summarization processes more data than necessary and may not represent optimal analytical logic.',
                            suggestion: 'ADVANCED OPTIMIZATION: Use conditional aggregation with countif() or filter before grouping for better performance.',
                            scoreImpact: -12,
                            performanceImpact: '2-5x improvement with conditional aggregation',
                            overlordRating: 'AGGREGATION PATTERN OPTIMIZATION',
                            logicalAnalysis: 'Pre-aggregation filtering reduces computational load and often represents clearer analytical intent.'
                        },
                        {
                            pattern: /\|\s*project\s+\*/gi,
                            severity: 'medium',
                            title: '📋 RESOURCE EFFICIENCY: Wildcard Projection Impact',
                            description: 'Projecting all columns increases data transfer costs and processing overhead, especially with large tables.',
                            suggestion: 'PRECISION: Explicitly specify only required columns for optimal performance and clearer query intent.',
                            scoreImpact: -10,
                            performanceImpact: 'Reduced bandwidth and faster processing',
                            overlordRating: 'PROJECTION SPECIFICITY NEEDED',
                            logicalAnalysis: 'Explicit column selection improves query readability and reduces resource consumption.'
                        }
                    ],

                    // QUERY LOGIC & REASONING EXCELLENCE
                    queryLogic: [
                        {
                            pattern: /\|\s*where.*=\s*""\s*$|=\s*''\s*$/gm,
                            severity: 'medium',
                            title: '🧠 LOGIC PRECISION: Empty String Logic',
                            description: 'Comparing to empty strings in KQL may not behave as expected. Empty vs null handling requires specific functions.',
                            suggestion: 'LOGICAL PRECISION: Use isempty() or isnotempty() functions for explicit null/empty checking with predictable behavior.',
                            scoreImpact: -8,
                            overlordRating: 'LOGICAL CLARITY IMPROVEMENT',
                            logicalAnalysis: 'Explicit empty/null checking functions provide clearer intent and more predictable results than string comparisons.'
                        },
                        {
                            pattern: /\|\s*where.*contains\s+"/gi,
                            severity: 'low',
                            title: '🔤 LOGIC CONSIDERATION: Case-Sensitive Matching',
                            description: 'contains() operator is case-sensitive. Verify this matches your analytical intent for string comparisons.',
                            suggestion: 'INTENT VERIFICATION: Consider has, has_any, or contains_cs vs contains based on your specific matching requirements.',
                            scoreImpact: -3,
                            overlordRating: 'STRING MATCHING PRECISION',
                            logicalAnalysis: 'Case sensitivity choice should align with the analytical goal - security analysis often needs exact matches.'
                        },
                        {
                            pattern: /\|\s*join.*on\s+\$left\.\w+\s*==\s*\$right\.\w+.*\|\s*project.*\$left.*\$right/gi,
                            severity: 'info',
                            title: '🔗 LOGIC EXCELLENCE: Proper Join Implementation',
                            description: 'Well-structured join with explicit left/right projections. This demonstrates good relational logic understanding.',
                            suggestion: 'EXCELLENT PRACTICE: Clear join logic with proper column prefixing shows advanced KQL engineering.',
                            scoreImpact: +8,
                            overlordRating: 'RELATIONAL LOGIC MASTERY',
                            logicalAnalysis: 'Explicit join column specification and projection clarity indicates sophisticated data relationship understanding.'
                        },
                        {
                            pattern: /let\s+\w+\s*=.*;\s*let\s+\w+\s*=.*;\s*\w+.*\|\s*join.*\w+/gi,
                            severity: 'info',
                            title: '🏗️ ARCHITECTURAL EXCELLENCE: Modular Query Design',
                            description: 'Query uses variables and modular design patterns. This demonstrates excellent analytical architecture.',
                            suggestion: 'OVERLORD LEVEL: Outstanding modular design for maintainable, reusable analytical logic.',
                            scoreImpact: +12,
                            overlordRating: 'ARCHITECTURAL MASTERY',
                            logicalAnalysis: 'Modular design with variables shows advanced planning and creates reusable, maintainable analytical components.'
                        }
                    ],

                    // ANALYTICAL INTELLIGENCE & BEST PRACTICES
                    analyticalIntelligence: [
                        {
                            pattern: /^(?!.*\/\/).*$/m,
                            test: (query) => !query.includes('//') && query.length > 150,
                            severity: 'medium',
                            title: '📚 MAINTAINABILITY: Documentation Gap',
                            description: 'Complex queries without documentation create knowledge gaps and maintenance challenges for teams.',
                            suggestion: 'BEST PRACTICE: Add comments explaining analytical purpose, methodology, and expected outcomes for team collaboration.',
                            scoreImpact: -10,
                            overlordRating: 'KNOWLEDGE TRANSFER IMPROVEMENT',
                            logicalAnalysis: 'Documentation serves as analytical methodology record and enables team knowledge sharing.'
                        },
                        {
                            pattern: /let\s+\w+\s*=/gi,
                            test: (query) => query.match(/let\s+\w+\s*=/gi),
                            severity: 'info',
                            title: '✨ EXCELLENCE: Variable Usage Mastery',
                            description: 'Proper use of let statements demonstrates advanced KQL engineering and analytical planning.',
                            suggestion: 'OUTSTANDING: Excellent variable usage creates maintainable, readable, and reusable analytical logic.',
                            scoreImpact: +10,
                            overlordRating: 'ENGINEERING EXCELLENCE',
                            logicalAnalysis: 'Variables enable complex analytical workflows and demonstrate sophisticated query architecture planning.'
                        },
                        {
                            pattern: /\/\/.*(?:hypothesis|detection|purpose|objective|methodology)/gi,
                            severity: 'info',
                            title: '🎯 ANALYTICAL MASTERY: Strategic Documentation',
                            description: 'Query includes strategic analytical context and methodology documentation.',
                            suggestion: 'OVERLORD LEVEL: Perfect analytical documentation showing clear methodology and strategic intent.',
                            scoreImpact: +15,
                            overlordRating: 'ANALYTICAL METHODOLOGY MASTERY',
                            logicalAnalysis: 'Strategic documentation indicates hypothesis-driven analysis and scientific approach to security research.'
                        },
                        {
                            pattern: /bin\s*\(\s*TimeGenerated\s*,\s*\d+[smhd]\s*\)/gi,
                            severity: 'info',
                            title: '📊 TEMPORAL INTELLIGENCE: Time Binning Excellence',
                            description: 'Intelligent time binning for temporal analysis. This shows advanced time-series analytical understanding.',
                            suggestion: 'ADVANCED TECHNIQUE: Excellent use of temporal binning for trend analysis and pattern detection.',
                            scoreImpact: +8,
                            overlordRating: 'TEMPORAL ANALYSIS MASTERY',
                            logicalAnalysis: 'Time binning enables trend analysis and pattern recognition in time-series security data.'
                        }
                    ],

                    // ADVANCED TECHNIQUE MASTERY
                    advancedTechniques: [
                        {
                            pattern: /materialize\s*\(/gi,
                            severity: 'info',
                            title: '🚀 ADVANCED MASTERY: Query Materialization',
                            description: 'Advanced optimization using materialize() for complex query performance enhancement.',
                            suggestion: 'ELITE TECHNIQUE: Excellent use of materialization for subquery optimization and performance tuning.',
                            scoreImpact: +15,
                            overlordRating: 'ADVANCED OPTIMIZATION MASTERY',
                            logicalAnalysis: 'Materialization demonstrates understanding of query execution optimization for complex analytical workflows.'
                        },
                        {
                            pattern: /mv-expand|mv-apply/gi,
                            severity: 'info',
                            title: '🎭 ADVANCED MASTERY: Multi-Value Processing',
                            description: 'Sophisticated handling of complex data structures with multi-value operators.',
                            suggestion: 'EXPERT LEVEL: Outstanding data structure manipulation showing deep KQL understanding.',
                            scoreImpact: +18,
                            overlordRating: 'DATA ENGINEERING EXCELLENCE',
                            logicalAnalysis: 'Multi-value operations indicate advanced understanding of nested data structures and array processing.'
                        },
                        {
                            pattern: /join\s+kind=(?:leftouter|rightouter|fullouter|leftanti|rightanti|leftantisemi|rightantisemi)/gi,
                            severity: 'info',
                            title: '🔗 ADVANCED MASTERY: Sophisticated Join Strategies',
                            description: 'Advanced join operations demonstrating deep relational data understanding.',
                            suggestion: 'OVERLORD EXPERTISE: Advanced join techniques for comprehensive data relationship analysis.',
                            scoreImpact: +20,
                            overlordRating: 'RELATIONAL MASTERY',
                            logicalAnalysis: 'Complex joins show sophisticated understanding of data relationships and set theory operations.'
                        },
                        {
                            pattern: /parse|extract_all|split|substring|trim|replace/gi,
                            severity: 'info',
                            title: '📝 ADVANCED MASTERY: Text Processing Excellence',
                            description: 'Advanced string manipulation and text processing techniques for data extraction.',
                            suggestion: 'EXPERT SKILL: Sophisticated text processing for data normalization and extraction.',
                            scoreImpact: +12,
                            overlordRating: 'TEXT PROCESSING EXCELLENCE',
                            logicalAnalysis: 'Text processing operations indicate advanced data cleansing and extraction methodology.'
                        },
                        {
                            pattern: /pack_array|pack|bag_pack|dynamic|todynamic|tostring|parse_json/gi,
                            severity: 'info',
                            title: '🏗️ ADVANCED MASTERY: Dynamic Data Architecture',
                            description: 'Advanced dynamic data structuring and JSON manipulation for complex analytics.',
                            suggestion: 'ARCHITECTURAL EXCELLENCE: Expert-level dynamic data structure design and manipulation.',
                            scoreImpact: +16,
                            overlordRating: 'ARCHITECTURAL MASTERY',
                            logicalAnalysis: 'Dynamic data operations show advanced understanding of schema-less data processing and JSON analytics.'
                        },
                        {
                            pattern: /arg_max|arg_min|percentile|percentiles|stdev|variance/gi,
                            severity: 'info',
                            title: '📊 STATISTICAL MASTERY: Advanced Analytics Functions',
                            description: 'Use of sophisticated statistical functions for advanced analytical insights.',
                            suggestion: 'STATISTICAL EXCELLENCE: Advanced statistical analysis demonstrating analytical sophistication.',
                            scoreImpact: +14,
                            overlordRating: 'STATISTICAL ANALYTICS MASTERY',
                            logicalAnalysis: 'Statistical functions indicate advanced analytical methodology and mathematical understanding.'
                        }
                    ],

                    // SECURITY & THREAT INTELLIGENCE
                    securityIntelligence: [
                        {
                            pattern: /SecurityEvent.*EventID.*(?:4624|4625|4688|4672|4648|4656|4657|4658|4663|4670|4719|4720|4722|4724|4725|4728|4732|4735|4738|4740|4767|4768|4769|4771|4776)/gi,
                            severity: 'info',
                            title: '🛡️ SECURITY MASTERY: Critical Event Analysis',
                            description: 'Query targets high-value security events for threat detection and incident analysis.',
                            suggestion: 'SECURITY EXPERTISE: Excellent focus on authentication, privilege escalation, and access events.',
                            scoreImpact: +12,
                            overlordRating: 'SECURITY ANALYTICS MASTERY',
                            logicalAnalysis: 'Specific security event targeting shows understanding of Windows security logging and threat patterns.'
                        },
                        {
                            pattern: /SigninLogs.*(?:ResultType|ConditionalAccessStatus|RiskLevelDuringSignIn|RiskLevelAggregated|RiskState)/gi,
                            severity: 'info',
                            title: '🔐 IDENTITY MASTERY: Advanced Identity Analytics',
                            description: 'Sophisticated identity and access management analytics with risk assessment.',
                            suggestion: 'IDENTITY EXPERTISE: Advanced sign-in behavior analysis with risk correlation.',
                            scoreImpact: +15,
                            overlordRating: 'IDENTITY SECURITY MASTERY',
                            logicalAnalysis: 'Risk-based identity analysis demonstrates understanding of modern authentication security patterns.'
                        },
                        {
                            pattern: /DeviceEvents.*ActionType.*(?:ProcessCreated|NetworkConnectionInitiated|FileCreated|RegistryValueSet|PowerShellCommand|ScriptContent)/gi,
                            severity: 'info',
                            title: '🖥️ ENDPOINT MASTERY: Advanced Endpoint Analytics',
                            description: 'Comprehensive endpoint security monitoring and behavioral analysis.',
                            suggestion: 'ENDPOINT EXPERTISE: Advanced endpoint detection and response analytical techniques.',
                            scoreImpact: +18,
                            overlordRating: 'ENDPOINT SECURITY MASTERY',
                            logicalAnalysis: 'Endpoint behavior analysis shows understanding of attack vectors and system monitoring strategies.'
                        }
                    ],

                    // QUERY ARCHITECTURE & DESIGN PATTERNS
                    architecturePatterns: [
                        {
                            pattern: /(?:let\s+\w+\s*=.*;\s*){2,}.*\w+.*\|\s*(?:join|union)/gi,
                            severity: 'info',
                            title: '🏛️ ARCHITECTURAL EXCELLENCE: Modular Design Pattern',
                            description: 'Query uses modular architecture with variables and complex operations.',
                            suggestion: 'OVERLORD ARCHITECTURE: Outstanding modular design for scalable analytical workflows.',
                            scoreImpact: +20,
                            overlordRating: 'ARCHITECTURAL DESIGN MASTERY',
                            logicalAnalysis: 'Modular architecture demonstrates advanced planning and creates maintainable analytical systems.'
                        },
                        {
                            pattern: /\/\/.*(?:step\s*\d+|phase\s*\d+|part\s*\d+)/gi,
                            severity: 'info',
                            title: '📋 METHODOLOGY EXCELLENCE: Structured Analytical Process',
                            description: 'Query documentation shows structured, step-by-step analytical methodology.',
                            suggestion: 'METHODOLOGICAL MASTERY: Perfect analytical process documentation and structured thinking.',
                            scoreImpact: +12,
                            overlordRating: 'ANALYTICAL METHODOLOGY EXCELLENCE',
                            logicalAnalysis: 'Structured process documentation indicates systematic analytical approach and knowledge transfer capability.'
                        },
                        {
                            pattern: /(?:summarize|count|dcount|avg|sum|max|min|percentile).*by.*TimeGenerated.*bin/gi,
                            severity: 'info',
                            title: '📈 TEMPORAL MASTERY: Time-Series Analytics Excellence',
                            description: 'Advanced time-series aggregation with temporal binning for trend analysis.',
                            suggestion: 'TEMPORAL EXPERTISE: Excellent time-series analytical design for pattern detection.',
                            scoreImpact: +14,
                            overlordRating: 'TEMPORAL ANALYTICS MASTERY',
                            logicalAnalysis: 'Time-based aggregation shows understanding of temporal patterns and trend analysis methodologies.'
                        }
                    ]
                };

                // Enhanced table knowledge with logical context
                this.tableKnowledge = {
                    'SecurityEvent': {
                        commonColumns: ['TimeGenerated', 'Computer', 'Account', 'EventID', 'Activity', 'LogonType'],
                        indexedColumns: ['TimeGenerated', 'Computer', 'EventID', 'Account'],
                        performanceTips: 'CRITICAL: Always filter by TimeGenerated first, then EventID for optimal performance',
                        securityConsiderations: 'Contains PII in Account fields - ensure proper data handling',
                        overlordAdvice: 'EventID 4624=successful logon, 4625=failed logon, 4688=process creation, 4672=special privileges'
                    },
                    'SigninLogs': {
                        commonColumns: ['TimeGenerated', 'UserPrincipalName', 'ResultType', 'IPAddress', 'Location', 'ConditionalAccessStatus'],
                        indexedColumns: ['TimeGenerated', 'UserPrincipalName', 'ResultType', 'IPAddress'],
                        performanceTips: 'CRITICAL: Filter by TimeGenerated and ResultType (0=success, 50126=error) for speed',
                        securityConsiderations: 'Contains PII in UserPrincipalName and location data',
                        overlordAdvice: 'ResultType patterns: 0=success, 50126=invalid username/password, 50053=account locked'
                    },
                    'DeviceEvents': {
                        commonColumns: ['TimeGenerated', 'DeviceName', 'ActionType', 'InitiatingProcessFileName', 'ProcessCommandLine'],
                        indexedColumns: ['TimeGenerated', 'DeviceName', 'ActionType', 'InitiatingProcessFileName'],
                        performanceTips: 'CRITICAL: Use ActionType filter early for dramatic performance gains',
                        securityConsiderations: 'ProcessCommandLine may contain sensitive data',
                        overlordAdvice: 'Key ActionTypes: ProcessCreated, NetworkConnectionInitiated, FileCreated, RegistryValueSet'
                    }
                };
            }

            initializeEventListeners() {
                document.getElementById('analyzeButton').addEventListener('click', () => this.unleashOverlordAnalysis());
                
                // Enhanced settings handlers
                ['analysisDepth', 'targetEnv', 'useCase', 'aiMode'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        this.currentSettings[id.replace(/([A-Z])/g, '_$1').toLowerCase()] = e.target.value;
                        this.updateAnalysisPreview();
                        
                        // Show/hide API key section based on AI mode
                        if (id === 'aiMode') {
                            const apiKeySection = document.getElementById('apiKeySection');
                            const showApiKey = e.target.value !== 'pattern-only';
                            apiKeySection.style.display = showApiKey ? 'block' : 'none';
                        }
                    });
                });

                // API key handler
                document.getElementById('apiKey').addEventListener('change', (e) => {
                    this.googleAIApiKey = e.target.value;
                    this.updateChatbotStatus();
                });

                // Real-time analysis hints
                document.getElementById('kqlEditor').addEventListener('input', 
                    this.debounce(() => this.provideOverlordHints(), 800)
                );
            }

            initializeAIChatbot() {
                // Chatbot toggle
                document.getElementById('chatbotToggle').addEventListener('click', () => {
                    this.toggleChatbot();
                });

                document.getElementById('chatbotHeader').addEventListener('click', () => {
                    this.toggleChatbot();
                });

                // Send message
                document.getElementById('chatbotSend').addEventListener('click', () => {
                    this.sendChatMessage();
                });

                document.getElementById('chatbotInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendChatMessage();
                    }
                });

                // Suggestion chips
                document.querySelectorAll('.suggestion-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        document.getElementById('chatbotInput').value = e.target.textContent;
                        this.sendChatMessage();
                    });
                });

                this.updateChatbotStatus();
            }

            toggleChatbot() {
                const chatbot = document.getElementById('aiChatbot');
                const toggle = document.getElementById('chatbotToggle');
                
                this.chatbotMinimized = !this.chatbotMinimized;
                
                if (this.chatbotMinimized) {
                    chatbot.classList.add('minimized');
                    toggle.textContent = '+';
                } else {
                    chatbot.classList.remove('minimized');
                    toggle.textContent = '−';
                }
            }

            updateChatbotStatus() {
                const status = document.getElementById('chatbotStatus');
                if (!status) return;
                
                const hasApiKey = this.googleAIApiKey && this.googleAIApiKey.length > 0;
                const aiMode = this.currentSettings.aiMode;
                
                if (aiMode === 'pattern-only') {
                    status.textContent = 'Pattern Analysis';
                    status.style.background = 'rgba(100, 149, 237, 0.3)';
                } else if (hasApiKey) {
                    status.textContent = 'AI Ready';
                    status.style.background = 'rgba(0, 255, 135, 0.3)';
                } else {
                    status.textContent = 'API Key Needed';
                    status.style.background = 'rgba(255, 165, 0, 0.3)';
                }
            }

            async sendChatMessage() {
                const input = document.getElementById('chatbotInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                input.value = '';
                this.addChatMessage(message, 'user');
                
                // Show typing indicator
                this.showTypingIndicator();
                
                try {
                    let response;
                    if (this.googleAIApiKey && this.currentSettings.aiMode !== 'pattern-only') {
                        response = await this.getAIResponse(message);
                    } else {
                        response = this.getPatternBasedResponse(message);
                    }
                    
                    this.hideTypingIndicator();
                    this.addChatMessage(response, 'ai');
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addChatMessage('Sorry, I encountered an error. Please check your API key and try again.', 'ai');
                    console.error('AI Response error:', error);
                }
            }

            addChatMessage(message, sender) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'user' ? 'user-message' : 'ai-message';
                
                const avatar = sender === 'user' ? '👤' : '🤖';
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-content">
                        ${this.formatMessageContent(message)}
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            formatMessageContent(content) {
                // Convert markdown-like formatting to HTML
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px;">$1</code>')
                    .replace(/\n/g, '<br>');
            }

            showTypingIndicator() {
                const messagesContainer = document.getElementById('chatbotMessages');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'ai-message';
                typingDiv.id = 'typing-indicator';
                
                typingDiv.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="message-content ai-thinking">
                        <span>Thinking</span>
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            async getAIResponse(message) {
                const context = this.buildAIContext(message);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.googleAIApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: context
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024,
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            buildAIContext(userMessage) {
                let context = `You are an expert KQL (Kusto Query Language) assistant helping users with Azure Sentinel, Log Analytics, and security data analysis. 

Your expertise includes:
- KQL syntax, operators, and functions
- Performance optimization and best practices  
- Security analysis and threat hunting
- Data visualization and reporting
- Troubleshooting and debugging queries

User's question: ${userMessage}

`;

                // Add current query context if available
                const currentQuery = document.getElementById('kqlEditor').value.trim();
                if (currentQuery) {
                    context += `\nCurrent KQL query being analyzed:\n\`\`\`kql\n${currentQuery}\n\`\`\`\n`;
                }

                // Add analysis results context if available
                if (this.lastAnalysis) {
                    context += `\nLatest analysis results:
- Overall Score: ${this.lastAnalysis.overallScore}/100
- Grade: ${this.lastAnalysis.grade}
- Total Issues: ${this.lastAnalysis.issues.length}
- Security Risk: ${this.lastAnalysis.securityRisk?.level || 'Unknown'}
- Performance Score: ${this.lastAnalysis.performancePrediction?.score || 'Unknown'}

Key issues found: ${this.lastAnalysis.issues.slice(0, 3).map(i => i.title).join(', ')}
`;
                }

                context += `\nProvide helpful, accurate, and actionable advice. Include specific KQL examples when relevant. Keep responses concise but informative.`;

                return context;
            }

            getPatternBasedResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // Pattern-based responses for common queries
                if (lowerMessage.includes('optimize') || lowerMessage.includes('performance')) {
                    return `**KQL Performance Tips:**

1. **Always use time filters**: \`TimeGenerated > ago(1d)\`
2. **Filter early**: Put WHERE clauses as early as possible
3. **Limit columns**: Use \`project\` to select only needed columns
4. **Use indexed columns**: Filter on Computer, EventID, etc.
5. **Avoid wildcards**: Use \`has\` instead of \`contains\` when possible

**Example:**
\`\`\`kql
SecurityEvent
| where TimeGenerated > ago(1d)  // Filter first
| where EventID == 4624          // Use indexed column
| project TimeGenerated, Computer, Account  // Limit columns
\`\`\``;
                }
                
                if (lowerMessage.includes('security') || lowerMessage.includes('threat') || lowerMessage.includes('hunting')) {
                    return `**Security Analysis Best Practices:**

🔍 **Threat Hunting Approach:**
- Start with hypothesis-driven analysis
- Use statistical baselines for anomaly detection
- Correlate multiple data sources
- Document your methodology

🛡️ **Common Security Queries:**
- Failed logins: \`SecurityEvent | where EventID == 4625\`
- Process creation: \`SecurityEvent | where EventID == 4688\`
- Network connections: \`DeviceNetworkEvents\`

⚡ **Advanced Techniques:**
- Use \`summarize\` for aggregation and counting
- Apply \`bin()\` for time-based analysis
- Leverage \`join\` for correlation analysis`;
                }
                
                if (lowerMessage.includes('explain') || lowerMessage.includes('results')) {
                    if (this.lastAnalysis) {
                        return `**Your Analysis Results Explained:**

📊 **Overall Score:** ${this.lastAnalysis.overallScore}/100 (${this.lastAnalysis.grade})

🔍 **Key Findings:**
${this.lastAnalysis.issues.slice(0, 3).map(issue => 
                            `• **${issue.title}**: ${issue.description.substring(0, 100)}...`
                        ).join('\n')}

🎯 **Top Recommendations:**
${this.lastAnalysis.recommendations?.slice(0, 2).join('\n• ') || 'No specific recommendations'}

Would you like me to explain any specific issue in more detail?`;
                    } else {
                        return "Please run an analysis first, then I can explain the results in detail!";
                    }
                }
                
                if (lowerMessage.includes('best practices') || lowerMessage.includes('standards')) {
                    return `**KQL Best Practices & Standards:**

📝 **Syntax Standards:**
- Use lowercase operators: \`where\`, \`summarize\`, \`project\`
- Add comments with \`//\` for documentation
- Use descriptive column names

⚡ **Performance Standards:**
- Always include time filters
- Filter before extending or projecting
- Use \`top\` instead of \`order by | take\`

🔒 **Security Standards:**
- Don't project sensitive data unnecessarily
- Validate data types and handle nulls
- Use parameterized queries for reusability

🏗️ **Architecture Standards:**
- Use \`let\` statements for complex queries
- Break complex logic into steps
- Document analytical methodology`;
                }
                
                // Default response
                return `I'm here to help with KQL queries and analysis! I can assist with:

🔧 **Query Optimization** - Making your queries faster and more efficient
🛡️ **Security Analysis** - Threat hunting and detection techniques  
📊 **Data Analysis** - Statistical analysis and visualization
🐛 **Troubleshooting** - Fixing syntax errors and logic issues
📚 **Best Practices** - Following industry standards and conventions

Try asking about specific topics like "optimize my query", "security best practices", or "explain the analysis results"!`;
            }

            initializeAdvancedFeatures() {
                // Initialize comprehensive analysis components
                this.overlordBenchmarks = this.initializeBenchmarks();
                this.performancePredictor = this.initializePerformancePredictor();
            }

            initializeBenchmarks() {
                return {
                    microsoftStandard: true,
                    industryStandard: true,
                    overlordStandard: true
                };
            }

            initializePerformancePredictor() {
                return {
                    enabled: true,
                    models: ['performance', 'cost', 'runtime']
                };
            }

            async unleashOverlordAnalysis() {
                const query = document.getElementById('kqlEditor').value.trim();
                
                if (!query) {
                    this.showOverlordAlert('⚡ OVERLORD REQUIRES INPUT ⚡', 'Please provide a KQL query for ultimate analysis.');
                    return;
                }

                this.showLoading();

                try {
                    await this.performOverlordAnalysis(query);
                } catch (error) {
                    console.error('Overlord analysis failed:', error);
                    this.showOverlordAlert('🚨 OVERLORD ERROR 🚨', 'Analysis failed. The Overlord demands better input.');
                } finally {
                    this.hideLoading();
                }
            }

            async performOverlordAnalysis(query) {
                const overlordSteps = [
                    { name: 'Overlord Query Parsing & Validation', duration: 700 },
                    { name: 'Security Vulnerability Deep Scan', duration: 900 },
                    { name: 'Performance Pattern Analysis Matrix', duration: 1000 },
                    { name: 'Best Practices Mastery Assessment', duration: 800 },
                    { name: 'Table Schema Intelligence Analysis', duration: 600 },
                    { name: 'Advanced Technique Recognition', duration: 700 },
                    { name: 'Environment-Specific Optimization', duration: 500 },
                    { name: 'Use Case Strategic Evaluation', duration: 600 },
                    { name: 'AI-Powered Insight Generation', duration: 800 },
                    { name: 'Overlord Mastery Scoring', duration: 900 }
                ];

                let progress = 0;
                const progressBar = document.getElementById('analysisProgress');
                const statusElement = document.getElementById('analysisStatus');

                for (const step of overlordSteps) {
                    statusElement.textContent = step.name + '...';
                    await this.delay(step.duration);
                    progress += 100 / overlordSteps.length;
                    progressBar.style.width = progress + '%';
                }

                // Perform pattern-based analysis
                const analysis = this.performOverlordComprehensiveAnalysis(query);
                
                // Add AI insights if available
                if (this.googleAIApiKey && this.currentSettings.aiMode !== 'pattern-only') {
                    statusElement.textContent = 'Generating AI-Enhanced Insights...';
                    try {
                        analysis.aiInsights = await this.generateAIInsights(query, analysis);
                        analysis.aiEnhanced = true;
                    } catch (error) {
                        console.error('AI insights failed:', error);
                        analysis.aiInsights = ['AI insights unavailable - check API key'];
                        analysis.aiEnhanced = false;
                    }
                } else {
                    analysis.aiInsights = ['Enable AI mode and add API key for enhanced insights'];
                    analysis.aiEnhanced = false;
                }
                
                // Store for chatbot context
                this.lastAnalysis = analysis;
                
                this.displayOverlordResults(analysis);
            }

            async generateAIInsights(query, analysis) {
                const aiContext = `You are an expert KQL analyst. Analyze this query and provide 3-5 specific, actionable insights.

Query:
\`\`\`kql
${query}
\`\`\`

Analysis Results:
- Score: ${analysis.overallScore}/100
- Issues found: ${analysis.issues.length}
- Security risk: ${analysis.securityRisk?.level}
- Performance score: ${analysis.performancePrediction?.score}

Top issues:
${analysis.issues.slice(0, 3).map(i => `- ${i.title}: ${i.description}`).join('\n')}

Provide specific insights about:
1. Code quality and architecture
2. Performance optimization opportunities  
3. Security considerations
4. Best practice improvements
5. Advanced techniques that could be applied

Format as JSON array of insight objects with "title" and "description" fields. Keep descriptions concise and actionable.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.googleAIApiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: aiContext
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.3,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 1024,
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`AI API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    
                    // Try to parse as JSON, fallback to text parsing
                    try {
                        return JSON.parse(aiResponse);
                    } catch {
                        // Fallback: parse text response into insights
                        return this.parseAITextResponse(aiResponse);
                    }
                } catch (error) {
                    console.error('AI insights generation failed:', error);
                    return ['AI analysis unavailable - please check your API key and internet connection'];
                }
            }

            parseAITextResponse(text) {
                const insights = [];
                const lines = text.split('\n').filter(line => line.trim());
                
                let currentInsight = null;
                for (const line of lines) {
                    if (line.match(/^\d+\.|^-|\*/) && line.length > 10) {
                        if (currentInsight) insights.push(currentInsight);
                        currentInsight = {
                            title: line.replace(/^\d+\.\s*|\*\s*|-\s*/, '').split(':')[0],
                            description: line.replace(/^\d+\.\s*|\*\s*|-\s*/, '')
                        };
                    } else if (currentInsight && line.trim()) {
                        currentInsight.description += ' ' + line.trim();
                    }
                }
                if (currentInsight) insights.push(currentInsight);
                
                return insights.slice(0, 5); // Limit to 5 insights
            }

            performOverlordComprehensiveAnalysis(query) {
                let score = 100;
                const issues = [];
                const categories = {
                    security: { score: 100, issues: [], weight: 0.25 },
                    performance: { score: 100, issues: [], weight: 0.30 },
                    syntax: { score: 100, issues: [], weight: 0.15 },
                    bestPractices: { score: 100, issues: [], weight: 0.15 },
                    advanced: { score: 100, issues: [], weight: 0.10 },
                    environment: { score: 100, issues: [], weight: 0.05 }
                };

                // Apply overlord-level rules
                this.applyOverlordRules(query, issues, categories);

                // Environment-specific overlord analysis
                this.applyEnvironmentOverlordRules(query, issues, categories);

                // Use case overlord analysis
                this.applyUseCaseOverlordRules(query, issues, categories);

                // Calculate weighted score
                score = this.calculateWeightedOverlordScore(categories);

                // Advanced query complexity analysis
                const complexity = this.calculateAdvancedComplexity(query);
                
                // Security risk assessment
                const securityRisk = this.assessSecurityRisk(query, issues);
                
                // Performance prediction
                const performancePrediction = this.predictQueryPerformance(query);

                return {
                    overallScore: Math.round(score),
                    grade: this.calculateOverlordGrade(score),
                    categories: categories,
                    issues: issues.sort((a, b) => this.getSeverityWeight(b.severity) - this.getSeverityWeight(a.severity)),
                    queryMetrics: this.calculateAdvancedQueryMetrics(query),
                    recommendations: this.generateOverlordRecommendations(query, score, issues),
                    expertInsights: this.generateOverlordInsights(query, issues, score),
                    securityRisk: securityRisk,
                    performancePrediction: performancePrediction,
                    complexity: complexity,
                    benchmarkResults: this.runOverlordBenchmarks(query, score),
                    aiInsights: [], // Will be populated if AI is enabled
                    aiEnhanced: false // Will be set to true if AI analysis completes
                };
            }

            applyOverlordRules(query, issues, categories) {
                // Microsoft Syntax & Structure Standards
                this.overlordRules.syntaxStructure.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'syntax');
                });

                // Microsoft Performance & Efficiency Criteria
                this.overlordRules.performanceEfficiency.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'performance');
                });

                // Logic & Semantics Validation
                this.overlordRules.logicSemantics.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'syntax');
                });

                // Microsoft Best Practices Compliance
                this.overlordRules.microsoftBestPractices.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'bestPractices');
                });

                // Red Flag Scenarios (Critical Issues)
                this.overlordRules.redFlagScenarios.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'security');
                });

                // Data Governance (Enhanced)
                this.overlordRules.dataGovernance.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'security');
                });

                // Quality Scoring Integration
                this.overlordRules.qualityScoring.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'advanced');
                });

                // Performance Optimization Analysis
                this.overlordRules.performanceOptimization?.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'performance');
                });

                // Analytical Intelligence
                this.overlordRules.analyticalIntelligence?.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'bestPractices');
                });

                // Advanced Techniques
                this.overlordRules.advancedTechniques?.forEach(rule => {
                    this.evaluateRule(rule, query, issues, categories, 'advanced');
                });
            }

            evaluateRule(rule, query, issues, categories, category) {
                let matches = [];
                
                if (rule.test && typeof rule.test === 'function') {
                    if (rule.test(query)) {
                        matches = [true];
                    }
                } else if (rule.pattern) {
                    matches = query.match(rule.pattern) || [];
                }

                if (matches.length > 0) {
                    const issue = {
                        category: category,
                        severity: rule.severity,
                        title: rule.title,
                        description: rule.description,
                        suggestion: rule.suggestion,
                        scoreImpact: rule.scoreImpact || 0,
                        occurrences: matches.length,
                        cwe: rule.cwe,
                        overlordRating: rule.overlordRating,
                        performanceImpact: rule.performanceImpact,
                        benchmarkViolation: rule.benchmarkViolation,
                        compliance: rule.compliance,
                        remediation: rule.remediation,
                        logicalAnalysis: rule.logicalAnalysis,
                        category: rule.category,
                        microsoftStandard: rule.microsoftStandard,
                        line: this.findQueryLine(query, matches[0])
                    };

                    issues.push(issue);
                    
                    if (categories[category]) {
                        categories[category].issues.push(issue);
                        categories[category].score += rule.scoreImpact || 0;
                        categories[category].score = Math.max(categories[category].score, 0);
                    }
                }
            }

            applyEnvironmentOverlordRules(query, issues, categories) {
                const env = this.currentSettings.environment || this.currentSettings.target_env;
                
                // Apply security intelligence rules based on environment
                if (env === 'sentinel') {
                    // Sentinel-specific analysis
                    if (query.match(/SecurityEvent|SigninLogs|DeviceEvents|ThreatIntelligenceIndicator/gi)) {
                        issues.push({
                            category: 'environment',
                            severity: 'info',
                            title: '🛡️ SENTINEL OPTIMIZATION: Security Table Usage',
                            description: 'Query effectively uses Sentinel security tables for comprehensive threat analysis.',
                            suggestion: 'EXCELLENT: Proper use of Sentinel tables for security analytics and threat hunting.',
                            scoreImpact: +8,
                            overlordRating: 'SENTINEL TABLE MASTERY',
                            logicalAnalysis: 'Sentinel security tables provide comprehensive security telemetry for advanced threat detection.'
                        });
                    }
                }
                
                if (env === 'defender' && query.match(/DeviceEvents|DeviceProcessEvents|DeviceNetworkEvents/gi)) {
                    issues.push({
                        category: 'environment',
                        severity: 'info',
                        title: '🖥️ DEFENDER EXCELLENCE: Endpoint Table Optimization',
                        description: 'Query leverages Defender endpoint tables for comprehensive device security analysis.',
                        suggestion: 'DEFENDER MASTERY: Expert use of endpoint security tables for behavioral analysis.',
                        scoreImpact: +10,
                        overlordRating: 'ENDPOINT ANALYTICS EXCELLENCE',
                        logicalAnalysis: 'Defender endpoint tables enable deep behavioral analysis and threat hunting on managed devices.'
                    });
                }
            }

            applyUseCaseOverlordRules(query, issues, categories) {
                const useCase = this.currentSettings.useCase || this.currentSettings.use_case;
                
                if (useCase === 'hunting') {
                    if (query.match(/\/\/.*(?:hypothesis|ttp|mitre|technique)/gi)) {
                        issues.push({
                            category: 'useCase',
                            severity: 'info',
                            title: '🎯 HUNTING MASTERY: Hypothesis-Driven Methodology',
                            description: 'Threat hunting query demonstrates structured analytical methodology with clear hypothesis.',
                            suggestion: 'HUNTING EXCELLENCE: Perfect implementation of hypothesis-driven threat hunting approach.',
                            scoreImpact: +15,
                            overlordRating: 'THREAT HUNTING METHODOLOGY MASTERY',
                            logicalAnalysis: 'Hypothesis-driven hunting follows scientific method and improves detection accuracy.'
                        });
                    }
                    
                    if (!query.includes('//') && query.length > 100) {
                        issues.push({
                            category: 'useCase',
                            severity: 'medium',
                            title: '📚 HUNTING IMPROVEMENT: Documentation for Methodology',
                            description: 'Threat hunting queries benefit from documented hypotheses and analytical reasoning.',
                            suggestion: 'HUNTING BEST PRACTICE: Add comments explaining threat hypothesis and detection methodology.',
                            scoreImpact: -8,
                            overlordRating: 'HUNTING DOCUMENTATION NEEDED',
                            logicalAnalysis: 'Documented hunting hypotheses enable knowledge transfer and methodology validation.'
                        });
                    }
                }

                if (useCase === 'detection') {
                    if (query.match(/summarize.*(?:count|dcount|avg|percentile).*by.*\|\s*where.*>/gi)) {
                        issues.push({
                            category: 'useCase',
                            severity: 'info',
                            title: '🚨 DETECTION EXCELLENCE: Statistical Anomaly Logic',
                            description: 'Detection rule uses statistical analysis for threshold-based anomaly identification.',
                            suggestion: 'DETECTION MASTERY: Excellent statistical approach to behavioral anomaly detection.',
                            scoreImpact: +12,
                            overlordRating: 'STATISTICAL DETECTION ENGINEERING',
                            logicalAnalysis: 'Statistical thresholds enable reliable anomaly detection with reduced false positives.'
                        });
                    } else if (!query.match(/summarize|count|dcount/gi)) {
                        issues.push({
                            category: 'useCase',
                            severity: 'low',
                            title: '🔍 DETECTION CONSIDERATION: Aggregation Pattern',
                            description: 'Detection rules typically benefit from aggregation for alert condition logic.',
                            suggestion: 'DETECTION PATTERN: Consider adding summarize with count() or dcount() for detection thresholds.',
                            scoreImpact: -5,
                            overlordRating: 'DETECTION PATTERN OPTIMIZATION',
                            logicalAnalysis: 'Aggregation patterns help establish baselines and threshold-based detection logic.'
                        });
                    }
                }

                if (useCase === 'analytics') {
                    if (query.match(/bin\s*\(\s*TimeGenerated\s*,/gi)) {
                        issues.push({
                            category: 'useCase',
                            severity: 'info',
                            title: '📊 ANALYTICS EXCELLENCE: Temporal Analysis',
                            description: 'Analytics query uses time binning for trend analysis and pattern recognition.',
                            suggestion: 'ANALYTICS MASTERY: Excellent temporal analysis for trend identification and reporting.',
                            scoreImpact: +10,
                            overlordRating: 'TEMPORAL ANALYTICS EXCELLENCE',
                            logicalAnalysis: 'Time binning enables trend analysis and pattern recognition in security data over time.'
                        });
                    }
                }
            }

            calculateWeightedOverlordScore(categories) {
                let weightedScore = 0;
                let totalWeight = 0;

                Object.entries(categories).forEach(([category, data]) => {
                    const weight = data.weight || 0.1;
                    weightedScore += data.score * weight;
                    totalWeight += weight;
                });

                return Math.max(Math.min(weightedScore / totalWeight, 100), 0);
            }

            calculateAdvancedComplexity(query) {
                let complexity = 1;
                
                // Advanced complexity factors
                const complexPatterns = [
                    { pattern: /join/gi, weight: 3 },
                    { pattern: /union/gi, weight: 2 },
                    { pattern: /materialize/gi, weight: 4 },
                    { pattern: /mv-expand|mv-apply/gi, weight: 3 },
                    { pattern: /parse|extract/gi, weight: 2 },
                    { pattern: /summarize/gi, weight: 2 },
                    { pattern: /let\s+\w+\s*=/gi, weight: 1 }
                ];

                complexPatterns.forEach(({ pattern, weight }) => {
                    const matches = query.match(pattern) || [];
                    complexity += matches.length * weight;
                });

                return Math.min(complexity, 100);
            }

            assessSecurityRisk(query, issues) {
                const criticalIssues = issues.filter(i => i.severity === 'critical').length;
                const highIssues = issues.filter(i => i.severity === 'high').length;
                const dataGovernanceIssues = issues.filter(i => i.category === 'Data Protection').length;
                
                let riskLevel = 'LOW';
                let riskScore = 0;

                if (criticalIssues > 0) {
                    riskLevel = 'HIGH';
                    riskScore = 75 + (criticalIssues * 5);
                } else if (highIssues > 1 || dataGovernanceIssues > 2) {
                    riskLevel = 'MEDIUM';
                    riskScore = 45 + (highIssues * 8) + (dataGovernanceIssues * 5);
                } else if (highIssues > 0 || dataGovernanceIssues > 0) {
                    riskLevel = 'LOW-MEDIUM';
                    riskScore = 25 + (highIssues * 10) + (dataGovernanceIssues * 8);
                } else {
                    riskLevel = 'LOW';
                    riskScore = 15;
                }

                return {
                    level: riskLevel,
                    score: Math.min(riskScore, 100),
                    criticalIssues,
                    highIssues,
                    dataGovernanceIssues,
                    recommendation: this.getSecurityRecommendation(riskLevel)
                };
            }

            getSecurityRecommendation(riskLevel) {
                const recommendations = {
                    'HIGH': '🔍 REVIEW REQUIRED: Data governance issues detected. Review data projection and access patterns.',
                    'MEDIUM': '📋 CONSIDERATION: Some data handling patterns could be optimized for better governance.',
                    'LOW-MEDIUM': '💡 MINOR ITEMS: Minor data governance considerations for optimization.',
                    'LOW': '✅ EXCELLENT: Query follows good data governance and security practices.'
                };
                return recommendations[riskLevel];
            }

            predictQueryPerformance(query) {
                let performanceScore = 100;
                let estimatedRuntime = 1;
                let costFactor = 1;

                // Performance impact factors
                if (!query.match(/TimeGenerated.*ago/gi)) {
                    performanceScore -= 60;
                    estimatedRuntime *= 50;
                    costFactor *= 100;
                }

                if (query.match(/\|\s*project\s+\*/gi)) {
                    performanceScore -= 20;
                    costFactor *= 2;
                }

                if (query.match(/join/gi)) {
                    performanceScore -= 15;
                    estimatedRuntime *= 3;
                    costFactor *= 5;
                }

                if (query.match(/order.*by.*\|\s*take/gi)) {
                    performanceScore -= 10;
                    estimatedRuntime *= 2;
                }

                return {
                    score: Math.max(performanceScore, 0),
                    estimatedRuntime: `${Math.min(estimatedRuntime, 300)}s`,
                    costFactor: Math.min(costFactor, 1000),
                    recommendation: this.getPerformanceRecommendation(performanceScore)
                };
            }

            getPerformanceRecommendation(score) {
                if (score >= 90) return '🚀 OPTIMAL: Query performance is excellent';
                if (score >= 75) return '⚡ GOOD: Minor optimizations possible';
                if (score >= 60) return '🔧 MODERATE: Performance improvements recommended';
                return '🚨 CRITICAL: Major performance issues require immediate attention';
            }

            calculateAdvancedQueryMetrics(query) {
                const lines = query.split('\n').length;
                const operators = (query.match(/\|/g) || []).length;
                const tables = this.extractTableNames(query);
                const functions = this.extractFunctions(query);
                
                return {
                    linesOfCode: lines,
                    operators: operators,
                    tables: tables.length,
                    functions: functions.length,
                    tableNames: tables,
                    functionNames: functions,
                    estimatedCost: this.calculateQueryCost(query),
                    maintainabilityIndex: this.calculateMaintainabilityIndex(query)
                };
            }

            extractTableNames(query) {
                const tablePattern = /^(\w+)(?:\s*\||\s*$)/gm;
                const matches = [...query.matchAll(tablePattern)];
                return [...new Set(matches.map(m => m[1]).filter(t => 
                    !['let', 'print', 'range'].includes(t.toLowerCase())
                ))];
            }

            extractFunctions(query) {
                const functionPattern = /(\w+)\s*\(/g;
                const matches = [...query.matchAll(functionPattern)];
                return [...new Set(matches.map(m => m[1]))];
            }

            calculateQueryCost(query) {
                let cost = 1;
                
                // Cost factors
                if (!query.match(/TimeGenerated.*ago/gi)) cost *= 50;
                if (query.match(/\|\s*project\s+\*/gi)) cost *= 3;
                if (query.match(/join/gi)) cost *= 10;
                if (query.match(/union/gi)) cost *= 5;
                
                const takeMatch = query.match(/\|\s*take\s+(\d+)/gi);
                if (takeMatch) {
                    const takeValue = parseInt(takeMatch[0].match(/\d+/)[0]);
                    if (takeValue > 10000) cost *= 2;
                }

                return Math.min(cost, 1000);
            }

            calculateMaintainabilityIndex(query) {
                let index = 100;
                
                // Documentation factor
                if (!query.includes('//')) index -= 20;
                
                // Complexity factor
                const complexity = this.calculateAdvancedComplexity(query);
                index -= Math.min(complexity * 0.5, 30);
                
                // Variable usage bonus
                if (query.match(/let\s+\w+\s*=/gi)) index += 10;
                
                return Math.max(Math.min(index, 100), 0);
            }

            generateOverlordRecommendations(query, score, issues) {
                const recommendations = [];
                
                if (score < 50) {
                    recommendations.push('🚨 OVERLORD VERDICT: Query requires major reconstruction before production deployment');
                    recommendations.push('⚡ PRIORITY 1: Address all critical security and performance issues immediately');
                }
                
                if (!query.match(/TimeGenerated.*ago/gi)) {
                    recommendations.push('🎯 MANDATORY: Add time filtering - this is non-negotiable for any production query');
                }
                
                if (query.match(/\|\s*project\s+\*/gi)) {
                    recommendations.push('📋 OPTIMIZATION: Replace wildcard projections with specific column selection');
                }
                
                if (!query.includes('//') && query.length > 100) {
                    recommendations.push('📚 MAINTAINABILITY: Add comprehensive documentation for complex logic');
                }

                const securityIssues = issues.filter(i => i.severity === 'critical' || i.severity === 'high').length;
                if (securityIssues > 0) {
                    recommendations.push('🛡️ SECURITY: Immediate security remediation required before any deployment');
                }

                return recommendations;
            }

            generateOverlordInsights(query, issues, score) {
                const insights = [];
                
                // Overlord-level insights
                if (score >= 95) {
                    insights.push('🏆 OVERLORD STATUS: Query achieves elite mastery level - exceeds Microsoft engineering standards');
                }
                
                if (score >= 90) {
                    insights.push('⚡ KUSTO MASTERY: Query demonstrates expert-level KQL engineering practices');
                }

                const advancedTechniques = issues.filter(i => i.overlordRating && i.overlordRating.includes('MASTERY')).length;
                if (advancedTechniques > 0) {
                    insights.push(`🚀 ADVANCED MASTERY: ${advancedTechniques} expert-level techniques detected`);
                }

                const securityIssues = issues.filter(i => i.category === 'security').length;
                if (securityIssues === 0) {
                    insights.push('🛡️ SECURITY OVERLORD: Perfect security posture - no vulnerabilities detected');
                }

                const performanceIssues = issues.filter(i => i.category === 'performance').length;
                if (performanceIssues === 0) {
                    insights.push('⚡ PERFORMANCE OVERLORD: Optimal performance patterns throughout query');
                }

                if (query.match(/\/\/.*(?:hypothesis|mitre|ttp)/gi)) {
                    insights.push('🎯 ANALYTICAL MASTERY: Strategic threat hunting with documented methodology');
                }

                return insights;
            }

            runOverlordBenchmarks(query, score) {
                const benchmarks = {
                    microsoftStandard: this.benchmarkAgainstMicrosoft(query, score),
                    industryStandard: this.benchmarkAgainstIndustry(query, score),
                    overlordStandard: this.benchmarkAgainstOverlord(query, score)
                };

                return benchmarks;
            }

            benchmarkAgainstMicrosoft(query, score) {
                // Microsoft engineering standards benchmark
                let microsoftScore = 0;
                
                if (query.match(/TimeGenerated.*ago/gi)) microsoftScore += 30;
                if (!query.match(/\|\s*project\s+\*/gi)) microsoftScore += 20;
                if (query.includes('//')) microsoftScore += 15;
                if (query.match(/let\s+\w+\s*=/gi)) microsoftScore += 20;
                if (!query.match(/\|\s*where.*==.*['"]/gi)) microsoftScore += 15;

                const status = microsoftScore >= 80 ? 'EXCEEDS' : microsoftScore >= 60 ? 'MEETS' : 'BELOW';
                
                return {
                    score: microsoftScore,
                    status: status,
                    description: `${status} Microsoft Engineering Standards`
                };
            }

            benchmarkAgainstIndustry(query, score) {
                // Industry standard benchmark
                const industryScore = Math.min(score * 0.9, 100);
                const status = industryScore >= 85 ? 'INDUSTRY LEADING' : industryScore >= 70 ? 'ABOVE AVERAGE' : 'BELOW AVERAGE';
                
                return {
                    score: Math.round(industryScore),
                    status: status,
                    description: `${status} compared to industry practices`
                };
            }

            benchmarkAgainstOverlord(query, score) {
                // Overlord standard benchmark (highest possible)
                let overlordScore = 0;
                
                // Overlord criteria
                if (query.match(/TimeGenerated.*ago/gi)) overlordScore += 20;
                if (query.match(/let\s+\w+\s*=/gi)) overlordScore += 15;
                if (query.includes('//') && query.match(/\/\/.*(?:hypothesis|purpose|objective)/gi)) overlordScore += 20;
                if (query.match(/materialize|mv-expand|mv-apply/gi)) overlordScore += 15;
                if (!query.match(/\|\s*project\s+\*/gi)) overlordScore += 10;
                if (query.match(/join\s+kind=(?:leftouter|rightouter)/gi)) overlordScore += 10;
                if (!query.match(/\|\s*where.*==.*['"]/gi)) overlordScore += 10;

                const status = overlordScore >= 90 ? 'OVERLORD MASTERY' : overlordScore >= 75 ? 'EXPERT LEVEL' : overlordScore >= 60 ? 'ADVANCED' : 'DEVELOPING';
                
                return {
                    score: overlordScore,
                    status: status,
                    description: `${status} - Ultimate KQL Engineering Standards`
                };
            }

            calculateOverlordGrade(score) {
                // Microsoft Quality Scoring Rubric Integration
                if (score >= 98) return 'OVERLORD';
                if (score >= 90) return 'PRODUCTION-READY'; // 90-100%: Production-ready, follows all best practices
                if (score >= 80) return 'GOOD'; // 80-89%: Good with minor optimizations needed
                if (score >= 70) return 'FUNCTIONAL'; // 70-79%: Functional but requires performance improvements
                if (score >= 60) return 'NEEDS-WORK'; // 60-69%: Logic issues that need addressing
                return 'MAJOR-REWORK'; // Below 60%: Major rework required
            }

            getSeverityWeight(severity) {
                const weights = {
                    'critical': 10,
                    'high': 8,
                    'medium': 6,
                    'low': 4,
                    'info': 2,
                    'optimization': 3,
                    'masterclass': 1
                };
                return weights[severity] || 0;
            }

            findQueryLine(query, searchStr) {
                if (!searchStr || typeof searchStr !== 'string') return 1;
                
                const lines = query.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes(searchStr.substring(0, 30))) {
                        return i + 1;
                    }
                }
                return 1;
            }

            displayOverlordResults(analysis) {
                document.getElementById('scoreSection').style.display = 'block';
                document.getElementById('overallScore').textContent = analysis.overallScore;
                
                const gradeBadge = document.getElementById('gradeBadge');
                if (analysis.grade === 'OVERLORD') {
                    gradeBadge.textContent = '🏆 OVERLORD 🏆';
                } else if (analysis.grade === 'PRODUCTION-READY') {
                    gradeBadge.textContent = '✅ PRODUCTION READY';
                } else if (analysis.grade === 'GOOD') {
                    gradeBadge.textContent = '👍 GOOD - MINOR OPTIMIZATIONS';
                } else if (analysis.grade === 'FUNCTIONAL') {
                    gradeBadge.textContent = '⚙️ FUNCTIONAL - NEEDS PERFORMANCE WORK';
                } else if (analysis.grade === 'NEEDS-WORK') {
                    gradeBadge.textContent = '🔧 NEEDS WORK - LOGIC ISSUES';
                } else if (analysis.grade === 'MAJOR-REWORK') {
                    gradeBadge.textContent = '🚨 MAJOR REWORK REQUIRED';
                } else {
                    gradeBadge.textContent = `Grade: ${analysis.grade}`;
                }
                
                // Fix class name for CSS compatibility
                const cssClassName = analysis.grade.toLowerCase().replace(/-/g, '-');
                gradeBadge.className = `grade-badge grade-${cssClassName}`;

                const resultsContent = document.getElementById('resultsContent');
                resultsContent.innerHTML = '';

                // AI-Enhanced Insights
                if (analysis.aiInsights && analysis.aiInsights.length > 0) {
                    this.addAIInsightsSection(resultsContent, analysis.aiInsights, analysis.aiEnhanced);
                }

                // Microsoft Compliance Status (renamed to Standards Compliance)
                this.addStandardsComplianceSection(resultsContent, analysis);

                // Overlord Status Section
                if (analysis.grade === 'OVERLORD') {
                    this.addOverlordStatusSection(resultsContent, analysis);
                }

                // Performance Metrics
                this.addAdvancedMetricsSection(resultsContent, analysis.queryMetrics);

                // Security Risk Assessment
                this.addSecurityRiskSection(resultsContent, analysis.securityRisk);

                // Performance Prediction
                this.addPerformancePredictionSection(resultsContent, analysis.performancePrediction);

                // Categories Analysis
                Object.entries(analysis.categories).forEach(([category, data]) => {
                    if (data.issues.length > 0 || ['security', 'performance'].includes(category)) {
                        this.addOverlordCategorySection(resultsContent, category, data);
                    }
                });

                // Overlord Recommendations
                if (analysis.recommendations.length > 0) {
                    this.addOverlordRecommendationsSection(resultsContent, analysis.recommendations);
                }

                // Expert Insights
                if (analysis.expertInsights.length > 0) {
                    this.addOverlordInsightsSection(resultsContent, analysis.expertInsights);
                }

                // Benchmark Results
                this.addBenchmarkResultsSection(resultsContent, analysis.benchmarkResults);

                // AI Insights
                this.addAIInsightsSection(resultsContent, analysis);
            }

            addMicrosoftComplianceSection(container, analysis) {
                const microsoftIssues = analysis.issues.filter(i => i.microsoftStandard);
                const criticalViolations = microsoftIssues.filter(i => i.severity === 'critical').length;
                const standardViolations = microsoftIssues.filter(i => i.severity === 'high' || i.severity === 'medium').length;
                
                let complianceStatus = 'COMPLIANT';
                let complianceColor = 'var(--kusto-success)';
                let complianceMessage = 'Query meets Microsoft engineering standards';
                
                if (criticalViolations > 0) {
                    complianceStatus = 'NON-COMPLIANT';
                    complianceColor = 'var(--kusto-critical)';
                    complianceMessage = `${criticalViolations} critical Microsoft standard violations detected`;
                } else if (standardViolations > 2) {
                    complianceStatus = 'NEEDS REVIEW';
                    complianceColor = '#ff9800';
                    complianceMessage = `${standardViolations} Microsoft standard issues require attention`;
                } else if (standardViolations > 0) {
                    complianceStatus = 'MINOR ISSUES';
                    complianceColor = 'var(--kusto-blue)';
                    complianceMessage = `${standardViolations} minor Microsoft standard optimizations available`;
                }

                const section = document.createElement('div');
                section.className = 'category-section';
                section.style.border = `2px solid ${complianceColor}`;
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">🏢 Microsoft Standards Compliance</div>
                        <div class="category-score" style="background: ${complianceColor}; color: #fff;">
                            ${complianceStatus}
                        </div>
                    </div>
                    <div style="padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; color: var(--kusto-critical); font-weight: 900;">${criticalViolations}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">CRITICAL VIOLATIONS</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; color: #ff9800; font-weight: 900;">${standardViolations}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">STANDARD ISSUES</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; color: ${complianceColor}; font-weight: 900;">${microsoftIssues.length}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">TOTAL MS ITEMS</div>
                            </div>
                        </div>
                        <div style="text-align: center; color: ${complianceColor}; font-weight: 600; font-size: 1.1rem;">
                            ${complianceMessage}
                        </div>
                        <div style="text-align: center; margin-top: 12px; color: var(--text-secondary); font-size: 0.9rem;">
                            Based on Microsoft KQL development guidelines, security standards, and performance requirements
                        </div>
                    </div>
                `;
                
            addOverlordStatusSection(container, analysis) {
                const section = document.createElement('div');
                section.className = 'overlord-section';
                
                section.innerHTML = `
                    <div style="position: relative; z-index: 1;">
                        <h3 style="color: var(--kusto-gold); font-size: 1.8rem; margin-bottom: 16px; text-align: center;">
                            🏆 OVERLORD STATUS ACHIEVED 🏆
                        </h3>
                        <p style="color: #fff; text-align: center; font-size: 1.2rem; margin-bottom: 20px;">
                            This query has achieved the highest possible mastery level in KQL engineering.
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">SECURITY</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">PERFORMANCE</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">MICROSOFT STANDARDS</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }
                const section = document.createElement('div');
                section.className = 'overlord-section';
                
                section.innerHTML = `
                    <div style="position: relative; z-index: 1;">
                        <h3 style="color: var(--kusto-gold); font-size: 1.8rem; margin-bottom: 16px; text-align: center;">
                            🏆 OVERLORD STATUS ACHIEVED 🏆
                        </h3>
                        <p style="color: #fff; text-align: center; font-size: 1.2rem; margin-bottom: 20px;">
                            This query has achieved the highest possible mastery level in KQL engineering.
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">SECURITY</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">PERFORMANCE</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.1); border: 1px solid var(--kusto-gold); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--kusto-gold); font-weight: 900;">ENGINEERING</div>
                                <div style="color: #fff;">OVERLORD LEVEL</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addAdvancedMetricsSection(container, metrics) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">📊 Advanced Query Metrics</div>
                    </div>
                    <div class="performance-metrics">
                        <div class="metric-box">
                            <div class="metric-value">${metrics.linesOfCode}</div>
                            <div class="metric-label">Lines of Code</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${metrics.operators}</div>
                            <div class="metric-label">KQL Operators</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${metrics.tables}</div>
                            <div class="metric-label">Tables Used</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${metrics.functions}</div>
                            <div class="metric-label">Functions</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${metrics.estimatedCost}</div>
                            <div class="metric-label">Cost Factor</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value">${Math.round(metrics.maintainabilityIndex)}</div>
                            <div class="metric-label">Maintainability</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; font-size: 0.9rem; color: var(--text-secondary);">
                        <strong>Tables:</strong> ${metrics.tableNames.join(', ') || 'None detected'}<br>
                        <strong>Key Functions:</strong> ${metrics.functionNames.slice(0, 10).join(', ') || 'None detected'}
                    </div>
                `;
                
                container.appendChild(section);
            }

            addSecurityRiskSection(container, securityRisk) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const riskColor = {
                    'CRITICAL': 'var(--kusto-critical)',
                    'HIGH': '#ff5722',
                    'MEDIUM': '#ff9800',
                    'LOW': 'var(--kusto-success)'
                }[securityRisk.level];
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">🛡️ Security Risk Assessment</div>
                        <div class="category-score" style="background: ${riskColor}; color: #fff;">
                            ${securityRisk.level} RISK
                        </div>
                    </div>
                    <div style="padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--kusto-critical); font-weight: 900;">${securityRisk.criticalIssues}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">CRITICAL ISSUES</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: #ff5722; font-weight: 900;">${securityRisk.highIssues}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">HIGH ISSUES</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: ${riskColor}; font-weight: 900;">${securityRisk.score}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">RISK SCORE</div>
                            </div>
                        </div>
                        <div style="color: var(--kusto-accent); font-weight: 600;">
                            ${securityRisk.recommendation}
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addPerformancePredictionSection(container, performance) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const perfColor = performance.score >= 90 ? 'var(--kusto-success)' : 
                                 performance.score >= 75 ? 'var(--kusto-blue)' : 
                                 performance.score >= 60 ? '#ff9800' : 'var(--kusto-critical)';
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">⚡ Performance Prediction</div>
                        <div class="category-score" style="background: ${perfColor}; color: #fff;">
                            ${Math.round(performance.score)}/100
                        </div>
                    </div>
                    <div style="padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--kusto-accent); font-weight: 900;">${performance.estimatedRuntime}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">EST. RUNTIME</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--kusto-accent); font-weight: 900;">${performance.costFactor}x</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">COST FACTOR</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: ${perfColor}; font-weight: 900;">${Math.round(performance.score)}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">PERF SCORE</div>
                            </div>
                        </div>
                        <div style="color: var(--kusto-accent); font-weight: 600;">
                            ${performance.recommendation}
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addOverlordCategorySection(container, category, data) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const categoryIcons = {
                    security: '🛡️',
                    performance: '⚡',
                    syntax: '📝',
                    bestPractices: '✨',
                    advanced: '🚀',
                    environment: '🌐'
                };

                const scoreClass = this.getOverlordScoreClass(data.score);
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">${categoryIcons[category]} ${category.charAt(0).toUpperCase() + category.slice(1)} Analysis</div>
                        <div class="category-score ${scoreClass}">${Math.round(data.score)}/100</div>
                    </div>
                    <div class="issue-list" id="${category}-issues"></div>
                `;

                const issuesList = section.querySelector('.issue-list');
                
                if (data.issues.length === 0) {
                    issuesList.innerHTML = '<div style="color: var(--kusto-success); text-align: center; padding: 20px;">🏆 OVERLORD LEVEL: Perfect execution in this category</div>';
                } else {
                    data.issues.forEach(issue => {
                        const issueElement = this.createOverlordIssueElement(issue);
                        issuesList.appendChild(issueElement);
                    });
                }

                container.appendChild(section);
            }

            addOverlordRecommendationsSection(container, recommendations) {
                const section = document.createElement('div');
                section.className = 'category-section expert-mode';
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">🎯 Overlord Recommendations</div>
                    </div>
                    <div class="issue-list">
                        ${recommendations.map(rec => `
                            <div class="issue-item issue-info">
                                <div class="issue-title">${rec}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(section);
            }

            addOverlordInsightsSection(container, insights) {
                const section = document.createElement('div');
                section.className = 'category-section ai-insights';
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">🧠 Overlord Intelligence Insights</div>
                    </div>
                    <div class="issue-list">
                        ${insights.map(insight => `
                            <div class="issue-item issue-masterclass">
                                <div class="issue-title">${insight}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(section);
            }

            addBenchmarkResultsSection(container, benchmarks) {
                const section = document.createElement('div');
                section.className = 'benchmark-section';
                
                section.innerHTML = `
                    <div class="benchmark-title">🏆 Overlord Benchmark Results</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px; position: relative; z-index: 1;">
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 16px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: var(--kusto-blue); margin-bottom: 8px;">Microsoft Standards</h4>
                            <div style="font-size: 1.5rem; color: var(--kusto-accent); font-weight: 900;">${benchmarks.microsoftStandard.score}/100</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">${benchmarks.microsoftStandard.description}</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 16px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: var(--kusto-blue); margin-bottom: 8px;">Industry Standards</h4>
                            <div style="font-size: 1.5rem; color: var(--kusto-accent); font-weight: 900;">${benchmarks.industryStandard.score}/100</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">${benchmarks.industryStandard.description}</div>
                        </div>
                        <div style="background: rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 16px; border: 1px solid var(--kusto-gold);">
                            <h4 style="color: var(--kusto-gold); margin-bottom: 8px;">Overlord Standards</h4>
                            <div style="font-size: 1.5rem; color: var(--kusto-gold); font-weight: 900;">${benchmarks.overlordStandard.score}/100</div>
                            <div style="color: var(--kusto-gold); font-size: 0.9rem;">${benchmarks.overlordStandard.description}</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            addAIInsightsSection(container, analysis) {
                const section = document.createElement('div');
                section.className = 'overlord-section';
                
                const aiInsights = this.generateAIInsights(analysis);
                
                section.innerHTML = `
                    <div style="position: relative; z-index: 1;">
                        <h3 style="color: var(--kusto-gold); font-size: 1.5rem; margin-bottom: 16px;">
                            🤖 AI-Powered Overlord Analysis
                        </h3>
                        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px;">
                            ${aiInsights.map(insight => `
                                <div style="margin-bottom: 12px; padding: 12px; background: rgba(64, 224, 208, 0.1); border-radius: 8px; border-left: 3px solid var(--kusto-accent);">
                                    <strong style="color: var(--kusto-accent);">${insight.title}:</strong>
                                    <span style="color: #fff; margin-left: 8px;">${insight.description}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(section);
            }

            generateAIInsights(analysis) {
                const insights = [];
                
                // Query complexity analysis
                if (analysis.complexity > 20) {
                    insights.push({
                        title: 'Complexity Analysis',
                        description: `High complexity query (${analysis.complexity}/100) suggests sophisticated analytical requirements. Consider modularization for maintainability.`
                    });
                }

                // Performance insights
                if (analysis.performancePrediction.score < 70) {
                    insights.push({
                        title: 'Performance Optimization',
                        description: `Performance score ${analysis.performancePrediction.score}/100 indicates significant optimization opportunities. Focus on time filtering and projection optimization.`
                    });
                }

                // Security insights
                if (analysis.securityRisk.level === 'LOW') {
                    insights.push({
                        title: 'Security Excellence',
                        description: 'Query demonstrates excellent security practices with no significant vulnerabilities detected.'
                    });
                }

                // Advanced technique recognition
                const advancedIssues = analysis.issues.filter(i => i.overlordRating && i.overlordRating.includes('MASTERY'));
                if (advancedIssues.length > 0) {
                    insights.push({
                        title: 'Advanced Technique Mastery',
                        description: `Detected ${advancedIssues.length} advanced KQL techniques demonstrating expert-level proficiency.`
                    });
                }

                return insights;
            }

            createOverlordIssueElement(issue) {
                const div = document.createElement('div');
                div.className = `issue-item issue-${issue.severity}`;
                
                const severityEmojis = {
                    'critical': '🚨',
                    'high': '⚠️',
                    'medium': '⚡',
                    'low': '💡',
                    'info': 'ℹ️',
                    'optimization': '🚀',
                    'masterclass': '🏆'
                };

                const scoreDisplay = issue.scoreImpact > 0 ? 
                    `<span style="color: var(--kusto-success);">+${issue.scoreImpact}</span>` : 
                    `<span style="color: var(--kusto-critical);">${issue.scoreImpact}</span>`;

                div.innerHTML = `
                    <div class="issue-header">
                        <div class="issue-title">${severityEmojis[issue.severity]} ${issue.title}</div>
                        <div class="issue-severity severity-${issue.severity}">${issue.severity}</div>
                    </div>
                    <div class="issue-description">${issue.description}</div>
                    <div class="issue-suggestion">
                        <strong>💡 Overlord Guidance:</strong> ${issue.suggestion}
                        ${issue.line ? `<br><small>📍 Line: ${issue.line}</small>` : ''}
                        ${issue.cwe ? `<br><small>🔗 Security Reference: ${issue.cwe}</small>` : ''}
                        ${issue.overlordRating ? `<br><small>⚡ Overlord Rating: ${issue.overlordRating}</small>` : ''}
                        ${issue.performanceImpact ? `<br><small>🚀 Performance Impact: ${issue.performanceImpact}</small>` : ''}
                        ${issue.benchmarkViolation ? `<br><small>📊 Benchmark: ${issue.benchmarkViolation}</small>` : ''}
                        ${issue.compliance ? `<br><small>⚖️ Compliance: ${issue.compliance}</small>` : ''}
                        ${issue.remediation ? `<br><small>🔧 Remediation: ${issue.remediation}</small>` : ''}
                        ${issue.logicalAnalysis ? `<br><small>🧠 Logic Analysis: ${issue.logicalAnalysis}</small>` : ''}
                        ${issue.category ? `<br><small>📂 Category: ${issue.category}</small>` : ''}
                        ${issue.microsoftStandard ? `<br><small>📏 Industry Standard: ${issue.microsoftStandard}</small>` : ''}
                        ${issue.scoreImpact !== undefined ? `<br><small>📈 Score Impact: ${scoreDisplay}</small>` : ''}
                    </div>
                `;

                return div;
            }

            getOverlordScoreClass(score) {
                if (score >= 98) return 'score-overlord-level';
                if (score >= 90) return 'score-excellent';
                if (score >= 75) return 'score-good';
                if (score >= 60) return 'score-fair';
                return 'score-poor';
            }

            async provideOverlordHints() {
                const query = document.getElementById('kqlEditor').value;
                const aiMode = this.currentSettings.aiMode;
                
                if (aiMode === 'ai-realtime' && this.googleAIApiKey && query.length > 50) {
                    try {
                        await this.provideRealTimeAIFeedback(query);
                    } catch (error) {
                        console.error('Real-time AI feedback failed:', error);
                    }
                }
                
                // Real-time pattern-based analysis hints
                console.log('Overlord providing real-time analysis hints');
            }

            async provideRealTimeAIFeedback(query) {
                const context = `Provide quick real-time feedback for this KQL query. Focus on immediate issues and suggestions. Keep response under 200 words.

Query:
\`\`\`kql
${query}
\`\`\`

Provide concise feedback about:
1. Immediate syntax issues
2. Performance concerns  
3. Quick optimization tips
4. Best practice suggestions

Format as brief, actionable points.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${this.googleAIApiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: context
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.3,
                                topK: 20,
                                topP: 0.8,
                                maxOutputTokens: 200,
                            }
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const feedback = data.candidates[0].content.parts[0].text;
                        this.showRealTimeFeedback(feedback);
                    }
                } catch (error) {
                    console.error('Real-time feedback error:', error);
                }
            }

            showRealTimeFeedback(feedback) {
                // Create or update real-time feedback overlay
                let feedbackOverlay = document.getElementById('realtime-feedback');
                
                if (!feedbackOverlay) {
                    feedbackOverlay = document.createElement('div');
                    feedbackOverlay.id = 'realtime-feedback';
                    feedbackOverlay.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        max-width: 300px;
                        background: rgba(0, 120, 212, 0.95);
                        color: white;
                        padding: 12px;
                        border-radius: 8px;
                        font-size: 0.8rem;
                        z-index: 100;
                        backdrop-filter: blur(10px);
                        animation: slideIn 0.3s ease-out;
                    `;
                    
                    document.querySelector('.query-section').style.position = 'relative';
                    document.querySelector('.query-section').appendChild(feedbackOverlay);
                }
                
                feedbackOverlay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span>🤖</span>
                        <strong>AI Real-time Feedback</strong>
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer;">×</button>
                    </div>
                    <div>${this.formatMessageContent(feedback)}</div>
                `;
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    if (feedbackOverlay && feedbackOverlay.parentNode) {
                        feedbackOverlay.remove();
                    }
                }, 10000);
            }

            updateAnalysisPreview() {
                // Update analysis preview based on current settings
                const aiMode = this.currentSettings.aiMode || this.currentSettings.ai_mode;
                const status = document.getElementById('chatbotStatus');
                
                if (status) {
                    this.updateChatbotStatus();
                }
                
                console.log('Analysis preview updated for mode:', aiMode);
            }

            showOverlordAlert(title, message) {
                alert(`${title}\n\n${message}`);
            }

            showLoading() {
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('analysisProgress').style.width = '0%';
            }

            hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            debounce(func, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize the Kusto Overlord
        document.addEventListener('DOMContentLoaded', () => {
            new KustoOverlord();
        });
    </script>
</body>
</html>
