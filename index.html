<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kusto Overlord - SIMPLE VERSION THAT WORKS</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0078d4, #005a9e);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .header {
            background: linear-gradient(90deg, #0078d4, #106ebe);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            padding: 30px;
        }
        
        .left-panel {
            background: white;
        }
        
        .right-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #323130;
        }
        
        #queryInput {
            width: 100%;
            height: 400px;
            padding: 20px;
            border: 2px solid #edebe9;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            background: #f8f8f8;
            resize: vertical;
            outline: none;
        }
        
        #queryInput:focus {
            border-color: #0078d4;
        }
        
        #gradeBtn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, #0078d4, #106ebe);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        
        #gradeBtn:hover {
            transform: translateY(-2px);
        }
        
        .score-display {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .score-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .score-excellent { color: #107c10; }
        .score-good { color: #0078d4; }
        .score-poor { color: #ff8c00; }
        .score-fail { color: #d13438; }
        
        .grade-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .grade-excellent { background: #107c10; }
        .grade-good { background: #0078d4; }
        .grade-poor { background: #ff8c00; }
        .grade-fail { background: #d13438; }
        
        .issue {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .issue-critical { border-left-color: #d13438; }
        .issue-major { border-left-color: #ff8c00; }
        .issue-minor { border-left-color: #0078d4; }
        
        .issue-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #323130;
        }
        
        .issue-desc {
            color: #605e5c;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .issue-fix {
            background: rgba(0,120,212,0.1);
            padding: 12px;
            border-radius: 6px;
            color: #323130;
        }
        
        .welcome {
            text-align: center;
            padding: 40px;
            color: #605e5c;
        }
        
        .chat-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,120,212,0.3);
            z-index: 1000;
        }
        
        .chat-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 1001;
        }
        
        .chat-header {
            background: #0078d4;
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
        }
        
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .chat-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #edebe9;
            background: white;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #edebe9;
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
        }
        
        .chat-send {
            padding: 10px 20px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 12px;
            line-height: 1.5;
            max-width: 90%;
        }
        
        .message-user {
            background: #0078d4;
            color: white;
            margin-left: auto;
        }
        
        .message-ai {
            background: white;
            color: #323130;
            border: 1px solid #edebe9;
        }
        
        @media (max-width: 1000px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• Kusto Overlord</h1>
            <p>SIMPLE VERSION THAT ACTUALLY WORKS</p>
        </div>

        <div class="content">
            <div class="left-panel">
                <div class="section-title">üìù KQL Query Input</div>
                
                <textarea id="queryInput" placeholder="// Enter your KQL query here

// TEST FAKE QUERY (should get 0/1000):
HasOffHoursActivity,HasWeekendActivity,OffHoursConnections

// TEST VALID QUERY (should score well):
SecurityEvent
| where TimeGenerated > ago(7d)
| where EventID == 4624
| project Computer, Account"></textarea>

                <button id="gradeBtn">üéØ Grade Query</button>
            </div>

            <div class="right-panel">
                <div class="section-title">üìä Analysis Results</div>
                
                <div id="results">
                    <div class="welcome">
                        <h3>ü§ñ Ready to Grade</h3>
                        <p>Enter a KQL query and click "Grade Query" for analysis.</p>
                        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px;">
                            <strong>This version:</strong><br>
                            ‚úÖ Multiple queries (no refresh needed)<br>
                            ‚úÖ Working AI chat<br>
                            ‚úÖ Strict fake table detection<br>
                            ‚úÖ Simple and reliable
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat -->
    <button class="chat-toggle" onclick="toggleChat()">ü§ñ</button>
    
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            ü§ñ KQL AI Assistant
            <button class="chat-close" onclick="toggleChat()">√ó</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="message message-ai">
                <strong>üöÄ KQL Expert Ready!</strong><br><br>
                I'm working properly now! Ask me about:
                <br><br>
                ‚Ä¢ Valid vs fake tables<br>
                ‚Ä¢ Query optimization<br>
                ‚Ä¢ KQL syntax help<br>
                ‚Ä¢ Performance tips<br><br>
                üí° Try: "What makes a table fake?" or "Help with my query"
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask about KQL..." onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button class="chat-send" onclick="sendChatMessage()">Send</button>
        </div>
    </div>

    <script>
        // Valid Microsoft security tables
        const VALID_TABLES = new Set([
            'SecurityEvent', 'SigninLogs', 'AuditLogs', 'DeviceEvents', 'DeviceProcessEvents',
            'DeviceNetworkEvents', 'DeviceFileEvents', 'DeviceRegistryEvents', 'DeviceLogonEvents',
            'IdentityInfo', 'IdentityDirectoryEvents', 'IdentityLogonEvents', 'IdentityQueryEvents',
            'EmailEvents', 'EmailAttachmentInfo', 'EmailUrlInfo', 'EmailPostDeliveryEvents',
            'AlertInfo', 'AlertEvidence', 'ThreatIntelligenceIndicator', 'DeviceInfo',
            'Heartbeat', 'Usage', 'Operation', 'Perf', 'Event', 'Syslog', 'SecurityAlert',
            'SecurityIncident', 'CommonSecurityLog', 'AADNonInteractiveUserSignInLogs',
            'AADServicePrincipalSignInLogs', 'AADManagedIdentitySignInLogs', 'DeviceNetworkInfo',
            'DeviceTvmSoftwareInventory', 'DeviceTvmSoftwareVulnerabilities', 'AppFileEvents',
            'BehaviorAnalytics', 'CloudAppEvents', 'UrlClickEvents', 'OfficeActivity',
            'PowerBIAudit', 'AzureActivity', 'AzureDiagnostics', 'WindowsEvent', 'Watchlist'
        ]);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('gradeBtn').addEventListener('click', gradeQuery);
            console.log('üöÄ Kusto Overlord initialized - SIMPLE VERSION');
        });

        function gradeQuery() {
            console.log('üéØ Starting query analysis...');
            
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                alert('Please enter a KQL query to grade.');
                return;
            }

            try {
                const analysis = analyzeQuery(query);
                displayResults(analysis);
                console.log('‚úÖ Analysis complete:', analysis.score + '/1000');
            } catch (error) {
                console.error('‚ùå Analysis failed:', error);
                showError('Analysis failed: ' + error.message);
            }
        }

        function analyzeQuery(query) {
            console.log('üîç Analyzing:', query.substring(0, 50) + '...');
            
            const result = {
                score: 1000,
                grade: 'Excellent',
                issues: [],
                status: 'PASS'
            };

            // Check for fake content FIRST
            if (isFakeQuery(query)) {
                result.score = 0;
                result.grade = 'Fail';
                result.status = 'AUTO_FAIL';
                result.issues.push({
                    severity: 'critical',
                    title: 'üö® FAKE QUERY DETECTED',
                    description: 'This query contains fake table names, field lists, or invalid content that would never work in Microsoft environments.',
                    fix: 'Use real Microsoft security tables like SecurityEvent, SigninLogs, DeviceEvents, etc. Write proper KQL syntax starting with a table name.'
                });
                console.log('‚ùå Fake query detected');
                return result;
            }

            // Validate tables
            const tableIssues = validateTables(query);
            if (tableIssues.length > 0) {
                result.score -= 500;
                result.issues.push(...tableIssues);
                console.log('‚ùå Table validation issues:', tableIssues.length);
            }

            // Check performance
            const perfIssues = checkPerformance(query);
            if (perfIssues.length > 0) {
                result.score -= perfIssues.length * 100;
                result.issues.push(...perfIssues);
                console.log('‚ö†Ô∏è Performance issues:', perfIssues.length);
            }

            // Check syntax
            const syntaxIssues = checkSyntax(query);
            if (syntaxIssues.length > 0) {
                result.score -= syntaxIssues.length * 50;
                result.issues.push(...syntaxIssues);
                console.log('‚ö†Ô∏è Syntax issues:', syntaxIssues.length);
            }

            // Final scoring
            result.score = Math.max(0, result.score);
            const percentage = (result.score / 1000) * 100;
            
            if (percentage >= 90) result.grade = 'Excellent';
            else if (percentage >= 80) result.grade = 'Good';
            else if (percentage >= 60) result.grade = 'Poor';
            else result.grade = 'Fail';

            if (result.score < 600) result.status = 'FAIL';
            else if (result.score < 800) result.status = 'NEEDS_WORK';

            return result;
        }

        function isFakeQuery(query) {
            const lower = query.toLowerCase();
            
            // Fake patterns that should auto-fail
            const fakePatterns = [
                'faketable', 'testtable', 'dummytable', 'sampletable',
                'hasoffhoursactivity', 'hasweekendactivity', 'offhoursconnections',
                'weekendconnections', 'threatlevel', 'maxriskscore', 'threatcategories',
                'isnewbaseline', 'suspiciousactivity', 'riskassessment'
            ];
            
            // Check for any fake patterns
            for (const pattern of fakePatterns) {
                if (lower.includes(pattern)) {
                    console.log('‚ùå Fake pattern found:', pattern);
                    return true;
                }
            }

            // Check if it's just a field list (not proper KQL)
            if (!query.includes('|') && query.includes(',') && query.split(',').length > 2) {
                console.log('‚ùå Field list detected (not proper KQL)');
                return true;
            }

            // Check if starts with valid table
            const firstLine = query.trim().split('\n')[0].trim();
            const firstWord = firstLine.split(/\s+|\|/)[0];
            
            if (!VALID_TABLES.has(firstWord) && !firstWord.toLowerCase().startsWith('let')) {
                console.log('‚ùå Invalid starting table:', firstWord);
                return true;
            }

            return false;
        }

        function validateTables(query) {
            const issues = [];
            const lines = query.split('\n').filter(line => line.trim() && !line.trim().startsWith('//'));
            
            if (lines.length === 0) return issues;
            
            const firstLine = lines[0].trim();
            if (firstLine.toLowerCase().startsWith('let ')) return issues;
            
            const tableName = firstLine.split(/\s+|\|/)[0];
            
            if (!VALID_TABLES.has(tableName)) {
                issues.push({
                    severity: 'critical',
                    title: 'Invalid Table Reference',
                    description: `Table "${tableName}" does not exist in Microsoft security environments.`,
                    fix: 'Use valid tables like SecurityEvent, SigninLogs, DeviceEvents, AlertInfo, etc.'
                });
            }
            
            return issues;
        }

        function checkPerformance(query) {
            const issues = [];
            
            // Missing time filter
            if (!query.match(/TimeGenerated.*ago\(/i)) {
                const firstLine = query.trim().split('\n')[0].trim();
                const tableName = firstLine.split(/\s+|\|/)[0];
                const timeSeriesTables = ['SecurityEvent', 'SigninLogs', 'DeviceEvents', 'Event'];
                
                if (timeSeriesTables.includes(tableName)) {
                    issues.push({
                        severity: 'major',
                        title: 'Missing Time Filter',
                        description: 'Queries on time-series data should include TimeGenerated filters for performance.',
                        fix: 'Add: | where TimeGenerated > ago(7d)'
                    });
                }
            }

            // Wildcard projection
            if (query.match(/\|\s*project\s+\*/i)) {
                issues.push({
                    severity: 'minor',
                    title: 'Wildcard Projection',
                    description: 'Using "project *" can impact performance and costs.',
                    fix: 'Specify only needed columns: | project Computer, Account, TimeGenerated'
                });
            }

            return issues;
        }

        function checkSyntax(query) {
            const issues = [];
            
            // SQL syntax
            if (query.match(/SELECT\s+.*FROM\s+/i)) {
                issues.push({
                    severity: 'major',
                    title: 'SQL Syntax Detected',
                    description: 'Query uses SQL syntax instead of KQL.',
                    fix: 'Use KQL syntax: start with table name, use "project" instead of "SELECT"'
                });
            }

            // Uppercase operators
            if (query.match(/\b(WHERE|PROJECT|SUMMARIZE|ORDER)\b/)) {
                issues.push({
                    severity: 'minor',
                    title: 'Uppercase Operators',
                    description: 'KQL operators should be lowercase.',
                    fix: 'Use: where, project, summarize, order (lowercase)'
                });
            }

            return issues;
        }

        function displayResults(analysis) {
            const results = document.getElementById('results');
            results.innerHTML = '';

            // Score display
            const scoreDiv = document.createElement('div');
            scoreDiv.className = 'score-display';
            
            const scoreClass = analysis.score >= 800 ? 'score-excellent' : 
                             analysis.score >= 600 ? 'score-good' : 
                             analysis.score >= 300 ? 'score-poor' : 'score-fail';
            
            const gradeClass = 'grade-' + analysis.grade.toLowerCase();
            const statusIcon = analysis.status === 'AUTO_FAIL' ? 'üö®' : 
                              analysis.score >= 800 ? 'üèÜ' : 
                              analysis.score >= 600 ? '‚úÖ' : 
                              analysis.score >= 300 ? '‚ö†Ô∏è' : '‚ùå';
            
            scoreDiv.innerHTML = `
                <div class="score-number ${scoreClass}">${analysis.score}/1000</div>
                <div class="grade-badge ${gradeClass}">${statusIcon} ${analysis.grade}</div>
                <div style="margin-top: 10px; color: #605e5c;">
                    ${Math.round((analysis.score / 1000) * 100)}% | Status: ${analysis.status}
                </div>
            `;
            
            results.appendChild(scoreDiv);

            // Issues
            if (analysis.issues.length > 0) {
                analysis.issues.forEach(issue => {
                    const issueDiv = document.createElement('div');
                    issueDiv.className = `issue issue-${issue.severity}`;
                    
                    issueDiv.innerHTML = `
                        <div class="issue-title">${issue.title}</div>
                        <div class="issue-desc">${issue.description}</div>
                        <div class="issue-fix"><strong>Fix:</strong> ${issue.fix}</div>
                    `;
                    
                    results.appendChild(issueDiv);
                });
            } else {
                const successDiv = document.createElement('div');
                successDiv.className = 'issue';
                successDiv.style.borderLeftColor = '#107c10';
                successDiv.innerHTML = `
                    <div class="issue-title">‚úÖ No Issues Found</div>
                    <div class="issue-desc">Your query follows KQL best practices!</div>
                `;
                results.appendChild(successDiv);
            }

            console.log('‚úÖ Results displayed successfully');
        }

        function showError(message) {
            const results = document.getElementById('results');
            results.innerHTML = `
                <div class="issue issue-critical">
                    <div class="issue-title">‚ùå Error</div>
                    <div class="issue-desc">${message}</div>
                </div>
            `;
        }

        // Chat functions
        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            const toggle = document.querySelector('.chat-toggle');
            
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
                toggle.style.display = 'block';
            } else {
                panel.style.display = 'flex';
                toggle.style.display = 'none';
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatBody = document.getElementById('chatBody');
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'message message-user';
            userMsg.textContent = message;
            chatBody.appendChild(userMsg);
            
            // Clear input
            input.value = '';
            
            // Add AI response
            setTimeout(() => {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'message message-ai';
                aiMsg.innerHTML = generateResponse(message);
                chatBody.appendChild(aiMsg);
                chatBody.scrollTop = chatBody.scrollHeight;
            }, 300);
            
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function generateResponse(message) {
            const currentQuery = document.getElementById('queryInput').value.trim();
            const lower = message.toLowerCase();
            
            if (lower.includes('fake') || lower.includes('table')) {
                return `<strong>üõ°Ô∏è Fake vs Valid Tables:</strong><br><br>
                <strong>‚ùå FAKE (Auto-Fail):</strong><br>
                ‚Ä¢ FakeTable, TestTable, DummyTable<br>
                ‚Ä¢ HasOffHoursActivity, WeekendConnections<br>
                ‚Ä¢ Field lists without proper structure<br><br>
                <strong>‚úÖ VALID Microsoft Tables:</strong><br>
                ‚Ä¢ SecurityEvent - Windows security logs<br>
                ‚Ä¢ SigninLogs - Azure AD authentication<br>
                ‚Ä¢ DeviceEvents - Endpoint security events<br>
                ‚Ä¢ AlertInfo - Security alerts<br><br>
                üí° Always start with a real table name!`;
            }
            
            if (lower.includes('optimize') || lower.includes('performance')) {
                return `<strong>üöÄ Performance Tips:</strong><br><br>
                ${currentQuery ? 'For your current query:' : 'General advice:'}<br><br>
                1. <strong>Add time filtering:</strong><br>
                   | where TimeGenerated > ago(7d)<br><br>
                2. <strong>Specify columns:</strong><br>
                   | project Computer, Account, TimeGenerated<br><br>
                3. <strong>Filter early:</strong><br>
                   Apply where clauses before computations<br><br>
                ${currentQuery && !currentQuery.includes('TimeGenerated') ? '‚ö†Ô∏è Your query needs time filtering!' : ''}`;
            }
            
            if (lower.includes('syntax') || lower.includes('help')) {
                return `<strong>üìù KQL Syntax Rules:</strong><br><br>
                <strong>Structure:</strong><br>
                TableName<br>
                | where condition<br>
                | project columns<br><br>
                <strong>Key Points:</strong><br>
                ‚Ä¢ Start with table name (not SELECT)<br>
                ‚Ä¢ Use lowercase operators<br>
                ‚Ä¢ Single | between operations<br>
                ‚Ä¢ No semicolons needed<br><br>
                <strong>Common Mistakes:</strong><br>
                ‚ùå WHERE ‚Üí ‚úÖ where<br>
                ‚ùå SELECT FROM ‚Üí ‚úÖ TableName | project`;
            }
            
            return `<strong>ü§ñ KQL Expert Here!</strong><br><br>
            I can help with:<br><br>
            ‚Ä¢ <strong>"fake tables"</strong> - Learn what's valid vs invalid<br>
            ‚Ä¢ <strong>"optimize query"</strong> - Performance tips<br>
            ‚Ä¢ <strong>"syntax help"</strong> - KQL rules and structure<br><br>
            Current query: ${currentQuery ? 'Ready to analyze!' : 'Paste one first!'}<br><br>
            üí° Ask me anything specific!`;
        }
    </script>
</body>
</html>
